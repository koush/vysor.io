function nextTick(e){setTimeout(e,0)}function make4Len16(e){var t=e.toString(16);while(t.length<4){t="0"+t}return t}function encode_utf8(e){return unescape(encodeURIComponent(e))}function decode_utf8(e){return decodeURIComponent(escape(e))}function ab2str(e){if(e.constructor.name=="ArrayBuffer"){e=new Uint8Array(e)}return decode_utf8(String.fromCharCode.apply(null,e))}function str2ab(e,t,n){e=encode_utf8(e);var o=e.length;if(n)o++;if(!t){t=new ArrayBuffer(o)}var r=new Uint8Array(t);if(n)r[e.length]=0;for(var i=0,s=e.length;i<s;i++){r[i]=e.charCodeAt(i)}return t}var slashN="\n".charCodeAt(0);function writeLine(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);writeString(e,t+"\n",n)}function readLine(e,t){var n=[];function o(){e.read(function(r){for(var i=0;i<r.byteLength;i++){if(r[i]==slashN){var s=r.subarray(0,i);n.push(s);var c="";for(var a in n){a=n[a];c+=ab2str(a)}var l=r.subarray(i+1);e.unshift(l);t(c);return}}n.push(r);o()})}o()}function readString(e,t){var n="";e.onClose=function(){t(n)};function o(t){n+=ab2str(t);e.read(o)}e.read(o)}function writeString(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);e.write(str2ab(t),n)}function appendBuffer(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);n.set(e,0);n.set(t,e.byteLength);return n}var timeThing=(new Date).getTime();function timeTrace(e){var t=(new Date).getTime();console.log(e+": "+(t-timeThing));timeThing=t}function bufferToHex(e){var t=new Uint8Array(e);var n="";for(var o in t){o=t[o];if(o<16)n+="0"+o.toString(16);else n+=o.toString(16)}return n}function hexToBuffer(e){var t=new ArrayBuffer(e.length/2);var n=new Uint8Array(t);for(var o=0;o<e.length/2;o++){var r=e.substr(o*2,2);n[o]=parseInt(r,16)}return t}function base64ToArrayBuffer(e){var t=window.atob(e);var n=t.length;var o=new Uint8Array(n);for(var r=0;r<n;r++){var i=t.charCodeAt(r);o[r]=i}return o.buffer}function arrayBufferToBase64(e){var t="";var n=new Uint8Array(e);var o=n.byteLength;for(var r=0;r<o;r++){t+=String.fromCharCode(n[r])}return window.btoa(t)}var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64pad="=";function hex2b64(e){var t;var n;var o="";for(t=0;t+3<=e.length;t+=3){n=parseInt(e.substring(t,t+3),16);o+=b64map.charAt(n>>6)+b64map.charAt(n&63)}if(t+1==e.length){n=parseInt(e.substring(t,t+1),16);o+=b64map.charAt(n<<2)}else if(t+2==e.length){n=parseInt(e.substring(t,t+2),16);o+=b64map.charAt(n>>2)+b64map.charAt((n&3)<<4)}while((o.length&3)>0){o+=b64pad}return o}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,"startsWith",{enumerable:false,configurable:false,writable:false,value:function(e,t){t=t||0;return this.lastIndexOf(e,t)===t}})}function getQueryVariable(e,t){if(!t)t=window.location;var n=t.search.substring(1);var o=n.split("&");for(var r=0;r<o.length;r++){var i=o[r].split("=");if(decodeURIComponent(i[0])==e){return decodeURIComponent(i[1])}}}Object.fromArray=function(e){var t={};for(var n in e){var o=e[n];t[o]=o}return t};$.ajaxTransport("+binary",function(e,t,n){if(window.FormData&&(e.dataType&&e.dataType=="binary"||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob))){return{send:function(t,n){var o=new XMLHttpRequest,r=e.url,i=e.type,s=e.async||true,c=e.responseType||"blob",a=e.data||null,l=e.username||null,u=e.password||null;o.addEventListener("load",function(){var t={};t[e.dataType]=o.response;n(o.status,o.statusText,t,o.getAllResponseHeaders())});o.open(i,r,s,l,u);for(var d in t){o.setRequestHeader(d,t[d])}o.responseType=c;o.send(a)},abort:function(){n.abort()}}}});function throttleTimeout(e,t,n,o){if(!e)e={items:[]};e.items.push(t);if(!e.timeout){e.timeout=setTimeout(function(){delete e.timeout;o(e.items);e.items=[]},n)}return e}function copyTextToClipboard(e){var t=document.createElement("textarea");t.style.position="fixed";t.style.top=0;t.style.left=0;t.style.width="2em";t.style.height="2em";t.style.padding=0;t.style.border="none";t.style.outline="none";t.style.boxShadow="none";t.style.background="transparent";t.value=e;document.body.appendChild(t);t.select();try{var n=document.execCommand("copy")}catch(o){console.log("Oops, unable to copy")}document.body.removeChild(t)}function showNotification(e,t){console.log("notification:",e);if(!window.chrome||!window.chrome.notifications)return;var n=chrome.runtime.getManifest();var o=n.name;t=t||n.icons[128];chrome.notifications.create({type:"basic",iconUrl:t,title:o,message:e})}var blobFromUrl=function(){var e={};return function(t,n){if(e[t]){n(e[t]);return}var o=new XMLHttpRequest;o.open("GET",t,true);o.responseType="blob";o.onload=function(o){n(e[t]=window.URL.createObjectURL(this.response))};o.send()}}();function Success(){}(function(){function*e(){}var t=e();t.constructor.prototype.async=function(){var e=this;var t=e.next();if(t.done)return;function n(){t=e.throw(new Error(arguments));r()}function o(){var n=arguments[0];t=e.next(n);r()}function r(r){var i;var s;if(t.done)return;if(!t.value){t=e.next(o);return}if(t.value.constructor==Promise){t.value.then(o).catch(n);return}if(t.value==Error){i=true;t=e.next(n)}else if(t.value==Success){s=true;t=e.next(o)}else{throw new Error("Unexpected yield value for callback. Only Error and Success allowed.")}if(!t.value)throw new Error("Double yield callbacks must explicitly define both Error and Success");if(t.value==Error&&i)throw new Error("Error callback already defined");else if(t.value==Success&&s)throw new Error("Success callback already defined");else if(t.value!=Error&&t.value!=Success)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");if(i)t=e.next(o);else t=e.next(n)}r()}})();function spewSocket(e){e.read(function(t){console.log(ab2str(t));spewSocket(e)})}function getAuthToken(e,t){chrome.identity.getAuthToken({interactive:e,scopes:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/chromewebstore.readonly"]},function(e){if(!e)console.error("unable to get authToken",chrome.runtime.lastError);t(e)})}(function(){var e=console.log;var t=console.error;var n="";function o(e){try{for(var t in e){if(e[t]&&e[t].constructor!=String)e[t]=JSON.stringify(e[t])}n+=e.join(" ")+"\n"}catch(o){}}console.error=function(){t.apply(console,arguments);o(Array.prototype.slice.call(arguments))};console.log=function(){e.apply(console,arguments);o(Array.prototype.slice.call(arguments))};window.getConsoleLog=function(){return n};function r(e){return e.getConsoleLog&&e.getConsoleLog()||"getConsoleLog not found"}window.gistConsoleLog=function(e){chrome.runtime.getBackgroundPage(function(t){var n={};n["background.txt"]={content:r(t)};var o=chrome.app.window.getAll();for(var i in o){i=o[i];n["window-"+i.id+".txt"]={content:r(i.contentWindow)}}var s={description:chrome.runtime.getManifest().name+" console log","public":false,files:n};fetch("https://api.github.com/gists",{method:"POST",body:JSON.stringify(s)}).then(function(t){t.json().then(function(t){e(t.html_url)})})})}})();(function(){function e(e){this.buffer=new ArrayBuffer(e);this.dataView=new DataView(this.buffer);this.uint8array=new Uint8Array(this.buffer);this.littleEndian=false;this.position=0;this.limit=e;this.capacity=e}e.prototype.flip=function(){this.limit=this.position;this.position=0};e.prototype.asUint8Array=function(){return this.uint8array.subarray(this.position,this.limit)};function t(t,n){var o=n*8;var r=t+o;var i="get"+r;var s="set"+r;var c="put"+r;e.prototype[i]=function(){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");var e=this.dataView[i](this.position,this.littleEndian);this.position+=n;return e};e.prototype[c]=function(e){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");if(e==null||e==undefined||e==NaN||e.constructor!=Number)throw new Error("no value provided");this.dataView[s](this.position,e,this.littleEndian);this.position+=n;return this}}var n={Int:[1,2,4],Uint:[1,2,4],Float:[4,8]};for(var o in n){var r=n[o];for(var i in r){var i=r[i];t(o,i)}}e.prototype.put=function(e){if(e.constructor==Number)return this.putInt8(e);if(e.constructor==String)e=str2ab(e);if(e.constructor==ArrayBuffer)e=new Uint8Array(e);if(this.position+e.byteLength>this.limit)throw new Error("Not enough room in byte buffer");this.uint8array.set(e,this.position);this.position+=e.byteLength;return this};e.prototype.putByte=e.prototype.putInt8;e.prototype.putShort=e.prototype.putInt16;e.prototype.putInt=e.prototype.putInt32;e.prototype.putFloat=e.prototype.putFloat32;e.prototype.putDouble=e.prototype.putFloat64;window.ByteBuffer=e})();if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.onReceive.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.dataReceived(new Uint8Array(e.data))});chrome.sockets.tcp.onReceiveError.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.destroy();t.dataReceived(null)});chrome.sockets.tcpServer.onAccept.addListener(function(e){chrome.sockets.tcp.setPaused(e.clientSocketId,false);var t=Server.listeners[e.socketId];if(t==null)return;t(new Socket({socketId:e.clientSocketId}))})}(function(){function e(t,n){if(t.socketId){this.socketId=t.socketId;e.readers[this.socketId]=this}else{chrome.sockets.tcp.create(function(o){this.socketId=o.socketId;chrome.sockets.tcp.connect(this.socketId,t.host,t.port,function(t){if(!t){e.readers[o.socketId]=this;n(this)}else{chrome.runtime.lastError;this.destroy();n(null)}}.bind(this))}.bind(this))}}e.readers={};e.connect=function(t,n){return new e(t,n)};e.pump=function(e,t,n){if(!e||!t){console.error("Socket.pump called with null socket",e,t);n();return}var o=function(){e.read(r)}.bind(e);var r=function(e){var n=e.buffer;if(e.byteOffset||e.length!=n.byteLength){n=n.slice(e.byteOffset,e.byteOffset+e.length)}t.write(n,o)}.bind(t);e.read(r);e.onClose=n};e.stream=function(t,n,o){e.pump(t,n,function(){if(n)n.destroy();if(o){var e=o;o=null;e()}});e.pump(n,t,function(){if(t)t.destroy();if(o){var e=o;o=null;e()}})};e.eat=function(e){function t(){e.read(t)}t()};e.prototype.read=function(){if(this.pendingCallback){throw new Error("double callback")}if(this.closed&&!this.pending){var e=this.onClose;if(e){delete this.onClose;e()}return}var t=0;if(arguments[t].constructor.name=="Number"){this.pendingLength=arguments[t++]}else{this.pendingLength=0}var e=arguments[t];if(!this.pending||this.paused){this.pendingCallback=e;return}if(!this.pendingLength){this.pendingLength=this.buffered()}else if(this.pendingLength>this.buffered()){this.pendingCallback=e;return}var n;var o=0;while(o<this.pendingLength){var r=this.pending.shift();this.bufferedLength-=r.length;if(!this.pending.length)delete this.pending;var i=r;var s=Math.min(i.byteLength,this.pendingLength-o);if(s!=i.byteLength){var c=i.subarray(0,s);var a=i.subarray(s);this.unshift(a);i=c}if(!n&&i.byteLength!=this.pendingLength)n=new Uint8Array(this.pendingLength);if(n){n.set(i,o)}else{n=i}o+=i.byteLength}e(n)};e.prototype.write=function(e,t){if(this.pendingWrite)console.error("write is already in progress!");if(t==null){console.error("write callback is null?");t=function(){}}this.pendingWrite=t;chrome.sockets.tcp.send(this.socketId,e,function(n){chrome.runtime.lastError;if(!n||n.resultCode){delete this.pendingWrite;return}if(n.bytesSent<e.byteLength){this.write(e.slice(n.bytesSent),t)}else{delete this.pendingWrite;t()}}.bind(this))};e.prototype.destroy=function(e,t){chrome.sockets.tcp.close(this.socketId,function(){chrome.runtime.lastError})};e.prototype.unshift=function(e){if(e.byteLength==0)return;if(!this.pending)this.pending=[e];else this.pending.unshift(e);if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length};e.prototype.dataReceived=function(e){if(e){if(e.asUint8Array)e=e.asUint8Array();if(e.constructor==ArrayBuffer)e=new Uint8Array(e)}if(e&&e.length){var t=new Uint8Array(e);if(!this.pending)this.pending=[t];else this.pending.push(t)}if(e==null){this.closed=true}else{if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length}if(this.paused||!this.pending||!this.pending.length){var n=this.onClose;if(this.closed&&n){delete this.onClose;n()}return}var o=this.pendingLength;var n=this.pendingCallback;if(n){delete this.pendingCallback;this.read(o,n)}};e.prototype.buffered=function(){return this.bufferedLength};e.prototype.pause=function(){if(this.paused){return}this.paused=true;this.onPause()};e.prototype.resume=function(){if(!this.paused){return}this.paused=false;this.onResume()};e.prototype.onResume=function(){chrome.sockets.tcp.setPaused(this.socketId,false,function(){})};e.prototype.onPause=function(){chrome.sockets.tcp.setPaused(this.socketId,true,function(){})};function t(){}t.listeners={};t.prototype.__proto__=e.prototype;t.prototype.destroy=function(){chrome.sockets.tcpServer.close(this.socketId,function(){chrome.runtime.lastError})};t.prototype.listen=function(e,n,o){var r;var i;if(e.constructor.name=="Number"){r=e;i="0.0.0.0"}else{i=e.address;r=e.port}chrome.sockets.tcpServer.create(function(e){this.socketId=e.socketId;t.listeners[this.socketId]=n;chrome.sockets.tcpServer.listen(e.socketId,i,r,function(e){chrome.runtime.lastError;if(e){this.destroy();if(o){o(e)}return}chrome.sockets.tcpServer.getInfo(this.socketId,function(t){this.localAddress=t.localAddress;this.localPort=t.localPort;if(o){o(e)}}.bind(this))}.bind(this))}.bind(this))};window.Socket=e;window.Server=t})();(function(){function e(){}e.prototype.listen=function(e,t,n){this.socket=new Server;this.requestCallback=t;this.socket.listen(e,this.onSocket.bind(this),n)};e.prototype.onSocket=function(e){new n(this,e,this.requestCallback)};e.prototype.destroy=function(){this.socket.destroy()};function t(e){this.request=e;this.statusLine="HTTP/1.1 200 OK";this.headers={Date:(new Date).toUTCString()}}t.prototype.code=function(e){this.statusLine="HTTP/1.1 "+e+" "+HttpResponseCodes[e]};t.prototype.write=function(e,t){if(e.constructor.name==Object.prototype.constructor.name){e=JSON.stringify(e)}if(e.constructor.name==String.prototype.constructor.name){e=str2ab(e)}if(!this.hasWritten){this.hasWritten=true;if(!this.headers["Content-Length"]&&this.headers["Connection"]!="close"){this.headers["Content-Length"]=e.byteLength}var n=[this.statusLine];for(var o in this.headers){n.push(o+": "+this.headers[o])}var r=n.join("\r\n")+"\r\n\r\n";this.request.socket.write(str2ab(r),function(){this.write(e,t)}.bind(this));return}this.request.socket.write(e,t)};t.prototype.end=function(){if(this.headers["Connection"]=="close")this.request.socket.destroy();else this.request.server.onSocket(this.request.socket);this.request.socket=null};function n(e,n,o){this.server=e;this.socket=n;this.headers={};this.parseRequest(function(){o(this,new t(this))}.bind(this))}n.prototype.parseRequest=function(e){var t=function(){readLine(this.socket,function(n){n=n.trim();if(!n.length){var o=this.headers["content-length"];if(o){o=Number.parseInt(o);this.socket.read(o,function(t){this.body=t;if(this.headers["content-type"]==="application/json"){this.body=JSON.parse(ab2str(this.body))}e()}.bind(this));return}e();return}if(!this.statusLine){this.statusLine=n;var r=n.split(" ");if(r.length>2){r=r[1].split("?");this.path=r[0];this.queries={};if(r.length>1){var i=this.query=r[1];var s=i.split("&");for(var c=0;c<s.length;c++){var a=s[c].split("=");var l=a[0];var u;if(a.length>1)u=a[1];this.queries[l]=u}}}}else{var r=n.split(":",2);if(r.length==2){this.headers[r[0].toLowerCase()]=r[1].trim()}}t()}.bind(this))}.bind(this);t()};window.HttpServer=e;window.HttpResponseCodes={200:"OK",202:"Accepted",206:"Partial Content",101:"Switching Protocols",301:"Moved Permanently",302:"Found",402:"Payment Required",404:"Not Found"}})();function DummySocket(e){if(e){this.dataReceived(e);this.dataReceived(null)}}DummySocket.prototype.write=function(e,t){throw new Error("write not supported on dummy socket")};DummySocket.prototype.destroy=function(){this.dataReceived(null)};DummySocket.prototype.buffered=Socket.prototype.buffered;DummySocket.prototype.unshift=Socket.prototype.unshift;DummySocket.prototype.dataReceived=Socket.prototype.dataReceived;DummySocket.prototype.read=Socket.prototype.read;DummySocket.prototype.pause=Socket.prototype.pause;DummySocket.prototype.resume=Socket.prototype.resume;DummySocket.prototype.buffered=Socket.prototype.buffered;DummySocket.prototype.onPause=function(){};DummySocket.prototype.onResume=function(){};function FetchSocket(e,t){this.promise=fetch(e).then(function(e){this.connected=true;this.response=e;this.reader=this.response.body.getReader();this.reader.closed.then(function(){if(this.onClose)this.dataReceived(null)}.bind(this));this.onResume();t(this)}.bind(this),function(e){t(null,e)})}FetchSocket.connect=function(e,t){new FetchSocket(e,t)};FetchSocket.prototype.write=function(e,t){throw new Error("write not supported on fetch socket")};FetchSocket.prototype.destroy=function(){if(this.promise&&this.promise.cancel)this.promise.cancel()};FetchSocket.prototype.unshift=Socket.prototype.unshift;FetchSocket.prototype.dataReceived=Socket.prototype.dataReceived;FetchSocket.prototype.read=Socket.prototype.read;FetchSocket.prototype.pause=Socket.prototype.pause;FetchSocket.prototype.resume=Socket.prototype.resume;FetchSocket.prototype.buffered=Socket.prototype.buffered;FetchSocket.prototype.onPause=function(){};FetchSocket.prototype.onResume=function(){this.reader.read().then(function(e){if(!e.value)return;this.dataReceived(e.value);if(this.paused){return}this.onResume()}.bind(this))};(function(){function e(e,t){this.conn=e;this.dc=t;this.gotEof=false;t.onmessage=function(e){var t=new Uint8Array(e.data);var n=t[t.byteLength-1]==1;this.dataReceived(t.subarray(0,t.byteLength-1));if(n){this.gotEof=true;this.destroy()}}.bind(this);t.onclose=t.onerror=this.destroy.bind(this);this.needsBufferShim=true||parseInt(/Chrome\/(\d\d)/.exec(navigator.userAgent)[1])<46}e.prototype.buffered=Socket.prototype.buffered;e.prototype.unshift=Socket.prototype.unshift;e.prototype.dataReceived=Socket.prototype.dataReceived;e.prototype.read=Socket.prototype.read;e.prototype.pause=Socket.prototype.pause;e.prototype.resume=Socket.prototype.resume;e.prototype.buffered=Socket.prototype.buffered;e.prototype.writeable=function(){var e=this.writeCallback;if(e){delete this.writeCallback;e()}};e.prototype.write=function(e,t){if(!this.dc||this.dc.readyState!="open"){this.destroy();return}this.writeCallback=t;var n=new Uint8Array(e.byteLength+1);n.set(new Uint8Array(e));this.dc.send(n.buffer);if(this.reentrantWrite)return;try{this.reentrantWrite=true;while(this.writeCallback&&(this.dc.bufferedAmount==0||this.needsBufferShim)){this.writeable()}}finally{this.reentrantWrite=false}};e.prototype.destroy=function(){this.dataReceived(null);if(this.dc==null)return;var e=this.dc;this.dc=null;e.onclose=null;e.onerror=null;if(e.readyState=="open"){try{e.send(new Uint8Array([1]));if(this.gotEof)this.conn.recycleChannel(e);else this.conn.waitForEof(e)}catch(t){}}};function t(e,t){this.pc=e;this.key=t;this.pc.oniceconnectionstatechange=function(){if(this.pc.iceConnectionState=="disconnected"||this.pc.iceConnectionState=="closed"){this.destroy();delete n.gcmRtcConnections[t]}}.bind(this)}t.prototype.waitForCommand=function(t){t.onmessage=function(n){if(n.data.byteLength==1)return;this.removeChannel(t);var o=ab2str(n.data);var r=new e(this,t);this.openSocket(o,r)}.bind(this)};t.prototype.compactChannels=function(){if(this.inboundChannels&&!this.inboundChannels.length)this.inboundChannels=null;if(this.outboundChannels&&!this.outboundChannels.length)this.outboundChannels=null};t.prototype.getAppropriateChannels=function(e,t){var n;if(e.inbound){if(!this.inboundChannels&&t)this.inboundChannels=[];n=this.inboundChannels}else{if(!this.outboundChannels&&t)this.outboundChannels=[];n=this.outboundChannels}return n};t.prototype.removeChannel=function(e){t;channels=this.getAppropriateChannels(e);if(!channels)return;var t=channels.indexOf(e);if(t==-1)return;channels.splice(t,1);this.compactChannels()};t.prototype.waitForEof=function(e){e.onmessage=function(t){var n=new Uint8Array(t.data);var o=n[n.byteLength-1]==1;if(o)this.recycleChannel(e)}.bind(this)};t.prototype.recycleChannel=function(e){var t=this.getAppropriateChannels(e,true);t.push(e);e.onclose=e.onerror=function(){this.removeChannel(e)}.bind(this);this.waitForCommand(e)};t.prototype.addCandidates=function(e){for(var t in e.candidates){this.pc.addIceCandidate(new RTCIceCandidate(e.candidates[t]))}};t.prototype.setupPinger=function(e){var t;function n(){e.send(str2ab("ping"));t=setTimeout(n,1e3)}e.onmessage=function(e){};e.onclose=e.onerror=function(){clearTimeout(t);this.destroy()}.bind(this);n()};t.prototype.listenSockets=function(){this.pc.ondatachannel=function(e){e.channel.inbound=true;this.waitForCommand(e.channel)}.bind(this)};t.prototype.prepareChannel=function(e){var t=this.pc.createDataChannel(e||"gcm",{reliable:true,ordered:true});t.binaryType="arraybuffer";return t};t.prototype.newSocket=function(t,n){if(this.pc.signalingState=="closed"){n();return}if(this.outboundChannels){var o=this.outboundChannels.shift();this.compactChannels();o.send(str2ab(t));var r=new e(this,o);n(r,this);return}var o=this.prepareChannel("gcm");o.onopen=function(){o.send(str2ab(t));var r=new e(this,o);n(r,this)}.bind(this)};t.prototype.destroy=function(){if(this.pc.signalingState!="closed"){this.pc.close()}var e=this.onClose;if(e){delete this.onClose;e()}};function n(e,t,n){this.senders=e;this.registrationId=t;this.rtcc=n}n.gcmRtcConnections={};n.onMessage=function(e){var t=JSON.parse(e.message);var o=e.type;var r=e.senderId;var i=e.src;var s=e.srcPort;var c=e.dstPort;if(o=="offer"){var a=n.gcmRtcListeners[c];if(!a)console.log("not listening on "+c);else a.listener.incoming(r,i,s,c,t,a.listenCallback);return}else if(o=="answer"){var l=n.getKey(i,s,c);var u=n.gcmRtcConnections[l];if(!u){console.log("pending connection not found");return}u.manager.incoming(r,i,s,c,t);return}else if(n.onUnknownMessage){n.onUnknownMessage(e)}else{console.log("unknown message "+o)}};n.hasLoadedChannels=false;n.start=function(e,t,o){if(window.chrome&&window.chrome.gcm){var r=Object.keys(e);chrome.gcm.register(r,function(r){chrome.runtime.lastError;if(!r){o();return}var i=new n(e,r,t);o(i)})}else{function i(){$.ajax({type:"GET",url:"https://vysor-1026.appspot.com/listen",success:function(r){var i=new goog.appengine.Channel(r.token);var s={onopen:function(){var i=new n(e,"web:"+r.channel,t);o(i)},onmessage:function(e){n.onMessage(JSON.parse(e.data))},onerror:function(){console.log("error",arguments)},onclose:function(){console.log("onclose",arguments)}};var c=i.open(s)}})}if(n.hasLoadedChannels){i()}else{$.getScript("https://vysor-1026.appspot.com/_ah/channel/jsapi",i)}}if(window.chrome&&window.chrome.gcm){chrome.gcm.onMessage.addListener(function(e){n.onMessage(e.data)})}};n.prototype.sendGcm=function(e,t,n,o,r,i){if(!e)e=this.defaultSenderId;if(t.startsWith("web:")){$.ajax({type:"POST",url:"https://vysor-1026.appspot.com/send",data:JSON.stringify({channel:t.substring(4),data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:r,message:JSON.stringify(i)}}),contentType:"application/json",dataType:"json",success:function(){}})}else{$.ajax({type:"POST",url:"https://gcm-http.googleapis.com/gcm/send",headers:{Authorization:"key="+this.senders[e]},data:JSON.stringify({to:t,data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:r,message:JSON.stringify(i)}}),contentType:"application/json",dataType:"json",error:function(){console.log("gcm error",arguments)},success:function(){console.log("gcm",arguments)}})}};n.getKey=function(e,t,n){return n+":"+t+":"+e};n.prototype.setupPeerConnection=function(e,o,r,i,s,c){var a=window.RTCPeerConnection||window.webkitRTCPeerConnection;var l=new a(this.rtcc);var u;var d=function(t){var n=[];for(var a in t){a=t[a];n.push(a);if(JSON.stringify(n).length>3200){this.sendGcm(o,r,i,s,e,{desc:c(),candidates:n});n=[]}}if(n.length>0){this.sendGcm(o,r,i,s,e,{desc:c(),candidates:n})}}.bind(this);l.onicecandidate=function(e){if(e.candidate==null)return;console.log(e.candidate);u=throttleTimeout(u,e.candidate,500,d)}.bind(this);var f=n.getKey(r,i,s);var h=new t(l,f);h.manager=this;l.onsignalingstatechange=function(e){if(l.signalingState=="stable"){if(n.gcmRtcConnections[f]==h){}}else if(l.signalingState=="closed"){h.destroy()}};n.gcmRtcConnections[f]=h;return h};n.gcmPortCount=0;n.prototype.connect=function(e,t){var o=e.senderId;var r=e.registrationId;var i=e.port;var s=n.gcmPortCount++;var c;var a=this.setupPeerConnection("offer",o,r,i,s,function(){return c});var l=a.pc;function u(e){l.createOffer(e).then(function(e){c=e;l.setLocalDescription(e)})}if(!e.audio){var d=a.prepareChannel("pinger");d.onopen=function(){console.log("got rtc pinger");a.setupPinger(d);t(a)};a.listenSockets();u({})}else{navigator.webkitGetUserMedia({audio:true,video:false},function(e){l.addStream(e);l.onaddstream=function(e){console.log("got the remote stream");t(a,e)};u({offerToReceiveAudio:true,offerToReceiveVideo:false,voiceActivityDetection:false})},function(){console.error("audio fail",arguments);u({offerToReceiveAudio:true,offerToReceiveVideo:false,voiceActivityDetection:false})})}};n.gcmRtcListeners={};n.prototype.isListening=function(e){return n.gcmRtcListeners[e]!=null};n.prototype.stopListen=function(e){delete n.gcmRtcListeners[e]};n.prototype.listen=function(e,t){if(n.gcmRtcListeners[e]){console.log("already listening on gcm port "+e);return}n.gcmRtcListeners[e]={listener:this,listenCallback:t}};n.prototype.incoming=function(e,t,o,r,i,s){var c=n.getKey(t,o,r);var a=n.gcmRtcConnections[c];if(!a){var l;a=this.setupPeerConnection("answer",e,t,o,r,function(){return l});a.remoteDesc=new RTCSessionDescription(i.desc);var u=a.pc;u.ondatachannel=function(e){console.log("got rtc pinger");this.setupPinger(e.channel);s(a);this.listenSockets()}.bind(a);u.setRemoteDescription(a.remoteDesc,function(){u.createAnswer().then(function(e){l=e;u.setLocalDescription(e)},function(){console.error("answer error",arguments)})})}else if(!a.remoteDesc){a.remoteDesc=new RTCSessionDescription(i.desc);var u=a.pc;u.setRemoteDescription(a.remoteDesc)}else{}a.addCandidates(i)};window.GcmRtcSocket=e;window.GcmRtcManager=n})();(function(){function e(e,t){this.handle=e;this.iface=t;this.type="usb";for(var n in t.endpoints){n=t.endpoints[n];if(n.type=="bulk"){this.zero_mask=n.maximumPacketSize-1;if(n.direction=="in"){this.in=n}else{this.out=n}}}}e.prototype.destroy=function(){chrome.usb.releaseInterface(this.handle,this.iface.interfaceNumber,function(){chrome.runtime.lastError;chrome.usb.closeDevice(this.handle,function(){chrome.runtime.lastError})}.bind(this))};e.prototype.write=function(e,t){if(this.writing){if(!this.pendingWrites)this.pendingWrites=[];this.pendingWrites.push({data:e,callback:t});return}var n={direction:"out",endpoint:this.out.address,data:e};this.writing=true;chrome.usb.bulkTransfer(this.handle,n,function(e){chrome.runtime.lastError;this.writing=false;t(e);if(!this.pendingWrites)return;var n=this.pendingWrites.shift();if(!this.pendingWrites.length)this.pendingWrites=null;this.write(n.data,n.callback)}.bind(this))};e.prototype.read=function(e,t){var n={direction:"in",endpoint:this.in.address,length:e};chrome.usb.bulkTransfer(this.handle,n,function(e){chrome.runtime.lastError;t(e)})};function t(e){this.socket=e;this.zero_mask=(1<<30)-1;this.type="tcp";e.onClose=function(){var e=this.currentRead;if(e){delete this.currentRead;e({resultCode:-1})}}.bind(this)}t.prototype.destroy=function(){this.socket.destroy()};t.prototype.write=function(e,t){if(this.writing){if(!this.pendingWrites)this.pendingWrites=[];this.pendingWrites.push({data:e,callback:t});return}this.writing=true;this.socket.write(e,function(){this.writing=false;t({resultCode:0});if(!this.pendingWrites)return;var e=this.pendingWrites.shift();if(!this.pendingWrites.length)this.pendingWrites=null;this.write(e.data,e.callback)}.bind(this))};t.prototype.read=function(e,t){this.currentRead=t;this.socket.read(e,function(e){delete this.currentRead;t({resultCode:0,data:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)})})};function n(e,t){this.onConnected=t;this.transport=e;this.currentSocketId=0;this.sockets={};this.forwards={};this.maxPayload=n.MAX_PAYLOAD}n.prototype.fatal=function(e){console.log("fatal error",JSON.stringify(e));var t=this.onConnected;if(t){delete this.onConnected;t()}else if(this.onError){this.onError();delete this.onError}this.destroy()};n.prototype.destroy=function(){for(var e in this.sockets){e=this.sockets[e];e.dataReceived(null)}if(this.forwards){$.each(this.forwards,function(e,t){t.destroy()})}this.transport.destroy()};n.kCommandSYNC=1129208147,n.kCommandCNXN=1314410051,n.kCommandOPEN=1313165391,n.kCommandOKAY=1497451343,n.kCommandCLSE=1163086915,n.kCommandWRTE=1163154007,n.kCommandAUTH=1213486401;n.kAuthToken=1;n.kAuthSignature=2;n.kAuthRSAPublicKey=3;n.ADB_PROTOCOL_VERSION=16777216;n.ADB_VERSION=36;n.MAX_PAYLOAD=4096;n.checksum=function(e){e=new Uint8Array(e);var t=0;for(var n=0;n<e.byteLength;n++){t+=e[n]}return t&4294967295};n.prototype.sendMessage=function(e,t,o,r,i){if(!r){r=""}if(r.constructor.name=="String"){r=str2ab(r)}var s=true;if(!r.byteLength){s=false}if(e==n.kCommandAUTH&&t==n.kAuthSignature){s=false}if(e==n.kCommandWRTE){s=false}var c=r.byteLength;if(s){c++}if(s){var a=new ArrayBuffer(r.byteLength+1);var l=new Uint8Array(a);l.set(new Uint8Array(r));l[a.byteLength-1]=0;r=a}var u=new ArrayBuffer(24);var l=new DataView(u);l.setUint32(0,e,true);l.setUint32(4,t,true);l.setUint32(8,o,true);l.setUint32(12,c,true);l.setUint32(16,n.checksum(r),true);l.setUint32(20,e^4294967295,true);this.transport.write(u,function(e){if(e.resultCode){this.fatal(e)}if(!r.byteLength&&i){i()}}.bind(this));if(r.byteLength){this.transport.write(r,function(e){if(e.resultCode){this.fatal(e)}if(i){i()}}.bind(this))}};n.prototype.getKey=function(e){chrome.storage.local.get("adbkey",function(t){var n=t.adbkey;var o=new JSEncrypt({default_key_size:2048});if(!n){n=o.getPrivateKeyB64();o.setPrivateKey(n);chrome.storage.local.set({adbkey:n})}else{o.setPrivateKey(n)}e(o)})};n.prototype._convertToMinCrypt=function(e){var t=2048;var n=t/8/4;var o=BigInteger.ONE.shiftLeft(32);var r=e.n.clone();var i=BigInteger.ONE.shiftLeft(1).pow(t);var s=i.multiply(i).mod(r);var c=new Uint32Array(3+n*2);c[0]=n;c[1]=o.subtract(r.modInverse(o)).intValue();var a=n+2;for(var l=2,u=2+n;l<a;++l,++u){c[l]=r.mod(o).intValue();r=r.divide(o);c[u]=s.mod(o).intValue();s=s.divide(o)}c[c.length-1]=e.e;var d="";var f=new Uint8Array(c.buffer);for(var l=0;l<f.length;++l){var h=f[l].toString(16);if(h.length==1){d+="0"}d+=h}return hex2b64(d)+" adb@chrome"};n.prototype.sign=function(e,t){if(e==null){throw"AuthManager is not initialized"}var n=2048/8;var o=new Uint8Array(n);o[0]=0;o[1]=1;var r=[0,48,33,48,9,6,5,43,14,3,2,26,5,0,4,20];var i=n-r.length-t.byteLength;for(var s=2;s<i;s++){o[s]=255}o.set(new Uint8Array(r),i);i+=r.length;o.set(new Uint8Array(t),i);var c=new BigInteger(Array.apply([],o));return new Uint8Array(e.doPrivate(c).toByteArray()).buffer};function o(e){var t={};if(e.constructor.name!="String")e=ab2str(e);var n=e.replace("device::","").split(";");for(var o in n){o=n[o];var r=o.split("=");if(r.length==2){t[r[0]]=r[1]}}return t}n.parseConnectionPayload=o;n.prototype.handleUnknown=function(e,t){console.log("no idea what this socket is.");this.sendMessage(n.kCommandCLSE,e,t)};n.prototype.handleMessage=function(e,t){var r=e.getUint32(0,true);var i=e.getUint32(4,true);var s=e.getUint32(8,true);var c=e.getUint32(12,true);var a=e.getUint32(16,true);switch(r){case n.kCommandOPEN:if(this.onOpenSocket)this.onOpenSocket(t,i);break;case n.kCommandAUTH:console.log("auth:",this);this.getKey(function(e){if(this.sentSignature){var o=this._convertToMinCrypt(e.getKey());this.sendMessage(n.kCommandAUTH,n.kAuthRSAPublicKey,0,o);showNotification('Check your Android device and click "Allow USB Debugging".');
}else{this.sentSignature=true;var r=this.sign(e.getKey(),t);this.sendMessage(n.kCommandAUTH,n.kAuthSignature,0,r,function(){})}}.bind(this));break;case n.kCommandOKAY:var l=i;var u=s;var d=this.sockets[u];if(!d){this.handleUnknown(u,l);return}var f=d.onConnected;if(f){delete d.onConnected;d.remoteId=l;f(d)}var h=d.pendingWrite;if(h){f=d.wrote;delete d.wrote;delete d.pendingWrite;d.write(h,f);return}f=d.wrote;if(f){delete d.wrote;f()}break;case n.kCommandCNXN:this.rawProperties=ab2str(t);this.properties=o(t);var f=this.onConnected;if(f){delete this.onConnected;f(this)}break;case n.kCommandWRTE:var l=i;var u=s;var d=this.sockets[u];if(!d){this.handleUnknown(u,l);return}if(!d.paused){this.sendMessage(n.kCommandOKAY,d.localId,d.remoteId)}d.dataReceived(new Uint8Array(t));break;case n.kCommandCLSE:var l=i;var u=s;var d=this.sockets[u];if(!d){console.log("asked to close unknown socket?");return}delete this.sockets[u];d.destroy();var f=d.onConnected;if(f){delete d.onConnected;f()}break;default:console.log("unknown command: ",r.toString(16),i,s,t);break}};n.prototype.onReceiveMessage=function(e){if(e.resultCode){this.fatal(e);return}var t=new DataView(e.data);var o=t.getUint32(12,true);if(!o){try{this.handleMessage(t,null)}finally{this.receiveMessages()}return}this.transport.read(o,function(e){if(e.resultCode){this.fatal(e);return}var o=e.data;if(n.checksum(o)!=t.getUint32(16,true)){this.receiveMessages();return}try{this.handleMessage(t,o)}finally{this.receiveMessages()}}.bind(this))};n.prototype.receiveMessages=function(){this.transport.read(24,this.onReceiveMessage.bind(this))};n.prototype.forwardPort=function(e){var t=new Server;t.listen({port:e.fromPort,address:"127.0.0.1"},function(t){this.newSocket(e.to,function(e){if(e)Socket.stream(t,e);else t.destroy()}.bind(this))}.bind(this),function(){this.forwards[e.fromPort]=t}.bind(this))};n.prototype.newAdbSocket=function(e,t){var n;if(this.createSocket)n=this.createSocket(e,t);else n=new r(this,e,t);return n};n.prototype.newSocket=function(e,t){var o=++this.currentSocketId;this.sockets[o]=this.newAdbSocket(o,t);this.sendMessage(n.kCommandOPEN,o,0,e)};function r(e,t,n){if(!n){n=function(){}}this.device=e;this.localId=t;this.onConnected=n}r.prototype.write=function(e,t){if(this.pendingWrite||this.wrote){console.log("bad adb socket state, already writing");throw new Error("bad adb socket state, already writing")}var o=Math.min(this.device.transport.zero_mask,this.device.maxPayload);if(o<e.byteLength){this.pendingWrite=e.slice(o);e=e.slice(0,o)}else{this.pendingWrite=null}this.wrote=t;this.device.sendMessage(n.kCommandWRTE,this.localId,this.remoteId,e)};r.prototype.destroy=function(){this.device.sendMessage(n.kCommandCLSE,this.localId,this.remoteId);this.dataReceived(null)};r.prototype.buffered=Socket.prototype.buffered;r.prototype.dataReceived=Socket.prototype.dataReceived;r.prototype.read=Socket.prototype.read;r.prototype.pause=Socket.prototype.pause;r.prototype.resume=Socket.prototype.resume;r.prototype.unshift=Socket.prototype.unshift;r.prototype.onPause=function(){};r.prototype.onResume=function(){this.device.sendMessage(n.kCommandOKAY,this.localId,this.remoteId)};function i(t,o,r){console.log("connecting");var i=new n(new e(t,o),r);console.log("sending CNXN");i.sendMessage(n.kCommandCNXN,n.ADB_PROTOCOL_VERSION,n.MAX_PAYLOAD,"host::");console.log("starting receive loop");i.receiveMessages()}function s(e){var e=e||{};var t=e.port||5037;var n=e.start!==false;this.currentSocketId=0;this.pendingDevices={};this.port=t;this.adbDevices={};this.clients={};if(n){this.start()}}function c(){return(new Date).getTime()}s.prototype.start=function(){if(this.server){console.log("ADB Server started while already started");return}this.clients={};this.adbDevices={};this.pendingDevices={};this.refreshing={};var e=new Server;e.listen({port:this.port,address:"127.0.0.1"},function(e){var t=new a(this,e);var n=++this.currentSocketId;this.clients[n]=t;e.onClose=function(){delete this.clients[n]}.bind(this);t.receiveHeader()}.bind(this),function(t){if(t){console.log("adb server failed to listen: "+t);return}console.log("ADB Server started");this.server=e;this.refresh()}.bind(this))};s.prototype.isRunning=function(){return this.server!=null};s.prototype.kill=function(){this.server.destroy();this.server=null;this.refreshing={};for(var e in this.clients){e=this.clients[e];e.socket.destroy()}this.clients={};for(var t in this.adbDevices){t=this.adbDevices[t];t.destroy()}this.adbDevices={};this.pendingDevices={}};s.prototype.selectDevice=function(e){chrome.usb.getUserSelectedDevices({filters:[{interfaceClass:255,interfaceSubclass:66,interfaceProtocol:1}]},function(t){for(var n in t){n=t[n];this.refreshDevice(n,e)}}.bind(this))};s.prototype.withAdbDevice=function(e,t){e.onError=function(){delete this.adbDevices[e.serialno];this.internalOnDevicesChanged()}.bind(this);var n=function(n){e.serialno=n.trim();this.adbDevices[e.serialno]=e;console.log("found device: "+e.serialno);this.internalOnDevicesChanged();t(e)}.bind(this);if(e.serialno){n(e.serialno);return}e.newSocket("shell:getprop ro.serialno",function(e){readString(e,function(e){n(e)}.bind(this))}.bind(this))};s.prototype.tryDevice=function(e,t,n){var o=this.adbDevices;var r=this.pendingDevices;var s=this;function c(o){var c=o.interfaceNumber;if(r[c]){return false}r[c]=e;console.log("claiming:",JSON.stringify(e),JSON.stringify(o));chrome.usb.claimInterface(e,o.interfaceNumber,function(){console.log("claimed:",JSON.stringify(chrome.runtime.lastError));i(e,o,function(e){if(!e){delete r[c];n();return}e.serialno=t;s.withAdbDevice(e,function(e){delete r[c];n(e)})})});return true}chrome.usb.listInterfaces(e,function(t){if(!t){console.log("unable list interfaces",JSON.stringify(chrome.runtime.lastError));if(n)n();return}console.log("got interfaces",JSON.stringify(t));var o=false;for(var r in t){r=t[r];if(r.interfaceClass==255&&r.interfaceSubclass==66&&r.interfaceProtocol==1){o|=c(r)}}if(!o){chrome.usb.closeDevice(e)}})};s.prototype.refreshDevice=function(e,t){chrome.usb.openDevice(e,function(n){if(!n){console.log("unable to open device",JSON.stringify(chrome.runtime.lastError));if(t)t();return}this.start();this.tryDevice(n,e.serialNumber,function(n){if(n){n.usbDevice=e}t(n)})}.bind(this))};s.prototype.refresh=function(){if(!this.server){console.log("adb server refresh requested while server killed");return}var e=c();if(this.server.lastRefresh&&this.server.lastRefresh>e-1e4){return}this.server.lastRefresh=e;var t=chrome.runtime.getManifest().permissions.pop().usbDevices;$(t).each(function(e,t){var n=t.vendorId+"&"+t.productId;if(this.refreshing[n]){return}this.refreshing[n]=true;chrome.usb.findDevices({productId:t.productId,vendorId:t.vendorId},function(e){var o=e.length;if(!o){delete this.refreshing[n];return}console.log("found:",t,e);for(var r in e){console.log("trying:",e[r]);this.tryDevice(e[r],e[r].serialNumber,function(){o--;if(!o){delete this.refreshing[n]}}.bind(this))}}.bind(this))}.bind(this))};s.prototype.internalOnDevicesChanged=function(){for(var e in this.clients){e=this.clients[e];if(!e.tracking)continue;var t=e.getDevicesString();if(!t.length)t="0000\n";e.socket.write(str2ab(t),function(){})}};s.prototype.stop=function(){this.server.destroy()};function a(e,t){this.server=e;this.socket=t}a.prototype.resolveTransport=function(e,t){if(t){var n=this.server.adbDevices[t];if(!n)return"device not found";return n}var o=Object.keys(this.server.adbDevices);if(o>1){return"more than one device"}if(o==0){return"no devices connected"}for(var r in this.server.adbDevices){return this.server.adbDevices[r]}};a.prototype.write=function(e,t,n){if(!t){t="OKAY"}e=str2ab(e);var o=e.byteLength;var r=make4Len16(o);r=str2ab(t+r);var i=appendBuffer(new Uint8Array(r),new Uint8Array(e)).buffer;if(!n){n=function(){this.socket.destroy()}.bind(this)}this.socket.write(i,n)};a.prototype.getDevicesString=function(e){var e=e||{};var t=e.longformDevices;var n="";for(var o in this.server.adbDevices){o=this.server.adbDevices[o];n+=o.serialno+"\tdevice";if(t){if(o.transport.type=="usb")n+=" usb:"+o.transport.iface.interfaceNumber;else n+=" tpcip:"+"something";n+=" product:"+o.properties["ro.product.name"];n+=" model:"+o.properties["ro.product.model"];n+=" device:"+o.properties["ro.product.device"]}n+="\n"}return n};a.prototype.writeDevices=function(e,t){this.write(this.getDevicesString(e),null,t)};a.prototype.handlePayload=function(e){e=ab2str(e);var o=e.split(":");var r=e;var i;if(o[0]=="host-serial"){o[0]="host";i=o.splice(1,1)[0];if(Number.isInteger(parseInt(o[1]))){i+=":"+o.splice(1,1)[0]}}if(o.length>=2)r=o[0]+":"+o[1];switch(r){case"host:version":this.write(make4Len16(n.ADB_VERSION));break;case"host:devices-l":case"host:devices":var s=e=="host:devices-l";this.server.refresh();this.writeDevices({longformDevices:s});break;case"host:features":var a=this.resolveTransport(e,i);if(a.constructor.name=="String"){this.write(a,"FAIL");break}var l=a.properties.features;if(!l)l="";this.write(make4Len16(l));break;case"host:transport-usb":case"host:transport-any":var a=this.resolveTransport(e,i);if(a.constructor.name=="String"){this.write(a,"FAIL");break}this.transport=a;this.socket.write(str2ab("OKAY"),function(){});break;case"host:kill":this.server.kill();break;case"host:connect":if(o.length<3){this.write("need more arguments for connect <host>[:<port>]","FAIL");break}var u=o[2];var d=5555;if(o.length>3)d=Number.parseInt(o[3]);Socket.connect({host:u,port:d},function(e,o){if(!e){console.error("connect failed");this.write("unable to connect to "+u+" "+d+": "+o,"FAIL");return this}var r=new n(new t(e),function(e){this.server.withAdbDevice(e,function(){var e="connected to "+u+":"+d;console.log(e);this.write(e)}.bind(this))}.bind(this));r.serialno=u+":"+d;e.onClose=function(){r.fatal("socket closed")}.bind(this);r.sendMessage(n.kCommandCNXN,n.ADB_PROTOCOL_VERSION,n.MAX_PAYLOAD,"host::");r.receiveMessages()}.bind(this));break;case"host:track-devices":this.tracking=c();this.writeDevices({},function(){});break;case"host:forward":var f=o.join(":").substring(r.length+1).split(";");var h=f[0].split(":");var p=parseInt(h[1]);var a=this.resolveTransport(e,i);if(a.constructor.name=="String"){this.write(a,"FAIL");break}a.forwardPort({fromPort:p,to:f[1]});this.socket.write(str2ab("OKAYOKAY"),function(){}.bind(this));break;default:if(this.transport){var a=this.transport;a.newSocket(e,function(e){if(!e){this.socket.write(str2ab("OKAY"),function(){this.socket.destroy()}.bind(this));return}this.socket.write(str2ab("OKAY"),function(){});Socket.stream(e,this.socket)}.bind(this));return}var v="host:transport:";if(e.startsWith(v)){var i=e.substr(v.length);var g=this.server.adbDevices[i];if(!g){this.write("device not found","FAIL");return}this.transport=g;this.socket.write(str2ab("OKAY"),function(){});break}console.log("unknown request: "+e);this.write("unknown command: "+e,"FAIL");var m=chrome.runtime.getManifest().name;chrome.notifications.create({type:"basic",iconUrl:"/icon.png",title:m,message:m+"'s adb server encountered an unknown adb command.\nYou may want to close "+m+" and start your adb binary manually."});break}this.receiveHeader()};a.prototype.receivePayload=function(e){var t=parseInt(ab2str(e),16);this.socket.read(t,this.handlePayload.bind(this))};a.prototype.receiveHeader=function(){this.socket.read(4,this.receivePayload.bind(this))};window.AdbDevice=n;window.AdbServer=s;window.AdbTcpTransport=t})();(function(){var e={};e.sendHostCommand=function(e,t){Socket.connect({host:"127.0.0.1",port:5037},function(n){if(!n){t();return}var o=e;e=make4Len16(e.length)+e;n.read(4,function(e){var r=ab2str(e);if(r!="OKAY"){console.error("error in response to adb host command",o,r);n.destroy();t();return}n.read(4,function(e){var o=ab2str(e);e=parseInt(o,16);if(e==0||o=="OKAY"){t(n,new ArrayBuffer(0));return}n.read(e,function(e){t(n,e)})})});n.write(str2ab(e),function(){})})};e.devices=function(t){var n={};function o(e){var t=e;e=e.replace("\t"," ");var o=e.indexOf(" ");if(o==-1)return;var r=e.substring(0,o);e=e.substring(o).trim();var i;while(i!=e){i=e;e=e.replace("  "," ")}var s={};var c=e.indexOf(" ");if(c==-1)c=e.length;var a=e.substring(0,c);e=e.substring(c+1);while(e.length){o=e.indexOf(":");if(o==-1)break;var l=e.substring(0,o);var u=e.substring(o+1);var d=u.indexOf(" ");var f=u.indexOf(":");var h;if(d==-1||f==-1){h=u;e=""}else{while(d!=-1&&d<f){h=u.substring(0,d);e=u.substring(d+1);d=u.indexOf(" ",d+1)}}s[l]=h}var p;if(!s["model"])p=r;else p=s["model"].replace("_"," ");n[r]={serialno:r,name:p,status:a,properties:t}}e.sendHostCommand("host:devices-l",function(e,r){if(!e){t();return}e.destroy();r=ab2str(r);console.log("ADB devices:",r);r=r.trim();var i=r.split("\n");for(var s in i){s=i[s];o(s)}t(n)})};e.killServer=function(t){e.sendHostCommand("host:kill-server",function(e,n){if(!e){t();return}e.destroy();n=ab2str(n);if(t)t()})};e.sendClientCommand=function(e,t){var n=e.command;var o=e.serialno;Socket.connect({host:"127.0.0.1",port:5037},function(e){if(!e){t();return}e.read(4,function(o){var r=ab2str(o);if(r!="OKAY"){e.destroy();t(null);return}var i=n;i=make4Len16(i.length)+i;e.read(4,function(n){var o=ab2str(n);if(o!="OKAY"){e.destroy();t(null);return}t(e)});e.write(str2ab(i),function(){})});var r="host:transport:"+o;r=make4Len16(r.length)+r;e.write(str2ab(r),function(){})})};e.shell=function(t,n){var o=t.command;var r=t.serialno;e.getOrCreateSockFactory(t).newSocket("shell:"+o,function(e){if(!e){n();return}readString(e,function(e){n(e)})})};e.forward=function(t,n){var o="host-serial:"+t.serialno+":forward:"+t.from+";"+t.to;e.sendHostCommand(o,function(e,t){if(e)e.destroy();n(e,t)})};function t(){}t.MKID=function(e,t,n,o){return e.charCodeAt(0)|t.charCodeAt(0)<<8|n.charCodeAt(0)<<16|o.charCodeAt(0)<<24};t.ID_RECV=t.MKID("R","E","C","V");t.ID_SEND=t.MKID("S","E","N","D");t.ID_DONE=t.MKID("D","O","N","E");t.ID_DATA=t.MKID("D","A","T","A");t.DATA_MAX=64*1024;e.pull=function(n,o){var r=n.file;var i=n.serialno;var s=n.fileEntry;e.getOrCreateSockFactory(n).newSocket("sync:",function(e){if(!e){o();return}s.createWriter(function(n){var i=new ArrayBuffer(8);var c=new DataView(i);c.setUint32(0,t.ID_RECV,true);c.setUint32(4,r.length,true);e.write(i,function(){e.write(str2ab(r),function(){function r(t){e.read(t,function(e){n.write(new Blob([e]))})}n.onwriteend=function(e){i()};function i(){e.read(8,function(n){var i=new DataView(n.buffer,n.byteOffset,n.byteLength);var c=i.getUint32(0,true);if(c==t.ID_DATA){var a=i.getUint32(4,true);r(a);return}e.destroy();if(c==t.ID_DONE){o(s);return}o()})}i()})})})})};e.createSocketFactory=function(t){return{newSocket:function(n,o){e.sendClientCommand({serialno:t,command:n},o)}}};e.getOrCreateSockFactory=function(t){return t.socketFactory||e.createSocketFactory(t.serialno)};e.push=function(n,o){var r=n.file;var i=n.serialno;var s=n.socket;e.getOrCreateSockFactory(n).newSocket("sync:",function(e){if(!e){o();return}var n=new ArrayBuffer(8);var i=new DataView(n);var c=r+",0644";i.setUint32(0,t.ID_SEND,true);i.setUint32(4,c.length,true);e.write(n,function(){e.write(str2ab(c),function(){var n;var r=true;s.onClose=function(){var n=new ArrayBuffer(8);var r=new DataView(n);r.setUint32(0,t.ID_DONE,true);r.setUint32(4,0,true);e.write(n,function(){e.read(8,function(){o()})})};function i(){s.read(function(e){if(e.byteLength>t.DATA_MAX){var n=e.subarray(t.DATA_MAX);e=e.subarray(0,t.DATA_MAX);s.unshift(n)}c(e)})}function c(n){var o=new ArrayBuffer(8);var r=new DataView(o);r.setUint32(0,t.ID_DATA,true);r.setUint32(4,n.byteLength,true);e.write(o,function(){var t=n.buffer;if(n.byteOffset||n.length!=t.byteLength){t=t.slice(n.byteOffset,n.byteOffset+n.byteLength)}e.write(t,function(){i()})})}i()})})})};window.Adb=e})();(function(){function e(e,t){this.transport=e;this.sockets={};this.currentSocketId=0;this.maxPayload=t||AdbDevice.MAX_PAYLOAD}e.prototype.start=function(e){var t=str2ab(e,undefined,true);this.sendMessage(AdbDevice.kCommandCNXN,AdbDevice.ADB_PROTOCOL_VERSION,this.maxPayload,t);this.receiveMessages()};e.prototype.fatal=function(e){console.log("fatal error",e);var t=this.onClose;if(t){delete this.onClose;t()}};e.prototype.sendMessage=AdbDevice.prototype.sendMessage;e.prototype.receiveMessages=AdbDevice.prototype.receiveMessages;e.prototype.onReceiveMessage=AdbDevice.prototype.onReceiveMessage;e.prototype.handleMessage=AdbDevice.prototype.handleMessage;e.prototype.handleUnknown=AdbDevice.prototype.handleUnknown;e.prototype.newAdbSocket=AdbDevice.prototype.newAdbSocket;e.prototype.destroy=AdbDevice.prototype.destroy;e.prototype.onOpenSocket=function(e,t){if(this.openSocket){var n=++this.currentSocketId;var o=this.newAdbSocket(n);o.remoteId=t;this.sockets[n]=o;this.sendMessage(AdbDevice.kCommandOKAY,n,t);this.openSocket(ab2str(e),o)}};window.AdbDaemon=e})();(function(){function e(e,t,n){$.ajax({url:e,dataType:"binary",responseType:"arraybuffer",success:function(e){var o=new Uint8Array(e);var r=new DummySocket(o);var i="/data/local/tmp/apk"+(new Date).getTime()+".apk";Adb.push({serialno:t,file:i,socket:r},function(){Adb.shell({command:"pm install -r "+i,serialno:t},n)})}})}function t(e,t,n){Adb.shell({command:"pm path "+t,serialno:e},function(e){if(e==""||!e){n(null);return}var t=e.match(/package:\/.*?[\r\n]/);if(!t||!t.length){n(null);return}e=t[0];e=e.replace("package:","").trim();n(e)})}function n(e,t,n,o,r){if(!r)r=Adb.shell;Adb.shell({command:"ls -l /system/bin/app_process*",serialno:e},function(i){var s="/system/bin/app_process";if(i&&i.indexOf("app_process32")!=-1){s+="32"}r({command:'sh -c "CLASSPATH='+t+" "+s+" /system/bin "+n+'"',serialno:e},o)})}window.AdbUtils={runMain:n,installApk:e,getApkPath:t}})();(function(){var e=function(e){this.authorization=e};e.prototype.shorten=function(e,t){$.ajax({type:"POST",url:"https://www.googleapis.com/urlshortener/v1/url?key="+this.authorization,data:JSON.stringify({longUrl:e}),contentType:"application/json",dataType:"json",success:function(e){t(e.id)}})};window.Googl=e})();function verifySignature(e,t,n,o,r){o=base64ToArrayBuffer(o);n=str2ab(n);window.crypto.subtle.importKey("jwk",{kty:"RSA",e:e,n:t,alg:"RS1"},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},true,["verify"]).then(function(e){window.crypto.subtle.verify({name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},e,o,n).then(function(e){if(!e){r("invalid signature");return}r()}).catch(function(e){r("failure to verify",e)})}).catch(function(e){r("key import failed",e)})}(function(){function e(){this.licensed=false;this.licenseCached=false}e.prototype.refresh=function(e){this.refreshInternal(e).async()};e.prototype.refreshInternal=function*(e){var t;var n=function(){if(this.isLicensed()){var n=chrome.app.window.get("purchase");if(n!=null){n.close();showNotification("Vysor subscription is active. Thank you for your support!")}}if(this.globalRefresh)this.globalRefresh();if(t)return;t=true;if(e)e(this.isLicensed())}.bind(this);var o=false;var r=false;var i=false;var s=false;var c;var a;var l;var u=function(e,t){if(!t.licensed)return;if(e!=t.email){console.log("email mismatch");return}console.log("enterprise license retrieved");this.licensed=true}.bind(this);var d=function(e,t){if(t.sandbox!=o){console.log("sandbox mismatch");return}if(e!=t.buyer_id){console.log("id mismatch");return}if(t.seller_id!="koushd@gmail.com"){console.log("seller mismatch");return}$.each(t.orders,function(e,t){console.log("purchase found",t);if(t.is_purchased){console.log("clockwork license retrieved");this.licensed=true}}.bind(this))}.bind(this);var f=function(e){var t=0;$.each(e,function(e,n){console.log("subscription status",n.sku,n.state);if(n.state=="ACTIVE"){console.log("chrome license retrieved");this.licensed=true;t=Math.max(t,n.createdTime)}}.bind(this));return t}.bind(this);var h=function*(){if(s){console.log("skipping enterprise");return}console.log("checking chrome enterprise licenses");var e=yield getAuthToken(false,yield);if(!e){chrome.runtime.lastError;console.error("No auth token for enterprise licensing");return}try{var t=yield $.ajax({url:"https://www.googleapis.com/oauth2/v1/userinfo",headers:{Authorization:"Bearer "+e},dataType:"json",error:yield Error,success:yield Success});var o=t.id;var r=t.email;try{var t=yield $.ajax({url:"https://vysor-1026.appspot.com/license",headers:{Authorization:"Bearer "+e},dataType:"json",success:yield Success,error:yield Error});var i=JSON.parse(t.signed_data);u(r,i);if(!this.isLicensed()){console.log("No enterprise license found on server");return}yield chrome.storage.local.set({cachedEnterpriseLicense:t},yield);this.licenseCached=true;n()}catch(c){yield chrome.identity.removeCachedAuthToken({token:e},yield);console.error("Error communicating with vysor enterprise",c)}}catch(c){yield chrome.identity.removeCachedAuthToken({token:e},yield);console.error("Unable to get email for enterprise",c)}}.bind(this);var p=function*(){if(r){console.log("skipping clockwork");return}console.log("checking clockwork purchases");var e=yield getAuthToken(false,yield);if(!e){chrome.runtime.lastError;console.error("No auth token for clockwork billing");return}try{var t=yield $.ajax({url:"https://www.googleapis.com/oauth2/v1/userinfo",headers:{Authorization:"Bearer "+e},dataType:"json",error:yield Error,success:yield Success});var i=t.id;var s="https://clockworkbilling.appspot.com/api/v1/purchase/koushd@gmail.com/"+i+"?sandbox="+o+"&nonce="+Date.now();try{var t=yield $.ajax({url:s,dataType:"json",error:yield Error,success:yield Success});var c=JSON.parse(t.signed_data);d(i,c);if(!this.isLicensed()){console.log("no clockwork license found on server");return}yield chrome.storage.local.set({cachedClockworkLicense:t},yield);this.licenseCached=true;n()}catch(a){console.error("error requesting purchases")}}catch(a){yield chrome.identity.removeCachedAuthToken({token:e},yield);console.error("Unable to get buyer id for clockworkbilling",a)}}.bind(this);var v=function*(){if(i)return;console.log("checking chrome store purchases");var e;try{e=yield google.payments.inapp.getPurchases({parameters:{env:"prod"},success:yield Success,failure:yield Error})}catch(t){console.error("failed to query license from chrome store",t);if(!c){console.log("falling back to server proxied query.");try{yield this.cacheLicense(false,yield);yield*y()}catch(t){console.error("failed to do fallback server check",t)}}return}f(e.response.details);if(!this.isLicensed()){console.log("no chrome license found on server");return}n();console.log("Caching Vysor license.");yield this.cacheLicense(false,yield);if(this.isLicenseCached())n()}.bind(this);var g=4;var m=g/2;var y=function*(){if(i)return;console.log("checking cached chrome license");var e=yield chrome.storage.local.get("cachedLicense",yield);if(!e){console.error("storage access failed?",chrome.runtime.lastError);return}if(!e.cachedLicense){console.log("no cached chrome license found");return}var t=yield chrome.identity.getProfileUserInfo(yield);if(!t){console.log("unable to retrieve user info");return}var o=yield verifySignature("AQAB","vMGBBmLcMO4lOmg-YAHq2DjZKHTaW-xs9KPNXU_zKJ7ZhFhWH3I6skF9ZO8lKeXOSwVEIW4HVMa7m16S6WTrUw",e.cachedLicense.signed_data,e.cachedLicense.signature,yield);if(o){console.error("error verifying cached signature",o);return}var r=JSON.parse(e.cachedLicense.signed_data);if(r.date>Date.now()){console.log("cached license date from future?");return}if(r.date+u*24*60*60*1e3<Date.now()){console.log("cached license is expired.");return}if(t.id!=r.userinfo.id){console.log("id mismatch");return}c=true;var s=f(r.payments);if(!this.isLicensed()){console.log("no chrome license found in cache");return}var a=new Date-new Date(s);var l=a/1e3/60/60/24;var u;if(l<14)u=4;else u=Math.min(30,4+(l-14)/7);console.log("cached license is valid for "+(r.date+u*24*60*60*1e3-Date.now())/(60*60*1e3)+" hours");this.licenseCached=true;n();if(r.date+m*24*60*60*1e3<Date.now())yield*v()}.bind(this);var w=function*(){if(r)return;console.log("checking cached clockwork license");var e=yield chrome.storage.local.get("cachedClockworkLicense",yield);if(!e){console.error("storage access failed?",chrome.runtime.lastError);return}if(!e.cachedClockworkLicense){console.log("no cached clockwork license found");return}var t=yield chrome.identity.getProfileUserInfo(yield);if(!t){console.log("unable to retrieve user info");return}var o=t.id;var i=yield verifySignature("AQAB","vMGBBmLcMO4lOmg-YAHq2DjZKHTaW-xs9KPNXU_zKJ7ZhFhWH3I6skF9ZO8lKeXOSwVEIW4HVMa7m16S6WTrUw",e.cachedClockworkLicense.signed_data,e.cachedClockworkLicense.signature,yield);if(i){console.error("error verifying cached clockwork signature",i);return}var s=JSON.parse(e.cachedClockworkLicense.signed_data);if(s.timestamp+g*24*60*60*1e3<Date.now()){console.log("cached license is expired.");return}if(s.timestamp>Date.now()){console.log("cached license date from future?");return}a=true;d(o,s);if(!this.isLicensed()){console.log("no clockwork license found in cache");return}console.log("cached clockwork license is valid for "+(s.timestamp+g*24*60*60*1e3-Date.now())/(60*60*1e3)+" hours");this.licenseCached=true;n();if(s.timestamp+m*24*60*60*1e3<Date.now())yield*p()}.bind(this);var b=function*(){if(s)return;console.log("checking cached enterprise license");var e=yield chrome.storage.local.get("cachedEnterpriseLicense",yield);if(!e){console.error("storage access failed?",chrome.runtime.lastError);return}if(!e.cachedEnterpriseLicense){console.log("no cached enterprise license found");return}console.log("checking cached enterprise license",e.cachedEnterpriseLicense);var t=yield chrome.identity.getProfileUserInfo(yield);if(!t){console.log("unable to retrieve user info for enterprise");return}console.log("user info",t);var o=yield verifySignature("AQAB","hDuGsIhbjLYXteQX3F3KNriQHwUSZurS5voCkdpA1733A65pqtGOrk9g_yLiF94_vSK0VmL-4stq7WAYEbn6nw",e.cachedEnterpriseLicense.signed_data,e.cachedEnterpriseLicense.signature,yield);if(o){console.error("error verifying cached enterprise signature",o);return}var r=JSON.parse(e.cachedEnterpriseLicense.signed_data);if(r.timestamp+g*24*60*60*1e3<Date.now()){console.log("cached enterprise license is expired.");w();return}if(r.timestamp>Date.now()){console.log("cached enterprise license date from future?");return}l=true;u(t.email,r);if(!this.isLicensed()){console.log("no enterprise license found in cache");return}console.log("cached enterprise license is valid for "+(r.timestamp+g*24*60*60*1e3-Date.now())/(60*60*1e3)+" hours");this.licenseCached=true;n();if(r.timestamp+m*24*60*60*1e3<Date.now())yield*h()}.bind(this);yield*b();if(this.isLicensed())return;yield*w();if(this.isLicensed())return;yield*y();if(this.isLicensed())return;yield*v();if(this.isLicensed())return;yield*p();if(this.isLicensed())return;yield*h();if(this.isLicensed())return;n()};e.prototype.cacheLicense=function(e,t){console.log("caching chrome license");getAuthToken(e,function(n){if(!n){chrome.runtime.lastError;if(e)showNotification("Unable to get auth token: "+chrome.runtime.lastError);console.error("Unable to get auth token while caching license",chrome.runtime.lastError);if(t)t(chrome.runtime.lastError);return}$.ajax({type:"post",url:"https://clockworkbilling.appspot.com/api/v1/verify/google/koushd@gmail.com",data:{token:n,item:chrome.runtime.id},dataType:"json",success:function(e){this.licenseCached=true;chrome.storage.local.set({cachedLicense:e},t)}.bind(this),error:function(e,o){console.error("unable to cache license");chrome.identity.removeCachedAuthToken({token:n},function(){if(t)t(o)})}})}.bind(this))};e.prototype.isLicensed=function(){return this.licensed};e.prototype.isLicenseCached=function(){return this.licenseCached};e.prototype.startPurchase=function(){chrome.app.window.create("purchase.html",{id:"purchase",innerBounds:{minWidth:800,minHeight:840}},function(e){this.refresh();e.contentWindow.refreshLicenseManager=function(e){chrome.storage.local.remove(["cachedLicense","cachedClockworkLicense","cachedEnterpriseLicense"],function(){this.refresh(e)}.bind(this))}.bind(this)}.bind(this))};window.LicenseManager=e})();function GcmDevice(e,t,n){this.adbSocketFactory=e;this.conn=n;this.conn.openSocket=this.openSocket.bind(this);var o=t.properties.substring(t.properties.indexOf("product")).replace(/ /g,";").replace("device","ro.product.device").replace("model","ro.product.model").replace("product","ro.product.name").replace(/:/g,"=");this.properties="device::"+o+";"}GcmDevice.prototype.openSocket=function(e,t){if(this.onOpenSocket&&this.onOpenSocket(e,t))return;if(e=="properties"){var n=this.properties;t.write(str2ab(n),function(){console.log("sent properties",n);t.destroy()});return}this.adbSocketFactory.newSocket(e,function(n){if(!n){console.log("unable to execute adb proxy command?",e);t.destroy();return}Socket.stream(n,t,function(){})})};function getWhitelist(e){chrome.storage.local.get("whitelist",function(t){var n={};if(!t.whitelist||t.whitelist.constructor.name!="Array"){e(n);return}$.each(t.whitelist,function(e,t){n[t]=true});e(n)})}function saveWhitelist(e,t){chrome.storage.local.set({whitelist:Object.keys(e)},t)}function addToWhitelist(e,t){getWhitelist(function(n){n[e]=true;saveWhitelist(n,t)})}function clearWhitelist(){chrome.storage.local.remove("whitelist")}function isWhitelisted(e,t){chrome.storage.local.get(["whitelist","serverMode"],function(n){if(n.serverMode==1){t(true);return}if(n.serverMode!=2){var o={};if(!n.whitelist||n.whitelist.constructor.name!="Array"){t(false);return}t(n.whitelist.indexOf(e)!=-1,true);return}getAuthToken(false,function(n){if(!n){console.error("unable to get token for vysor enterprise whitelist check");t(false);return}$.ajax({type:"get",url:"https://vysor-1026.appspot.com/whitelist",headers:{Authorization:"Bearer "+n},data:{email:e},error:function(){console.error("failure checking vysor enterprise whitelist",arguments);t(false)},success:function(n){if(!n.whitelist)console.error("access denied to",e,n);t(n.whitelist,false)}})})})}function getVysorWhitelistStatus(e){chrome.storage.local.get(["whitelist","serverMode"],function(t){if(t.serverMode==1){e("Any user can access this server.");return}if(t.serverMode==2){e("Your Vysor Enterprise users can access this server.");return}var n;if(!t.whitelist||t.whitelist.constructor.name!="Array")n=0;else n=t.whitelist.length;e(n+" user(s) can access this server.")})}function getDefaultDeviceSettings(){var e={showSoftKeys:true,pinTitleBar:true,alwaysOnTop:false,bitrate:0,resolution:0,decoder:0};return e}function sanitizeDeviceSettings(e){if(!e)return null;if(e.friendlyName&&!e.friendlyName.length)delete e.friendlyName;return e}function loadAllDeviceSettings(e){if(window.chrome&&window.chrome.storage){chrome.storage.local.get("device-settings",function(t){e(t["device-settings"]||{})})}else{e({})}}function loadDeviceSettings(e,t){if(!e)e="web";var n=getDefaultDeviceSettings();if(e=="inkwire"){n.pinTitleBar=false;n.showSoftKeys=false}loadAllDeviceSettings(function(o){t(sanitizeDeviceSettings(o[e]||n))})}function saveDeviceSettings(e,t,n){sanitizeDeviceSettings(t);if(!window.chrome||!window.chrome.storage){if(n)n();return}if(!e||e.indexOf("127.0.0.1")!=-1){if(n)n();return}loadAllDeviceSettings(function(o){o[e]=t;chrome.storage.local.set({"device-settings":o},n)})}function applyDeviceSettings(e){$("#new-display-name").prop("value",e.friendlyName);$("#softkeys-check").prop("checked",e.showSoftKeys?true:false).change();$("#pin-title-check").prop("checked",e.pinTitleBar?true:false).change();$("#always-on-top-check").prop("checked",e.alwaysOnTop?true:false).change();$("#bitrate").prop("selectedIndex",e.bitrate||0);$("#decoder").prop("selectedIndex",e.decoder||0);$("#resolution").prop("selectedIndex",e.resolution||0)}(function(){console.log("Vysor version",chrome.runtime.getManifest().version);console.log(navigator.userAgent);var e=new AdbServer({start:false});var t;var n;var o={};var r={};var i={};var s;var c=analytics.getService("vysor_app");var a=c.getTracker("UA-4956323-6");var l=new LicenseManager;var u="Chrome GCM Service is unavailable. Try restarting Chrome?";
var d=new HttpServer;chrome.storage.local.get("vysorHttp",function(e){if(!e){console.error("unable to start vysor httpServer, no dict");return}var t=e.vysorHttp||{};t.password=t.password||Math.round(Math.random()*(1<<30)).toString(16);var n={"/device/(.*?)/video.flv":function(e,t,n){var o=n[1];var r=chrome.app.window.get(o);if(!r){console.error("device window",o,"not found");t.code(404);t.write("",function(){});return}if(!r.contentWindow.siphonFlv){console.error("siphonFlv",o,"not found");t.code(404);t.write("",function(){});return}var i=new DummySocket;t.headers["Connection"]="close";t.headers["Content-Type"]="video/x-flv";Socket.pump(i,t,function(){console.log("flv source closed")});r.contentWindow.siphonFlv(i)}};function o(){d.listen(t.port||0,function(e,t){console.log("http request",e.path);if(!l.isLicensed()){console.error("ignoring request, not licensed");t.code(402);t.write("This feature is only available in Vysor Pro",function(){});return}var o;var r;for(var i in n){o=e.path.match(i);r=n[i];if(o)break}if(!o){t.code(404);t.write("",function(){});return}r(e,t,o)},function(e){if(e){console.error("http server failed to listen",e);if(t.port){console.log("trying port 0");t.port=0;o()}return}t.port=d.socket.localPort;console.log("vysor http port: "+t.port);chrome.storage.local.set({vysorHttp:t})})}o()});l.refresh();function f(e){if(!s)return;s.contentWindow.showModal(e)}function h(e,t){if(!s)return;s.contentWindow.shortModal(e,t)}function p(){h(null,u)}function v(){if(!s)return;s.contentWindow.updateVysorShareServer(n)}function g(e,t){var n=chrome.app.window.get(e);if(!n)return;$(n.contentWindow.document).find("#loading-text").html(t)}function m(e,t){g(e,"Installing Vysor APK...");AdbUtils.installApk("/Vysor-release.apk",e,t)}function y(e,n,o){g(e,"Connecting...");function r(r){var i=Math.round(Math.random()*(1<<30)).toString(16);var s="echo -n "+i+" > /data/local/tmp/vysor.pwd ; chmod 600 /data/local/tmp/vysor.pwd";AdbUtils.runMain(e,r,"com.koushikdutta.vysor.Main password="+i+" keyboard="+t,function(t){Adb.shell({serialno:e,command:'sh -c "'+s+'"'},function(e){Socket.eat(t);o(n,i)})},function(e,t){e.command="shell:"+e.command;Adb.sendClientCommand(e,t)})}function i(t){g(e,"Connecting...");AdbUtils.getApkPath(e,"com.koushikdutta.vysor",function(n){if(!n){t();return}AdbUtils.runMain(e,n,"com.koushikdutta.vysor.ProtocolVersionMain",function(e){var o=e.match(/vysor-io-.*?[\r\n]/);if(!o||!o.length){t(null);return}e=o[0];if(e)e=e.trim();console.log("protocol version: "+e);if(e!="vysor-io-30")t(null);else t(n)})})}i(function(t){if(!t){console.log("installing apk");m(e,function(t){i(function(n){if(!n){if(!t)t="";showNotification("Error installing APK:\n"+t.trim());w(e);return}r(n)})});return}r(t)})}function w(e){var t=e;if(o[e]&&o[e].id)t=o[e].id;var n=chrome.app.window.get(t);if(n)n.close()}var b=53516;function k(e,t){var n=b++;Adb.forward({from:"tcp:"+n,to:"tcp:53516",serialno:e},function(){y(e,n,t)})}function S(t,n,r,i){if(o[n]){console.log("vysor socket fast path");t.contentWindow.adbSocketFactory=o[n]}else if(e.isRunning()){console.log("adb server socket path");t.contentWindow.adbSocketFactory=e.adbDevices[n]}else{console.log("adb client socket path");t.contentWindow.adbSocketFactory=Adb.createSocketFactory(n)}t.contentWindow.lm=l;t.contentWindow.openList=U;t.contentWindow.password=i;t.contentWindow.port=r;if(d&&d.socket)t.contentWindow.httpPort=d.socket.localPort;t.contentWindow.device=o[n]||F[n];t.contentWindow.tracker=a}function A(){setTimeout(function(){if(!chrome.app.window.getAll().length){chrome.runtime.reload()}},5e3)}function C(e,t,n){E();var r=e;if(o[e]&&o[e].id)r=o[e].id;var i=chrome.app.window.get(r);if(i){i.show();if(t){k(e,function(t,n){S(i,e,t,n);i.contentWindow.connectionReady()})}if(n)n(i);return}chrome.app.window.create("screen.html",{id:r,bounds:{width:576,height:1024}},function(t){var o;t.onClosed.addListener(o=function(){t.onClosed.removeListener(o);A();if(t.contentWindow.h264Socket){console.log("cleaning up h264 socket");t.contentWindow.h264Socket.destroy();t.contentWindow.h264Socket=null}if(t.contentWindow.inputWebSocket){console.log("cleaning up input websocket");t.contentWindow.inputWebSocket.close();t.contentWindow.inputWebSocket=null}});t.contentWindow.onload=function(){S(t,e,null,null);t.contentWindow.docReady();if(n)n(t);if(!F[e]){console.log("Vysor requested for",e,"which is not available yet");return}k(e,function(n,o){S(t,e,n,o);t.contentWindow.connectionReady();Adb.shell({command:"am start com.koushikdutta.vysor/.TipsActivity",serialno:e},function(){})})}})}function D(){n=null;if(N)N.stopListen("share");v()}function L(e,t,n){if(!e.devices[t])return;if(e.gcmConn.gcmConns[t])e.gcmConn.gcmConns[t].destroy();var o;var r=e.gcmConn.gcmConns[t]={id:t,farm:true,newSocket:function(n,r){if(o)return;e.gcmConn.newSocket(t+":"+n,r)},destroy:function(){o=true;if(e.gcmConn.gcmConns[t]==r)delete e.gcmConn.gcmConns[t];delete F[r.serialno];e.gcmConn.newSocket("close:"+t,function(e){if(e)e.destroy()});var n=r.onClose;if(n){delete r.onClose;n()}}};R(function(e){e(r)},n)}var O;function I(e,t,n){function o(e){if(n)n(null,e)}e=new URL(e);var r=e.hash.replace("#","");function s(e){if(!N){o(null,u);return}N.connect({senderId:"64148182473",registrationId:e.registration,port:"share"},function(s){a.sendEvent("connected-device-farm");var c=i[r];var l;if(c){c.gcmConn.destroy()}var u=i[r]={info:e,gcmConn:s};s.gcmConns={};function d(){s.newSocket("devices:",function(e){readString(e,function(e){var t=JSON.parse(e);var n=t.devices;var o=t.sharedDevices;if(!u.devices){u.devices=n}else{$.each(Object.keys(n),function(e,t){delete u.devices[t]});$.each(Object.keys(u.devices),function(e,t){var n=s.gcmConns[t];if(n)n.destroy()});u.devices=n}u.sharedDevices=o;X()})})}s.openSocket=function(e,r){if(e.startsWith("challenge:")){console.log("received challenge",e);var i=e.split(":")[1];$.ajax({type:"post",url:"https://vysor-1026.appspot.com/verifyauth",headers:{Authorization:"Bearer "+t},data:{nonce:i},dataType:"json",success:function(e){O=JSON.parse(e.signed_data);console.log("sending challenge response",e);writeLine(r,e,function(){readLine(r,function(e){r.destroy();if(e=="ok"){d();if(n)n(u.info);return}o("Access denied: "+e)})})},error:function(e,t){o(null,"Unable to verify identity.");r.destroy()}})}else if(e.startsWith("close:")){r.destroy();var c=e.split(":")[1];var a=s.gcmConns[c];if(!a){console.log("can't close unknown subconn");return}a.destroy()}else if(e.startsWith("tracker:")){console.log("got tracker socket");l=r;function f(){l.read(function(){d();f()})}f()}else{console.log("got unknown socket request",e);r.destroy()}};s.onClose=function(){if(i[r]==u)delete i[r];$.each(Object.keys(s.gcmConns),function(e,t){var n=s.gcmConns[t];if(n)n.destroy()})};console.log("Connection to device farm established",s)})}$.ajax({url:"https://vysor-1026.appspot.com/gcm/"+r,dataType:"json",success:s,error:function(e,t){showNotification("Unable to find server: "+t)}})}function T(e,t){function i(e){if(t)t(null,e);else showNotification(e)}function s(){if(t)t(n)}D();getAuthToken(e,function(e){if(!e){i("Unable to get Auth Token.");return}if(!N){i(u);return}$.ajax({type:"post",url:"https://vysor-1026.appspot.com/gcm",headers:{Authorization:"Bearer "+e},data:{registration:N.registrationId},dataType:"json",success:function(e){console.log("vysor share server",e);n="https://vysor.clockworkmod.com/server#"+e.id;s(n)}.bind(this),error:function(e,t){D();i("Unable to register server: "+t)}});var t;var c=[];function a(){t=throttleTimeout(t,null,500,function(){$.each(c,function(e,t){if(!t.trackerSocket)return;t.trackerSocket.write(str2ab("0000\n"),function(){})});X()})}var l;N.listen("share",function(e){var t;var n;var i;var s={};var u=Math.round(Math.random()*(1<<30)).toString(16)+Math.round(Math.random()*(1<<30)).toString(16);e.onClose=function(){var t=c.indexOf(e);if(t!=-1)c.splice(t,1);if(e.trackerSocket){e.trackerSocket.destroy();delete e.trackerSocket}$.each(Object.keys(s),function(e,t){var n=s[t];n.destroy()})};e.newSocket("challenge:"+u,function(o){if(!o){console.error("challenge socket failed");e.destroy();return}readLine(o,function(r){console.log("received challenge response",r);var s=JSON.parse(r);function a(e){e=e||"fail";console.log("Remote user failed to authorize",e);writeLine(o,e,function(){o.destroy()})}verifySignature("AQAB","hDuGsIhbjLYXteQX3F3KNriQHwUSZurS5voCkdpA1733A65pqtGOrk9g_yLiF94_vSK0VmL-4stq7WAYEbn6nw",s.signed_data,s.signature,function(r){if(r){a("Identify signature verification failed.");return}n=JSON.parse(s.signed_data);if(n.nonce!=u){a("Mismatched nonce in authentication.");return}function l(){function r(){c.push(e);t=true;writeLine(o,"ok",function(){o.destroy()});showNotification("Vysor is sharing Android devices with "+n.name,i);Adb.sendHostCommand("host:track-devices",function(t){if(!t){console.error("unable to track adb devices",chrome.runtime.lastError);return}e.newSocket("tracker:",function(n){if(!n){t.destroy();console.error("unable to open remote tracker");return}e.trackerSocket=n;Socket.stream(n,t)})})}isWhitelisted(n.email,function(e,t){if(e){r();return}if(!t){a("Denied by policy.");return}var o=chrome.runtime.getManifest().name;chrome.notifications.create({type:"basic",iconUrl:i,title:o,message:n.name+" is requesting access to Vysor shared Android devices.",buttons:[{title:"Allow"},{title:"Deny"}]},function(e){var t;var o=function(n){if(n!=e)return;chrome.notifications.onClosed.removeListener(o);chrome.notifications.onButtonClicked.removeListener(i);if(!t)a("Denied by user.")};var i=function(o,i){if(o!=e)return;chrome.notifications.clear(o);t=true;if(i==0){addToWhitelist(n.email,function(){v()});r()}else{a("Denied by user.")}};chrome.notifications.onClosed.addListener(o);chrome.notifications.onButtonClicked.addListener(i)})})}if(n.picture){blobFromUrl(n.picture,function(e){i=e;l()})}else{i="/icon.png";l()}})})});e.openSocket=function(i,c){if(!t){c.destroy();return}if(i=="devices:"){l=throttleTimeout(l,c,500,function(e){loadAllDeviceSettings(function(t){Adb.devices(function(n){if(!n)n={};$.each(Object.keys(n),function(e,r){if(o[r])delete n[r];sanitizeDeviceSettings(t[r]);if(t[r]&&t[r].friendlyName)n[r].name=t[r].friendlyName});var i={};$.each(Object.keys(r),function(e,t){i[t]={userInfo:r[t].userInfo}});$(e).each(function(e,t){writeString(t,{devices:n,sharedDevices:i},function(){t.destroy()})})})})})}else if(i.startsWith("close:")){c.destroy();var u=i.split(":")[1];var d=s[u];if(d)d.destroy()}else{var f=i.indexOf(":");if(f==-1){console.error("unexpected command received by device farm server");c.destroy();return}var u=i.substring(0,f);if(!F[u]){f=i.indexOf(":",f+1);if(f==-1){c.destroy();return}u=i.substring(0,f);if(!F[u]){console.error("request for unknown device",u);return}}var d=s[u];if(!d){var h=Adb.createSocketFactory(u);d=s[u]=new GcmDevice(h,F[u],{});d.destroy=function(){try{e.newSocket("close:"+u,function(e){if(e)e.destroy()})}catch(t){}var o=r[u];if(o){if(o.userInfo==n)delete o.userInfo;if(o.gcmConn==this)delete o.gcmConn;if(!o.key&&!o.gcmConn)delete r[u]}var i=this.onClose;if(i){delete this.onClose;i()}a()}.bind(d)}var p=r[u];if(!p)p=r[u]={};if(p.gcmConn!=d){M(u);p.gcmConn=d;p.userInfo=n;r[u]=p}a();var v=i.substring(f+1);d.openSocket(v,c)}}})})}function U(n){if(s){if(n){n(s)}return}chrome.app.window.create("list.html",{id:"list",innerBounds:{width:768,height:768,minWidth:768,minHeight:768}},function(o){s=o;s.contentWindow.openList=U;s.contentWindow.licenseManager=l;s.contentWindow.disconnectSharedDevice=Y;s.contentWindow.toggleShare=J;s.contentWindow.quietSerial=q;s.contentWindow.openWindow=C;s.contentWindow.closeWindow=w;s.contentWindow.createDeviceFarmConnection=L;s.contentWindow.adbServer=e;s.contentWindow.Adb=Adb;s.contentWindow.tracker=a;s.contentWindow.startWireless=z;s.contentWindow.startDeviceFarm=T;s.contentWindow.stopDeviceFarm=D;s.contentWindow.onload=function(){$(s.contentWindow.document).find("#vysor-keyboard-check").change(function(){t=this.checked;chrome.storage.local.set({keyboard:this.checked})});chrome.storage.local.get("keyboard",function(e){t=e.keyboard;$(s.contentWindow.document).find("#vysor-keyboard-check").prop("checked",t)});v();X()};s.onClosed.addListener(function(){s=null;A()});if(n){controller=new Controller(receiverWindow.contentWindow,true);n(receiverWindow)}})}function R(t,n){e.start();var r=new Server;r.listen({port:0,address:"127.0.0.1"},function(e){r.destroy();var i=new AdbDaemon(new AdbTcpTransport(e));t(function(e){a.sendEvent("connected-shared-device");var t="127.0.0.1:"+r.localPort;e.serialno=t;if(!e.id)e.id=t;o[t]=e;console.log("connected gcm socket");e.openSocket=function(){console.log("got a new socket? this should not happen...");e.destroy()};i.onClose=e.onClose=function(){delete o[t];i.destroy();e.destroy()};e.onClose=function(){delete o[t];i.destroy();e.destroy();showNotification("Disconnected from shared Android device.")};i.openSocket=function(t,n){e.newSocket(t,function(e){Socket.stream(n,e,function(){})})};e.newSocket("properties",function(o){readString(o,function(o){var r=AdbDevice.parseConnectionPayload(o);e.name=e.name||r["ro.product.model"].replace("_"," ");i.start(o);console.log("got properties",o);n(t)})})})}.bind(this),function(e){if(e){console.log("adb daemon failed to listen: "+e);return}var t="127.0.0.1:"+r.localPort;o[t]={id:t,destroy:function(){}};var n="127.0.0.1:"+r.localPort;Adb.sendHostCommand("host:connect:"+n,function(e,t){if(!e){return}e.destroy();t=ab2str(t);console.log("adb connect result",t)})}.bind(this))}function W(e,t){showNotification("Vysor is connecting to a remote Android device");if(s)s.show();console.log("attempting to connect to shared device",e);if(!N){p();return}var n=new URL(e);var o=getQueryVariable("senderId",n);var r=getQueryVariable("registrationId",n);var i=getQueryVariable("channel",n);if(!o)o="64148182473";R(function(e){N.connect({senderId:o,registrationId:r,port:i},e)},t)}chrome.app.runtime.onLaunched.addListener(function(e){U();if(e&&e.id=="vysor_purchase"){l.refresh()}if(e&&e.id=="vysor_presentation"){W(e.url,function(e){C(e)})}if(e&&e.id=="vysor_device_farm"){console.log("device farm",e.url);if(s)s.show();U();showNotification("Vysor is connecting to shared Android devices");getAuthToken(true,function(t){if(!t){showNotification("Unable to get auth token");return}I(e.url,t,function(e,t){if(t){h("Vysor Share","Unable to connect to shared devices. "+t);return}h("Vysor Share","Connected to "+e.name+"'s remote devices.")})})}E()});function E(){chrome.runtime.requestUpdateCheck(function(e,t){if(e=="update_available"){ce()}})}var N;GcmRtcManager.start({3505780036:"AIzaSyDt0GimPRhk8_d_4XjOYzQUn50UkvXhMtE",64148182473:"AIzaSyDd7k1v017osyYbIC92fyf-36s3pv0z73U"},{iceServers:[{url:"turn:n0.clockworkmod.com",username:"foo",credential:"bar"},{url:"turn:n1.clockworkmod.com",username:"foo",credential:"bar"}]},function(e){N=e;if(N){N.defaultSenderId="64148182473";chrome.storage.local.get("share-all-devices",function(e){if(e["share-all-devices"]){T(false,function(){v()})}})}});function M(e){var t=r[e];if(t&&t.gcmConn){var n=t.gcmConn;delete t.gcmConn;n.destroy()}}function P(e){M(e);delete r[e];X()}function x(e,t){function n(e){if(t)t(null,e)}var o=F[e];if(!N){n(u);return}var i=Math.round(Math.random()*(1<<30)).toString(16);if(!r[e])r[e]={};r[e].key=i;X();var s="https://vysor.clockworkmod.com/redirect/?registrationId="+encodeURIComponent(N.registrationId)+"&channel="+i;console.log(s);N.listen(i,function(t){a.sendEvent("shared-device");var n=r[e];if(!n||n.key!=i){t.destroy();console.log("device is no longer being shared.");return}if(n.gcmConn)n.gcmConn.destroy();n.gcmConn=t;n.userInfo={name:"Someone"};X();console.log("accepted gcm socket");var s=Adb.createSocketFactory(e);var c=new GcmDevice(s,o,t);c.onOpenSocket=function(t,n){if(t=="webstart"){y(e,null,function(t,o){writeLine(n,o,function(){console.log("sent password",o);n.destroy()});Adb.shell({command:"am start com.koushikdutta.vysor/.TipsActivity",serialno:e},function(){})});return true}}});var c=new Googl("AIzaSyCpibOeYoPpL8sMTjkliO8uRVRoaAcsge4");c.shorten(s,function(e){if(t)t(e)})}var _={};var B={};var F={};var V;var j={};var K={};function H(e){var t=K[e];clearTimeout(t);K[e]=setTimeout(function(){delete K[e]},1e4);delete j[e]}function q(e){var t=j[e];clearTimeout(t);j[e]=setTimeout(function(){delete j[e]},1e4);delete K[e]}function Y(e){w(e);var t=o[e];if(t)t.destroy()}function J(e,t){if(r[e])P(e);else x(e,t);X()}function z(e){var t=Adb.createSocketFactory(e);t.newSocket("shell:ifconfig wlan0",function(n){if(!n){console.log("error running tcpip:5555");return}readString(n,function(n){console.log("ifconfig result",n);var o=n.match("inet addr:(.*?) ");if(!o)o=n.match("wlan0: ip (.*?) ");if(!o){showNotification("Unable to switch to wireless mode. Is your Android connected to Wifi?");return}var r=o[1];var i=r+":5555";if(chrome.app.window.get(i)){_[e]=i;B[i]=e;C(i);return}function s(e){Adb.sendHostCommand("host:connect:"+i,function(t,n){if(!t){return}t.destroy();n=ab2str(n);if(n.indexOf("unable to connect")!=-1){showNotification("Unable to connect via wireless. Is your Android on the same network as your PC?");return}chrome.storage.local.set({lastConnectAddress:i});console.log("adb connect result",n);if(e)c()})}function c(){_[e]=i;B[i]=e;X();w(e);showNotification("Vysor is connected wirelessly. You may disconnect your device.");a.sendEvent("go-wireless");q(i);C(i,true,function(e){H(i);e.contentWindow.tryReconnect=function(){H(i);s(false)}})}if(F[i]){c();return}q(e);t.newSocket("tcpip:5555",function(e){if(!e){showNotification("Failure while switching to wireless mode.");return}readString(e,function(e){console.log("tcpip:5555 result",e);s(true)})})})})}function X(){if(!s||!s.contentWindow.refreshList)return;s.contentWindow.refreshList(F,o,O,i,r,B,_,N,V,Z)}var G;function Q(){chrome.storage.local.get("connect-automatically",function(t){var n=t["connect-automatically"]!==false;Adb.devices(function(t){if(t){var r=[];var i;$.each(t,function(r,c){i=true;if(!F[r]){a.sendEvent("found-device",c.name);P(r);var l=t[r];var u=l.properties.indexOf("emulator")!=-1||l.properties.indexOf("vbox")!=-1;if(!u&&G&&!j[r]){var d=r;if(o[r])d=o[r].id;if(n||chrome.app.window.get(d)||e.isRunning()||K[r]){C(r,true);if(!s&&!chrome.app.window.get(r)){var f=chrome.runtime.getManifest().name;chrome.notifications.create("never-start-automatically",{type:"basic",iconUrl:"/icon.png",title:f,message:"Vysor has connected to an Android device and is starting.",buttons:[{title:"Never Start Automatically"}]})}}}}});F=t}else{F={}}X();G=true})})}var Z;function ee(){if(Z)return;Z=chrome.runtime.connectNative("com.clockworkmod.adb");Z.onDisconnect.addListener(function(){Z=null});Z.postMessage({command:"start-server"})}var te;var ne;function oe(){ne=throttleTimeout(ne,null,300,function(){Q()})}function re(){if(te)return;function t(e){e.read(function(n){oe();t(e)})}Adb.sendHostCommand("host:track-devices",function(n){if(te){n.destroy();return}if(!n)return;console.log("Connected to ADB Server");if(e.isRunning())console.log("Using Vysor ADB");else console.log("Using Android SDK ADB");V=true;n.onClose=function(){te=null;V=false;oe()};te=n;t(n);oe()})}function ie(){re();X();if(!V){ee()}setTimeout(ie,1e3)}ie();oe();var se;function ce(){se=throttleTimeout(se,null,1e4,function(){var e=chrome.runtime.getManifest().name;chrome.notifications.create("reload",{type:"basic",iconUrl:"/icon.png",title:e,message:"There is an update available for Vysor.",buttons:[{title:"Reload"}]})})}chrome.runtime.onUpdateAvailable.addListener(function(){A()});chrome.notifications.onButtonClicked.addListener(function(e,t){if(e=="reload"){chrome.runtime.reload()}else if(e=="never-start-automatically"){chrome.storage.local.set({"connect-automatically":false});if(s){$(s.contentWindow.document).find("#connect-automatically-check").prop("checked",false)}chrome.notifications.clear(e)}});chrome.notifications.onClicked.addListener(function(e,t){})})();
