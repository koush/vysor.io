!function(e){function n(e){setTimeout(e,0)}function t(e){for(var n=e.toString(16);n.length<4;)n="0"+n;return n}function i(e){return"ArrayBuffer"==e.constructor.name&&(e=new Uint8Array(e)),n=String.fromCharCode.apply(null,e),decodeURIComponent(escape(n));var n}function o(e,n,t){var i=(e=unescape(encodeURIComponent(e))).length;t&&i++,n||(n=new ArrayBuffer(i));var o=new Uint8Array(n);t&&(o[e.length]=0);for(var r=0,s=e.length;r<s;r++)o[r]=e.charCodeAt(r);return n}window.IS_RELEASE=!0,function(){var e,n;try{n=!navigator}catch(e){n=!0}if(n)e=global;else{e=window,window.exports=window,window.chrome||(window.chrome={});var t={"node-fetch":window.fetch,wrtc:window},i=window.require;window.require=function(e){if(e.startsWith("."))return window;var n=t[e];return n||(i?i.apply(null,arguments):window)}}e.isNode=function(){return n}}();var r="\n".charCodeAt(0);function s(e,n,t){"Object"==n.constructor.name&&(n=JSON.stringify(n)),h(e,n+"\n",t)}function c(e,n){var t=[];!function o(){e.read(function(s){for(var c=0;c<s.byteLength;c++)if(s[c]==r){var a=s.subarray(0,c);t.push(a);var h="";for(var u in t)h+=i(u=t[u]);var l=s.subarray(c+1);return e.unshift(l),void n(h)}t.push(s),o()})}()}function a(e,n){var t="";e.onClose=function(){n(t)},e.read(function n(o){t+=i(o),e.read(n)})}function h(e,n,t){"Object"==n.constructor.name&&(n=JSON.stringify(n)),e.write(o(n),t)}function u(e,n){var t=new Uint8Array(e.byteLength+n.byteLength);return t.set(e,0),t.set(n,e.byteLength),t}Uint8Array.prototype.sliceArrayBuffer=function(){return this.buffer.slice(this.byteOffset,this.byteOffset+this.byteLength)},Number.prototype.pad=function(e){for(var n=String(this);n.length<(e||2);)n="0"+n;return n};(new Date).getTime();var l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",f="=";function d(e,n){n||(n=window.location);for(var t=n.search.substring(1).split("&"),i=0;i<t.length;i++){var o=t[i].split("=");if(decodeURIComponent(o[0])==e)return decodeURIComponent(o[1])}}String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,n){return n=n||0,this.lastIndexOf(e,n)===n}}),Object.fromArray=function(e){var n={};for(var t in e){var i=e[t];n[i]=i}return n};try{$.ajaxTransport("+binary",function(e,n,t){if(window.FormData&&(e.dataType&&"binary"==e.dataType||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob)))return{send:function(n,t){var i=new XMLHttpRequest,o=e.url,r=e.type,s=e.async||!0,c=e.responseType||"blob",a=e.data||null,h=e.username||null,u=e.password||null;for(var l in i.addEventListener("load",function(){var n={};n[e.dataType]=i.response,t(i.status,i.statusText,n,i.getAllResponseHeaders())}),i.addEventListener("error",function(){t(i.status,i.statusText,null,i.getAllResponseHeaders())}),i.open(r,o,s,h,u),n)i.setRequestHeader(l,n[l]);i.responseType=c,i.send(a)},abort:function(){t.abort()}}})}catch(e){}function v(e,n,t,i,o){if(e||(e={items:[]}),e.items.push(n),!e.timeout){function r(){delete e.timeout,i(e.items),e.items=[]}o&&r(e.items),e.timeout=setTimeout(r,t)}return e}function m(e,n){if(console.log("notification:",e),window.chrome&&window.chrome.notifications){var t=chrome.runtime.getManifest(),i=t.name;n=n||t.icons[128],chrome.notifications.create({type:"basic",iconUrl:n,title:i,message:e})}}var w,p,y,g,b,k,A=(w={},function(e,n){if(w[e])n(w[e]);else{var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="blob",t.onload=function(t){n(w[e]=window.URL.createObjectURL(this.response))},t.send()}});function S(){}function D(e,n){if(!window.chrome||!window.chrome.identity)return console.error("no auth token implemented"),void process.nextTick(n);chrome.identity.getAuthToken({interactive:e,scopes:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/chromewebstore.readonly"]},function(e){e||console.error("unable to get authToken",chrome.runtime.lastError),n(e)})}function U(e,n){this.promise=fetch(e).then(function(e){this.connected=!0,this.response=e,this.reader=this.response.body.getReader(),this.reader.closed.then(function(){this.onClose&&this.dataReceived(null)}.bind(this)),this.onResume(),n(this)}.bind(this),function(e){n(null,e)})}function O(e){e&&(this.dataReceived(e),this.dataReceived(null))}function C(e,n,t,i,r){i=function(e){for(var n=window.atob(e),t=n.length,i=new Uint8Array(t),o=0;o<t;o++){var r=n.charCodeAt(o);i[o]=r}return i.buffer}(i),t=o(t),window.crypto.subtle.importKey("jwk",{kty:"RSA",e:e,n:n,alg:"RS1"},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},!0,["verify"]).then(function(e){window.crypto.subtle.verify({name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},e,i,t).then(function(e){e?r():r("invalid signature")}).catch(function(e){r("failure to verify",e)})}).catch(function(e){r("key import failed",e)})}function T(){}function E(e,n,t){this.adbSocketFactory=e,this.conn=t,this.conn.openSocket=this.openSocket.bind(this);var i=n.properties.substring(n.properties.indexOf("product")).replace(/ /g,";").replace("device","ro.product.device").replace("model","ro.product.model").replace("product","ro.product.name").replace(/:/g,"=");this.properties="device::"+i+";"}function N(e,n){!function(e){chrome.storage.local.get("whitelist",function(n){var t={};n.whitelist&&"Array"==n.whitelist.constructor.name?($.each(n.whitelist,function(e,n){t[n]=!0}),e(t)):e(t)})}(function(t){t[e]=!0,function(e,n){chrome.storage.local.set({whitelist:Object.keys(e)},n)}(t,n)})}function I(e){return e?(e.friendlyName&&!e.friendlyName.length&&delete e.friendlyName,e):null}function B(e){window.chrome&&window.chrome.storage?chrome.storage.local.get("device-settings",function(n){e(n["device-settings"]||{})}):e({})}!function(){var e=function*(){}();e.constructor.prototype.async=function(){var n=this,t=n.next();if(!t.done){var i,o,r=new Promise(function(e,n){i=e,o=n});return a(),r}function s(){t=n.throw(new Error(arguments)),a()}function c(){var e=arguments[0];t=n.next(e),a()}function a(r){var a,h;if(t.done)i(t.value);else if(t.value)if(t.value.constructor!=Promise)if(t.value.constructor!=e.constructor){if(t.value==Error)a=!0,t=n.next(s);else{if(t.value!=S)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");h=!0,t=n.next(c)}if(!t.value)throw new Error("Double yield callbacks must explicitly define both Error and Success");if(t.value==Error&&a)throw new Error("Error callback already defined");if(t.value==S&&h)throw new Error("Success callback already defined");if(t.value!=Error&&t.value!=S)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");try{t=a?n.next(c):n.next(s)}catch(e){o(e)}}else t.value.async().then(c).catch(s);else t.value.then(c).catch(s);else t=n.next(c)}}}(),isNode()||(window.isElectron=function(){return-1!=navigator.userAgent.indexOf("Electron")},isElectron()||(window.sharedGlobals=window)),function(){if(!isNode()){var e="";if(window.IS_RELEASE){console.log,console.error,console.warn,console.info;function n(n){return function(){n.apply(console,arguments),function(n){try{for(var t in n)n[t]&&n[t].constructor!=String&&(n[t]=JSON.stringify(n[t]));e+=n.join(" ")+"\n"}catch(e){}}(Array.prototype.slice.call(arguments))}}console.error=n(console.error),console.log=n(console.log),console.warn=n(console.warn),console.info=n(console.info)}sharedGlobals.getConsoleLog=function(n){n(e)},window.gistConsoleLog=function(e,n){chrome.runtime.getBackgroundPage(function(i){t(i).then(function(n){e["background.txt"]=n;var i=chrome.app.window.getAll().map(function(n){return t(n.contentWindow).then(function(t){e["window-"+n.id+".txt"]=t})});return Promise.all(i)}).then(function(){var t={description:chrome.runtime.getManifest().name+" console log",public:!1,files:e};fetch("https://vysor.io/gist",{method:"POST",body:JSON.stringify(t)}).then(function(e){e.json().then(function(e){n(e.html_url)})})})})}}function t(e){return new Promise(function(n,t){e.getConsoleLog?e.getConsoleLog(function(e){n({content:e&&e.length?e:"log is empty"})}):n("getConsoleLog not found")})}}(),e.str2ab=o,e.ab2str=i,e.readString=a,e.readLine=c,e.writeString=h,function(){function e(e){this.buffer=new ArrayBuffer(e),this.dataView=new DataView(this.buffer),this.uint8array=new Uint8Array(this.buffer),this.littleEndian=!1,this.position=0,this.limit=e,this.capacity=e}function n(n,t){var i=n+8*t,o="get"+i,r="set"+i,s="put"+i;e.prototype[o]=function(){if(this.position+t>this.limit)throw new Error("Not enough room in byte buffer");var e=this.dataView[o](this.position,this.littleEndian);return this.position+=t,e},e.prototype[s]=function(e){if(this.position+t>this.limit)throw new Error("Not enough room in byte buffer");if(null==e||void 0==e||NaN==e||e.constructor!=Number)throw new Error("no value provided");return this.dataView[r](this.position,e,this.littleEndian),this.position+=t,this}}e.prototype.flip=function(){this.limit=this.position,this.position=0},e.prototype.asUint8Array=function(){return this.uint8array.subarray(this.position,this.limit)};var t={Int:[1,2,4],Uint:[1,2,4],Float:[4,8]};for(var i in t){var r=t[i];for(var s in r){n(i,s=r[s])}}e.prototype.put=function(e){if(e.constructor==Number)return this.putInt8(e);if(e.constructor==String&&(e=o(e)),e.constructor==ArrayBuffer&&(e=new Uint8Array(e)),this.position+e.byteLength>this.limit)throw new Error("Not enough room in byte buffer");return this.uint8array.set(e,this.position),this.position+=e.byteLength,this},e.prototype.putByte=e.prototype.putInt8,e.prototype.putShort=e.prototype.putInt16,e.prototype.putInt=e.prototype.putInt32,e.prototype.putFloat=e.prototype.putFloat32,e.prototype.putDouble=e.prototype.putFloat64,window.ByteBuffer=e}(),function(){try{var n=require("buffer").Buffer}catch(e){}function t(e,n){if(e.socketId)this.socketId=e.socketId,t.readers[this.socketId]=this;else if(chrome&&chrome.sockets)chrome.sockets.tcp.create(function(i){this.socketId=i.socketId,chrome.sockets.tcp.connect(this.socketId,e.host,e.port,function(e){e?(chrome.runtime.lastError,this.destroy(),n(null)):(t.readers[i.socketId]=this,n(this))}.bind(this))}.bind(this));else{var i;e.ns?(this.ns=e.ns,i=!0):(this.ns=new require("net").Socket(),this.ns.connect({port:e.port,host:e.host},function(){i=!0,n(this)}.bind(this))),this.ns.on("close",function(){this.destroy(),i||n(null)}.bind(this)),this.ns.on("data",function(e){this.dataReceived(e)}.bind(this))}}function i(){}chrome&&chrome.sockets&&(chrome.sockets.tcp.onReceive.addListener(function(e){var n=t.readers[e.socketId];null!=n&&n.dataReceived(new Uint8Array(e.data))}),chrome.sockets.tcp.onReceiveError.addListener(function(e){var n=t.readers[e.socketId];null!=n&&(n.destroy(),n.dataReceived(null))}),chrome.sockets.tcpServer.onAccept.addListener(function(e){chrome.sockets.tcp.setPaused(e.clientSocketId,!1);var n=i.listeners[e.socketId];null!=n&&n(new t({socketId:e.clientSocketId}))})),t.readers={},t.connect=function(e,n){return new t(e,n)},t.pump=function(e,n,t){if(!e||!n)return console.error("Socket.pump called with null socket",e,n),void t();var i=function(){e.read(o)}.bind(e),o=function(e){var t=e.buffer;(e.byteOffset||e.length!=t.byteLength)&&(t=t.slice(e.byteOffset,e.byteOffset+e.length)),n.write(t,i)}.bind(n);e.read(o),e.onClose=t},t.stream=function(e,n,i){t.pump(e,n,function(){if(n&&n.destroy(),i){var e=i;i=null,e()}}),t.pump(n,e,function(){if(e&&e.destroy(),i){var n=i;i=null,n()}})},t.eat=function(e){!function n(){e.read(n)}()},t.prototype.read=function(){if(this.pendingCallback)throw new Error("double callback");if(!this.closed||this.pending){var e=0;"Number"==arguments[e].constructor.name?this.pendingLength=arguments[e++]:this.pendingLength=0;a=arguments[e];if(this.pending&&!this.paused){if(this.pendingLength){if(this.pendingLength>this.buffered())return void(this.pendingCallback=a)}else this.pendingLength=this.buffered();for(var n,t=0;t<this.pendingLength;){var i=this.pending.shift();this.bufferedLength-=i.length,this.pending.length||delete this.pending;var o=i,r=Math.min(o.byteLength,this.pendingLength-t);if(r!=o.byteLength){var s=o.subarray(0,r),c=o.subarray(r);this.unshift(c),o=s}n||o.byteLength==this.pendingLength||(n=new Uint8Array(this.pendingLength)),n?n.set(o,t):n=o,t+=o.byteLength}a(n)}else this.pendingCallback=a}else{var a;(a=this.onClose)&&(delete this.onClose,a())}},t.prototype.write=function(e,t){if(this.pendingWrite)if(this.bufferWrites){null!=t&&console.error("using callbacks in buffered mode?");var i=this.pendingWrite;this.pendingWrite=function(){i&&i(),this.write(e,t)}.bind(this)}else console.error("write is already in progress!");if(null==t&&(this.bufferWrites||console.error("write callback is null?"),t=function(){}),this.pendingWrite=t,chrome&&chrome.sockets)chrome.sockets.tcp.send(this.socketId,e,function(n){chrome.runtime.lastError,n&&!n.resultCode?n.bytesSent<e.byteLength?this.write(e.slice(n.bytesSent),t):(delete this.pendingWrite,t()):delete this.pendingWrite}.bind(this));else{if(!this.ns)return;if(!e.byteLength)return void process.nextTick(function(){delete this.pendingWrite,t()}.bind(this));this.ns.write(n.from(e),function(){delete this.pendingWrite,t()}.bind(this))}},t.prototype.destroy=function(e,n){chrome&&chrome.sockets?chrome.sockets.tcp.close(this.socketId,function(){chrome.runtime.lastError}):(this.dataReceived(null),this.ns&&(this.ns.destroy(),delete this.ns))},t.prototype.unshift=function(e){0!=e.byteLength&&(this.pending?this.pending.unshift(e):this.pending=[e],this.bufferedLength||(this.bufferedLength=0),this.bufferedLength+=e.length)},t.prototype.dataReceived=function(e){if(e&&(e.asUint8Array&&(e=e.asUint8Array()),e.constructor==ArrayBuffer&&(e=new Uint8Array(e))),e&&e.length){var n=new Uint8Array(e);this.pending?this.pending.push(n):this.pending=[n]}if(null==e?this.closed=!0:(this.bufferedLength||(this.bufferedLength=0),this.bufferedLength+=e.length),!this.paused&&this.pending&&this.pending.length){var t=this.pendingLength;(i=this.pendingCallback)&&(delete this.pendingCallback,this.read(t,i))}else{var i=this.onClose;this.closed&&i&&(delete this.onClose,i())}},t.prototype.buffered=function(){return this.bufferedLength},t.prototype.pause=function(){this.paused||(this.paused=!0,this.onPause())},t.prototype.resume=function(){this.paused&&(this.paused=!1,this.onResume())},t.prototype.onResume=function(){chrome.sockets.tcp.setPaused(this.socketId,!1,function(){})},t.prototype.onPause=function(){chrome.sockets.tcp.setPaused(this.socketId,!0,function(){})},i.listeners={},i.prototype.__proto__=t.prototype,i.prototype.destroy=function(){chrome&&chrome.sockets?chrome.sockets.tcpServer.close(this.socketId,function(){chrome.runtime.lastError}):this.ns&&(this.ns.close(),delete this.ns)},i.prototype.listen=function(e,n,o){var r,s;"Number"==e.constructor.name?(r=e,s="0.0.0.0"):(s=e.address,r=e.port),chrome&&chrome.sockets?chrome.sockets.tcpServer.create(function(e){this.socketId=e.socketId,i.listeners[this.socketId]=n,chrome.sockets.tcpServer.listen(e.socketId,s,r,function(e){if(chrome.runtime.lastError,e)return this.destroy(),void(o&&o(e));chrome.sockets.tcpServer.getInfo(this.socketId,function(n){this.localAddress=n.localAddress,this.localPort=n.localPort,o&&o(e)}.bind(this))}.bind(this))}.bind(this)):(this.ns=require("net").createServer(function(e){n(new t({ns:e}))}.bind(this)),this.ns.on("close",function(){this.destroy()}.bind(this)),this.ns.on("error",function(e){o&&o(e)}.bind(this)),this.ns.on("listening",function(){var e=this.ns.address();this.localAddress=e.address,this.localPort=e.port,o&&o()}.bind(this)),this.ns.listen({port:r,host:s}))},e.Socket=t,e.Server=i}(),function(){function e(){}function n(e){this.request=e,this.statusLine="HTTP/1.1 200 OK",this.headers={Date:(new Date).toUTCString()}}function t(e,t,i){this.server=e,this.socket=t,this.headers={},this.parseRequest(function(){i(this,new n(this))}.bind(this))}e.prototype.listen=function(e,n,t){this.socket=new Server,this.requestCallback=n,this.socket.listen(e,this.onSocket.bind(this),t)},e.prototype.onSocket=function(e){new t(this,e,this.requestCallback)},e.prototype.destroy=function(){this.socket.destroy()},n.prototype.code=function(e){this.statusLine="HTTP/1.1 "+e+" "+HttpResponseCodes[e]},n.prototype.write=function(e,n){if(e.constructor.name==Object.prototype.constructor.name&&(e=JSON.stringify(e)),e.constructor.name==String.prototype.constructor.name&&(e=o(e)),this.hasWritten)this.request.socket.write(e,n);else{this.hasWritten=!0,this.headers["Content-Length"]||"close"==this.headers.Connection||(this.headers["Content-Length"]=e.byteLength);var t=[this.statusLine];for(var i in this.headers)t.push(i+": "+this.headers[i]);var r=t.join("\r\n")+"\r\n\r\n";this.request.socket.write(o(r),function(){this.write(e,n)}.bind(this))}},n.prototype.end=function(){"close"==this.headers.Connection?this.request.socket.destroy():this.request.server.onSocket(this.request.socket),this.request.socket=null},t.prototype.parseRequest=function(e){var n=function(){c(this.socket,function(t){if(!(t=t.trim()).length){var o=this.headers["content-length"];return o?(o=Number.parseInt(o),void this.socket.read(o,function(n){this.body=n,"application/json"===this.headers["content-type"]&&(this.body=JSON.parse(i(this.body))),e()}.bind(this))):void e()}var r;if(this.statusLine)2==(r=t.split(":",2)).length&&(this.headers[r[0].toLowerCase()]=r[1].trim());else if(this.statusLine=t,(r=t.split(" ")).length>2&&(r=r[1].split("?"),this.path=r[0],this.queries={},r.length>1))for(var s=(this.query=r[1]).split("&"),c=0;c<s.length;c++){var a,h=s[c].split("="),u=h[0];h.length>1&&(a=h[1]),this.queries[u]=a}n()}.bind(this))}.bind(this);n()},window.HttpRequestParser=t,window.HttpServer=e,window.HttpResponseCodes={200:"OK",202:"Accepted",206:"Partial Content",101:"Switching Protocols",301:"Moved Permanently",302:"Found",402:"Payment Required",404:"Not Found"}}(),function(){var n,t=require("wrtc"),i=t.RTCSessionDescription||t.webkitRTCSessionDescription,o=t.RTCPeerConnection||t.webkitRTCPeerConnection,r=t.RTCIceCandidate||t.webkitRTCIceCandidate,s=require("./socket").Socket,c=require("node-fetch"),{str2ab:a,ab2str:h}=require("../base/util");function u(e,n){this.conn=e,this.dc=n,this.gotEof=!1,n.onmessage=function(e){var n=new Uint8Array(e.data),t=1==n[n.byteLength-1];this.dataReceived(n.subarray(0,n.byteLength-1)),t&&(this.gotEof=!0,this.destroy())}.bind(this),n.onclose=n.onerror=this.destroy.bind(this),this.needsBufferShim=isNode()||parseInt(/Chrome\/(\d\d)/.exec(navigator.userAgent)[1])<70,this.needsBufferShim||(n.bufferedAmountLowThreshold=0,n.onbufferedamountlow=this.writeable.bind(this))}function l(e,n,t){this.manager=e,this.peerConnection=n,this.key=t,this.peerConnection.oniceconnectionstatechange=function(){"disconnected"!=this.peerConnection.iceConnectionState&&"closed"!=this.peerConnection.iceConnectionState&&"failed"!=this.peerConnection.iceConnectionState||this.destroy()}.bind(this)}function f(e,n,t){this.senders=e,this.registrationId=n,this.rtcc=t,this.gcmRtcConnections={},this.gcmRtcListeners={},this.amazonTokens={}}u.prototype.buffered=s.prototype.buffered,u.prototype.unshift=s.prototype.unshift,u.prototype.dataReceived=s.prototype.dataReceived,u.prototype.read=s.prototype.read,u.prototype.pause=s.prototype.pause,u.prototype.resume=s.prototype.resume,u.prototype.buffered=s.prototype.buffered,u.prototype.writeable=function(){var e=this.writeCallback;e&&(delete this.writeCallback,e())},u.prototype.write=function(e,n){if(this.dc&&"open"==this.dc.readyState){this.writeCallback=n;var t=new Uint8Array(e.byteLength+1);if(t.set(new Uint8Array(e)),this.dc.send(t.buffer),!this.reentrantWrite)try{for(this.reentrantWrite=!0;this.writeCallback&&(0==this.dc.bufferedAmount||this.needsBufferShim);)this.writeable();this.writeCallback&&console.log("waiting for writable")}finally{this.reentrantWrite=!1}}else this.destroy()},u.prototype.destroy=function(){if(this.dataReceived(null),null!=this.dc){var e=this.dc;if(this.dc=null,e.onclose=null,e.onerror=null,"open"==e.readyState)try{e.send(new Uint8Array([1])),this.gotEof?this.conn.recycleChannel(e):this.conn.waitForEof(e)}catch(e){}}},l.prototype.waitForCommand=function(e){e.onmessage=function(n){if(1!=n.data.byteLength){this.removeChannel(e);var t=h(n.data),i=new u(this,e);this.openSocket(t,i)}}.bind(this)},l.prototype.compactChannels=function(){this.inboundChannels&&!this.inboundChannels.length&&(this.inboundChannels=null),this.outboundChannels&&!this.outboundChannels.length&&(this.outboundChannels=null)},l.prototype.getAppropriateChannels=function(e,n){var t;return e.inbound?(!this.inboundChannels&&n&&(this.inboundChannels=[]),t=this.inboundChannels):(!this.outboundChannels&&n&&(this.outboundChannels=[]),t=this.outboundChannels),t},l.prototype.removeChannel=function(e){if(channels=this.getAppropriateChannels(e),channels){var n=channels.indexOf(e);-1!=n&&(channels.splice(n,1),this.compactChannels())}},l.prototype.waitForEof=function(e){e.onmessage=function(n){var t=new Uint8Array(n.data);1==t[t.byteLength-1]&&this.recycleChannel(e)}.bind(this)},l.prototype.recycleChannel=function(e){this.getAppropriateChannels(e,!0).push(e),e.onclose=e.onerror=function(){this.removeChannel(e)}.bind(this),this.waitForCommand(e)},l.prototype.addCandidates=function(e){for(var n in e.candidates)console.log("remote candidate",e.candidates[n]),this.peerConnection.addIceCandidate(new r(e.candidates[n]))},l.prototype.setupPinger=function(e){var n;e.onmessage=function(e){},e.onclose=e.onerror=function(){clearTimeout(n),this.destroy()}.bind(this),function t(){e.send(a("ping")),n=setTimeout(t,1e3)}()},l.prototype.listenSockets=function(){this.peerConnection.ondatachannel=function(e){e.channel.inbound=!0,this.waitForCommand(e.channel)}.bind(this)},l.prototype.prepareChannel=function(e){var n=this.peerConnection.createDataChannel(e||"gcm",{ordered:!0});return n.binaryType="arraybuffer",n},l.prototype.newSocket=function(e,n){if("closed"!=this.peerConnection.signalingState)if(this.outboundChannels){var t=this.outboundChannels.shift();this.compactChannels(),t.send(a(e));var i=new u(this,t);n(i,this)}else{var o;(t=this.prepareChannel("gcm")).onopen=function(){if(!o){o=!0,t.send(a(e));var i=new u(this,t);n(i,this)}}.bind(this),"open"==t.readyState&&t.onopen()}else n()},l.prototype.destroy=function(){delete this.manager.gcmRtcConnections[this.key],"closed"!=this.peerConnection.signalingState&&this.peerConnection.close();var e=this.onClose;e&&(delete this.onClose,e())},f.prototype.onMessage=function(e){var n=JSON.parse(e.message),t=e.type,i=e.senderId,o=e.src,r=e.srcPort,s=e.dst||this.registrationId,c=e.dstPort;if("offer"!=t){if("answer"==t){var a=f.getKey(o,r,c),h=this.gcmRtcConnections[a];return h?void h.manager.incoming(i,o,r,s,c,n):(console.error("pending connection not found"),void console.error(e))}f.onUnknownMessage?f.onUnknownMessage(e):console.log("unknown message "+t)}else{var u=this.gcmRtcListeners[c];u?u.listener.incoming(i,o,r,s,c,n,u.listenCallback):console.log("not listening on "+c)}},f.hasLoadedChannels=!1,f.start=function(e,n,t){if(console.log("starting GtcRtcManger"),chrome&&chrome.gcm){var i=Object.keys(e);chrome.gcm.register(i,function(i){if(chrome.runtime.lastError,i){var o=new f(e,i,n);chrome.gcm.onMessage.addListener(function(e){o.onMessage(e.data)}),t(o)}else t()})}else{function o(e){var n=e("https://push.clockworkmod.com");n.on("registration",function(e){e="web:"+e,r.registrationId?(r.registrationId=e,r.onRegistrationIdChanged&&r.onRegistrationIdChanged(e)):(r.registrationId=e,t(r))}),n.on("data",function(e){r.onMessage(e)})}var r=new f(e,null,n);if(isNode())o(require("socket.io-client"));else{s="https://push.clockworkmod.com/socket.io/socket.io.js",c=function(){o(io)},a=document.createElement("script"),h=document.getElementsByTagName("script")[0],a.async=1,a.onload=a.onreadystatechange=function(e,n){(n||!a.readyState||/loaded|complete/.test(a.readyState))&&(a.onload=a.onreadystatechange=null,a=void 0,n||c&&c())},a.src=s,h.parentNode.insertBefore(a,h)}}var s,c,a,h},f.prototype.wrapMessage=function(e,n,t,i,o,r,s){return{senderId:e,src:i,srcPort:o,dst:n,dstPort:t,type:r,message:JSON.stringify(s)}},f.prototype.sendGcm=function(e,n,t,i,o,r,s){var c=this.wrapMessage(e,n,t,i,o,r,s);return this.sendWrappedMessage(e,n,c)},f.prototype.sendWrappedMessage=function(e,n,t){if(e||(e=this.defaultSenderId),n.startsWith("web:"))return c(n.substring(4),{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).then(e=>e.json());if(n.startsWith("amzn")){var i;if(!this.amazonTokens[e]||this.amazonTokens[e].accessTokenExpiration<Date.now()){var o=this.senders[e];console.log(e,o);var r={grant_type:"client_credentials",scope:"messaging:push",client_id:e,client_secret:o},s=Object.entries(r).map(([e,n])=>`${encodeURIComponent(e)}=${encodeURIComponent(n)}`).join("&");i=c("https://api.amazon.com/auth/O2/token",{method:"POST",body:s,headers:{"Content-type":"application/x-www-form-urlencoded;charset=UTF-8"}}).then(e=>e.json()).then(n=>(this.amazonTokens[e]={},this.amazonTokens[e].accessToken=n.access_token,this.amazonTokens[e].accessTokenExpiration=Date.now()+n.expires_in-30,n.access_token))}else console.log("token valid for",this.amazonTokens[e].accessTokenExpiration-Date.now()),i=Promise.resolve(this.amazonTokens[e].accessToken);return i.then(e=>c(`https://api.amazon.com/messaging/registrations/${n}/messages`,{method:"POST",body:JSON.stringify({data:t}),headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${e}`,"X-Amzn-Type-Version":"com.amazon.device.messaging.ADMMessage@1.0","X-Amzn-Accept-Type":"com.amazon.device.messaging.ADMSendResult@1.0"}}).then(e=>e.json()))}return c("https://fcm.googleapis.com/fcm/send",{method:"POST",body:JSON.stringify({to:n,data:t}),headers:{"Content-Type":"application/json",Authorization:"key="+this.senders[e]}}).then(e=>e.json())},f.getKey=function(e,n,t){return t+":"+n+":"+e},f.dictionaryKeys="0 1 2 3 4 5 6 7 8 9 a b c d e f g h i j k l m n o p q r s t u v w x y z".split(" "),f.sdpDictionary={},f.addDictionary=function(e){var n=f.dictionaryKeys[Object.keys(f.sdpDictionary).length];f.sdpDictionary[n]=e},f.replaceAll=function(e,n,t){n=n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");var i=new RegExp(n,"g");return e.replace(i,t)},f.compressSdp=function(e){for(var n in e=e.replace("\\","\\\\"),f.sdpDictionary){var t=f.sdpDictionary[n];e=f.replaceAll(e,t,"\\"+n)}return e},f.decompressSdp=function(e){for(var n in f.sdpDictionary){var t=f.sdpDictionary[n];e=e.replace(new RegExp(`([^\\\\])\\\\${n}`,"g"),"$1"+t)}return e},(n=f.addDictionary)("a=rtpmap:"),n("a=extmap:"),n("a=rtcp-fb:"),n("a=fmtp:"),n("level-asymmetry-allowed="),n("packetization-mode="),n("profile-level-id="),n("90000"),n("rtx/90000"),n("H264/90000"),n("transport-cc"),n("x-google-profile-id"),n("nack pli"),n("goog-remb"),n("ccm fir"),n("telephone-event/"),n("http://www.webrtc.org/experiments/rtp-hdrext/"),n("urn:ietf:params:rtp-hdrext:toffset"),n("http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"),n("urn:3gpp:video-orientation"),n("http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"),n("http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"),n("http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"),n("http://www.webrtc.org/experiments/rtp-hdrext/video-timing"),n("http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"),f.prototype.setupPeerConnection=function(e,n,t,i,r,s,c){var a,h=new o(this.rtcc),u=function(o){var a,h=[],u=c(),l=(u.sdp,{type:u.type,sdp:f.compressSdp(u.sdp)}),d=JSON.stringify(l).length;for(var v in o)null!=(v=o[v])&&(h.push(v),d+JSON.stringify(h).length>3200&&(a=!0,this.sendGcm(n,t,i,r,s,e,{desc:l,candidates:h}),h=[]));(h.length>0||!a)&&this.sendGcm(n,t,i,r,s,e,{desc:l,candidates:h})}.bind(this);h.onicecandidate=function(e){e.candidate?(console.log("candidate",e.candidate),a=function(e,n,t,i,o){if(e||(e={items:[]}),e.items.push(n),!e.timeout){function r(){delete e.timeout,i(e.items),e.items=[]}o&&r(e.items),e.timeout=setTimeout(r,t)}return e}(a,e.candidate,500,u)):console.log("done sending ice candidates")}.bind(this);var d=f.getKey(t,i,s),v=new l(this,h,d);return v.sendConnect=u,h.onsignalingstatechange=function(e){"stable"==h.signalingState?this.gcmRtcConnections[d]:"closed"==h.signalingState&&v.destroy()}.bind(this),this.gcmRtcConnections[d]=v,v},f.prototype.connect=function(e){return new Promise((n,t)=>{var i=e.senderId,o=e.registrationId,r=e.port;if(!o)throw new Error("registrationId was null on connect");var s,c=Math.random().toString(16),a=this.setupPeerConnection("offer",i,o,r,this.registrationId,c,function(){return s}),h=a.peerConnection;try{-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome")&&e.offerToReceiveAudio&&e.offerToReceiveVideo&&(h.addTransceiver("audio"),h.addTransceiver("video"))}catch(e){}var u=setTimeout(function(){a.destroy(),t(new Error("Timeout waiting for RTC Connection"))},3e4);function l(e){h.createOffer(e).then(function(e){s=e,console.log(e),h.setLocalDescription(e),a.sendConnect([])})}if(e.offerToReceiveAudio||e.offerToReceiveVideo||e.audio){function f(){h.ontrack=function(e){console.log("got the remote stream"),clearTimeout(u),n(a)},l({offerToReceiveAudio:!!e.offerToReceiveAudio,offerToReceiveVideo:!!e.offerToReceiveVideo,voiceActivityDetection:!1})}if(!e.audio)return void f();navigator.webkitGetUserMedia({audio:!0,video:!1},function(e){h.addStream(e),f()},function(){console.error("audio fail",arguments),f()})}else{var d=a.prepareChannel("pinger");d.onopen=function(){console.log("got rtc pinger"),a.setupPinger(d),clearTimeout(u),n(a)},a.listenSockets(),l({})}})},f.prototype.isListening=function(e){return null!=this.gcmRtcListeners[e]},f.prototype.stopListen=function(e){delete this.gcmRtcListeners[e]},f.prototype.listen=function(e,n){this.gcmRtcListeners[e]?console.log("already listening on gcm port "+e):this.gcmRtcListeners[e]={listener:this,listenCallback:n}},f.prototype.incoming=function(e,n,t,o,r,s,c){var a=f.getKey(n,t,r),h=this.gcmRtcConnections[a];if(h){if(!h.remoteDesc){d=s.desc.sdp;s.desc.sdp=f.decompressSdp(d),h.remoteDesc=new i(s.desc),(l=h.peerConnection).setRemoteDescription(h.remoteDesc)}}else{if(!n)return void console.warn("received null registraition on incoming message. ignoring");var u;h=this.setupPeerConnection("answer",e,n,t,o,r,function(){return u});var l,d=s.desc.sdp;s.desc.sdp=f.decompressSdp(d),h.remoteDesc=new i(s.desc),(l=h.peerConnection).ondatachannel=function(e){console.log("got rtc pinger"),this.setupPinger(e.channel),c(h),this.listenSockets()}.bind(h),l.setRemoteDescription(h.remoteDesc,function(){l.createAnswer().then(function(e){u=e,l.setLocalDescription(e)},function(){console.error("answer error",arguments)})})}h.addCandidates(s)},e.GcmRtcSocket=u,e.GcmRtcManager=f}(),U.connect=function(e,n){new U(e,n)},U.prototype.write=function(e,n){throw new Error("write not supported on fetch socket")},U.prototype.destroy=function(){this.promise&&this.promise.cancel&&this.promise.cancel()},U.prototype.unshift=Socket.prototype.unshift,U.prototype.dataReceived=Socket.prototype.dataReceived,U.prototype.read=Socket.prototype.read,U.prototype.pause=Socket.prototype.pause,U.prototype.resume=Socket.prototype.resume,U.prototype.buffered=Socket.prototype.buffered,U.prototype.onPause=function(){},U.prototype.onResume=function(){this.reader.read().then(function(e){e.value&&(this.dataReceived(e.value),this.paused||this.onResume())}.bind(this))},O.prototype.write=function(e,n){throw new Error("write not supported on dummy socket")},O.prototype.destroy=function(){this.dataReceived(null)},O.prototype.buffered=Socket.prototype.buffered,O.prototype.unshift=Socket.prototype.unshift,O.prototype.dataReceived=Socket.prototype.dataReceived,O.prototype.read=Socket.prototype.read,O.prototype.pause=Socket.prototype.pause,O.prototype.resume=Socket.prototype.resume,O.prototype.buffered=Socket.prototype.buffered,O.prototype.onPause=function(){},O.prototype.onResume=function(){},function(){function e(e,n){for(var t in this.handle=e,this.iface=n,this.type="usb",n.endpoints)"bulk"==(t=n.endpoints[t]).type&&(this.zero_mask=t.maximumPacketSize-1,"in"==t.direction?this.in=t:this.out=t)}function n(e){this.socket=e,this.zero_mask=(1<<30)-1,this.type="tcp",e.onClose=function(){var e=this.currentRead;e&&(delete this.currentRead,e({resultCode:-1}))}.bind(this)}function r(e,n){this.onConnected=n,this.transport=e,this.currentSocketId=0,this.sockets={},this.forwards={},this.maxPayload=r.MAX_PAYLOAD}function s(e){var n={};"String"!=e.constructor.name&&(e=i(e));var t=e.replace("device::","").split(";");for(var o in t){var r=(o=t[o]).split("=");2==r.length&&(n[r[0]]=r[1])}return n}function c(e,n,t){t||(t=function(){}),this.device=e,this.localId=n,this.onConnected=t}function h(e){var n=(e=e||{}).port||5037,t=!1!==e.start;this.currentSocketId=1,this.pendingDevices={},this.port=n,this.adbDevices={},this.clients={},t&&this.start()}function d(){return(new Date).getTime()}function v(e,n){this.server=e,this.socket=n}e.prototype.destroy=function(){chrome.usb.releaseInterface(this.handle,this.iface.interfaceNumber,function(){chrome.runtime.lastError,chrome.usb.closeDevice(this.handle,function(){chrome.runtime.lastError})}.bind(this))},e.prototype.write=function(e,n){if(this.writing)return this.pendingWrites||(this.pendingWrites=[]),void this.pendingWrites.push({data:e,callback:n});var t={direction:"out",endpoint:this.out.address,data:e};this.writing=!0,chrome.usb.bulkTransfer(this.handle,t,function(e){if(chrome.runtime.lastError,this.writing=!1,n(e),this.pendingWrites){var t=this.pendingWrites.shift();this.pendingWrites.length||(this.pendingWrites=null),this.write(t.data,t.callback)}}.bind(this))},e.prototype.read=function(e,n){var t={direction:"in",endpoint:this.in.address,length:e};chrome.usb.bulkTransfer(this.handle,t,function(e){chrome.runtime.lastError,n(e)})},n.prototype.destroy=function(){this.socket.destroy()},n.prototype.write=function(e,n){if(this.writing)return this.pendingWrites||(this.pendingWrites=[]),void this.pendingWrites.push({data:e,callback:n});this.writing=!0,this.socket.write(e,function(){if(this.writing=!1,n({resultCode:0}),this.pendingWrites){var e=this.pendingWrites.shift();this.pendingWrites.length||(this.pendingWrites=null),this.write(e.data,e.callback)}}.bind(this))},n.prototype.read=function(e,n){this.currentRead=n,this.socket.read(e,function(e){delete this.currentRead,n({resultCode:0,data:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)})})},r.prototype.fatal=function(e){console.log("fatal error",JSON.stringify(e));var n=this.onConnected;n?(delete this.onConnected,n()):this.onError&&(this.onError(),delete this.onError),this.destroy()},r.prototype.destroy=function(){for(var e in this.sockets)(e=this.sockets[e]).dataReceived(null);this.forwards&&$.each(this.forwards,function(e,n){n.destroy()}),this.transport.destroy()},r.kCommandSYNC=1129208147,r.kCommandCNXN=1314410051,r.kCommandOPEN=1313165391,r.kCommandOKAY=1497451343,r.kCommandCLSE=1163086915,r.kCommandWRTE=1163154007,r.kCommandAUTH=1213486401,r.kAuthToken=1,r.kAuthSignature=2,r.kAuthRSAPublicKey=3,r.ADB_PROTOCOL_VERSION=16777216,r.ADB_VERSION=40,r.MAX_PAYLOAD=4096,r.checksum=function(e){e=new Uint8Array(e);for(var n=0,t=0;t<e.byteLength;t++)n+=e[t];return 4294967295&n},r.prototype.sendMessage=function(e,n,t,i,s){i||(i=""),"String"==i.constructor.name&&(i=o(i));var c=!0;i.byteLength||(c=!1),e==r.kCommandAUTH&&n==r.kAuthSignature&&(c=!1),e==r.kCommandWRTE&&(c=!1);var a=i.byteLength;if(c&&a++,c){var h=new ArrayBuffer(i.byteLength+1);(u=new Uint8Array(h)).set(new Uint8Array(i)),u[h.byteLength-1]=0,i=h}var u,l=new ArrayBuffer(24);(u=new DataView(l)).setUint32(0,e,!0),u.setUint32(4,n,!0),u.setUint32(8,t,!0),u.setUint32(12,a,!0),u.setUint32(16,r.checksum(i),!0),u.setUint32(20,4294967295^e,!0),this.transport.write(l,function(e){e.resultCode&&this.fatal(e),!i.byteLength&&s&&s()}.bind(this)),i.byteLength&&this.transport.write(i,function(e){e.resultCode&&this.fatal(e),s&&s()}.bind(this))},r.prototype.getKey=function(e){chrome.storage.local.get("adbkey",function(n){var t=n.adbkey,i=new JSEncrypt({default_key_size:2048});t?i.setPrivateKey(t):(t=i.getPrivateKeyB64(),i.setPrivateKey(t),chrome.storage.local.set({adbkey:t})),e(i)})},r.prototype._convertToMinCrypt=function(e){var n=BigInteger.ONE.shiftLeft(32),t=e.n.clone(),i=BigInteger.ONE.shiftLeft(1).pow(2048),o=i.multiply(i).mod(t),r=new Uint32Array(131);r[0]=64,r[1]=n.subtract(t.modInverse(n)).intValue();for(var s=2,c=66;s<66;++s,++c)r[s]=t.mod(n).intValue(),t=t.divide(n),r[c]=o.mod(n).intValue(),o=o.divide(n);r[r.length-1]=e.e;var a="",h=new Uint8Array(r.buffer);for(s=0;s<h.length;++s){var u=h[s].toString(16);1==u.length&&(a+="0"),a+=u}return function(e){var n,t,i="";for(n=0;n+3<=e.length;n+=3)t=parseInt(e.substring(n,n+3),16),i+=l.charAt(t>>6)+l.charAt(63&t);for(n+1==e.length?(t=parseInt(e.substring(n,n+1),16),i+=l.charAt(t<<2)):n+2==e.length&&(t=parseInt(e.substring(n,n+2),16),i+=l.charAt(t>>2)+l.charAt((3&t)<<4));(3&i.length)>0;)i+=f;return i}(a)+" adb@chrome"},r.prototype.sign=function(e,n){if(null==e)throw"AuthManager is not initialized";var t=new Uint8Array(256);t[0]=0,t[1]=1;for(var i=[0,48,33,48,9,6,5,43,14,3,2,26,5,0,4,20],o=256-i.length-n.byteLength,r=2;r<o;r++)t[r]=255;t.set(new Uint8Array(i),o),o+=i.length,t.set(new Uint8Array(n),o);var s=new BigInteger(Array.apply([],t));return new Uint8Array(e.doPrivate(s).toByteArray()).buffer},r.parseConnectionPayload=s,r.prototype.handleUnknown=function(e,n){console.log("no idea what this socket is."),this.sendMessage(r.kCommandCLSE,e,n)},r.prototype.handleMessage=function(e,n){var t=e.getUint32(0,!0),o=e.getUint32(4,!0),c=e.getUint32(8,!0);e.getUint32(12,!0),e.getUint32(16,!0);switch(t){case r.kCommandOPEN:this.onOpenSocket&&this.onOpenSocket(n,o);break;case r.kCommandAUTH:console.log("auth:",this),this.getKey(function(e){if(this.sentSignature){var t=this._convertToMinCrypt(e.getKey());this.sendMessage(r.kCommandAUTH,r.kAuthRSAPublicKey,0,t),m('Check your Android device and click "Allow USB Debugging".')}else{this.sentSignature=!0;var i=this.sign(e.getKey(),n);this.sendMessage(r.kCommandAUTH,r.kAuthSignature,0,i,function(){})}}.bind(this));break;case r.kCommandOKAY:var a=o,h=c;if(!(l=this.sockets[h]))return void this.handleUnknown(h,a);(f=l.onConnected)&&(delete l.onConnected,l.remoteId=a,f(l));var u=l.pendingWrite;if(u)return f=l.wrote,delete l.wrote,delete l.pendingWrite,void l.write(u,f);(f=l.wrote)&&(delete l.wrote,f());break;case r.kCommandCNXN:this.rawProperties=i(n),this.properties=s(n),(f=this.onConnected)&&(delete this.onConnected,f(this));break;case r.kCommandWRTE:a=o,h=c;if(!(l=this.sockets[h]))return void this.handleUnknown(h,a);l.paused||this.sendMessage(r.kCommandOKAY,l.localId,l.remoteId),l.dataReceived(new Uint8Array(n));break;case r.kCommandCLSE:var l,f;a=o,h=c;if(!(l=this.sockets[h]))return void console.log("asked to close unknown socket?");delete this.sockets[h],l.destroy(),(f=l.onConnected)&&(delete l.onConnected,f());break;default:console.log("unknown command: ",t.toString(16),o,c,n)}},r.prototype.onReceiveMessage=function(e){if(e.resultCode)this.fatal(e);else{var n=new DataView(e.data),t=n.getUint32(12,!0);if(t)this.transport.read(t,function(e){if(e.resultCode)this.fatal(e);else{var t=e.data;if(r.checksum(t)==n.getUint32(16,!0))try{this.handleMessage(n,t)}finally{this.receiveMessages()}else this.receiveMessages()}}.bind(this));else try{this.handleMessage(n,null)}finally{this.receiveMessages()}}},r.prototype.receiveMessages=function(){this.transport.read(24,this.onReceiveMessage.bind(this))},r.prototype.forwardPort=function(e){var n=new Server;n.listen({port:e.fromPort,address:"127.0.0.1"},function(n){this.newSocket(e.to,function(e){e?Socket.stream(n,e):n.destroy()}.bind(this))}.bind(this),function(){this.forwards[e.fromPort]=n}.bind(this))},r.prototype.newAdbSocket=function(e,n){return this.createSocket?this.createSocket(e,n):new c(this,e,n)},r.prototype.newSocket=function(e,n){var t=++this.currentSocketId;this.sockets[t]=this.newAdbSocket(t,n),this.sendMessage(r.kCommandOPEN,t,0,e)},c.prototype.write=function(e,n){if(this.pendingWrite||this.wrote)throw console.log("bad adb socket state, already writing"),new Error("bad adb socket state, already writing");var t=Math.min(this.device.transport.zero_mask,this.device.maxPayload);t<e.byteLength?(this.pendingWrite=e.slice(t),e=e.slice(0,t)):this.pendingWrite=null,this.wrote=n,this.device.sendMessage(r.kCommandWRTE,this.localId,this.remoteId,e)},c.prototype.destroy=function(){this.device.sendMessage(r.kCommandCLSE,this.localId,this.remoteId),this.dataReceived(null)},c.prototype.buffered=Socket.prototype.buffered,c.prototype.dataReceived=Socket.prototype.dataReceived,c.prototype.read=Socket.prototype.read,c.prototype.pause=Socket.prototype.pause,c.prototype.resume=Socket.prototype.resume,c.prototype.unshift=Socket.prototype.unshift,c.prototype.onPause=function(){},c.prototype.onResume=function(){this.device.sendMessage(r.kCommandOKAY,this.localId,this.remoteId)},h.prototype.onOpenSocket=function(e,n){var t=this,o=i(e).split(":"),s=Number.parseInt(o[1]);Socket.connect({host:"127.0.0.1",port:s},function(e){if(e){var i=++t.currentSocketId,o=t.newAdbSocket(i);o.remoteId=n,t.sockets[i]=o,t.sendMessage(r.kCommandOKAY,i,n),Socket.stream(e,o)}else t.sendMessage(r.kCommandOKAY,0,n)})},h.prototype.start=function(){if(this.server)console.log("ADB Server started while already started");else{this.clients={},this.adbDevices={},this.pendingDevices={},this.refreshing={};var e=new Server;e.listen({port:this.port,address:"127.0.0.1"},function(e){var n=new v(this,e),t=++this.currentSocketId;this.clients[t]=n,e.onClose=function(){delete this.clients[t]}.bind(this),n.receiveHeader()}.bind(this),function(n){n?console.log("adb server failed to listen: "+n):(console.log("ADB Server started"),this.server=e,this.refresh())}.bind(this))}},h.prototype.isRunning=function(){return null!=this.server},h.prototype.kill=function(){for(var e in this.server.destroy(),this.server=null,this.refreshing={},this.clients)(e=this.clients[e]).socket.destroy();for(var n in this.clients={},this.adbDevices)(n=this.adbDevices[n]).destroy();this.adbDevices={},this.pendingDevices={}},h.prototype.selectDevice=function(e){chrome.usb.getUserSelectedDevices({filters:[{interfaceClass:255,interfaceSubclass:66,interfaceProtocol:1}]},function(n){for(var t in n)t=n[t],this.refreshDevice(t,e)}.bind(this))},h.prototype.withAdbDevice=function(e,n){e.onError=function(){delete this.adbDevices[e.serialno],this.internalOnDevicesChanged()}.bind(this);var t=function(t){e.serialno=t.trim(),this.adbDevices[e.serialno]=e,console.log("found device: "+e.serialno),this.internalOnDevicesChanged(),n(e)}.bind(this);e.serialno?t(e.serialno):e.newSocket("shell:getprop ro.serialno",function(e){a(e,function(e){t(e)}.bind(this))}.bind(this))},h.prototype.tryDevice=function(n,t,i){this.adbDevices;var o=this.pendingDevices,s=this;function c(c){var a=c.interfaceNumber;return!o[a]&&(o[a]=n,console.log("claiming:",JSON.stringify(n),JSON.stringify(c)),chrome.usb.claimInterface(n,c.interfaceNumber,function(){console.log("claimed:",JSON.stringify(chrome.runtime.lastError)),function(n,t,i){console.log("connecting");var o=new r(new e(n,t),i);console.log("sending CNXN"),o.sendMessage(r.kCommandCNXN,r.ADB_PROTOCOL_VERSION,r.MAX_PAYLOAD,"host::"),console.log("starting receive loop"),o.receiveMessages()}(n,c,function(e){if(!e)return delete o[a],void i();e.serialno=t,e.onOpenSocket=s.onOpenSocket,s.withAdbDevice(e,function(e){delete o[a],i(e)})})}),!0)}chrome.usb.listInterfaces(n,function(e){if(!e)return console.log("unable list interfaces",JSON.stringify(chrome.runtime.lastError)),void(i&&i());console.log("got interfaces",JSON.stringify(e));var t=!1;for(var o in e)255==(o=e[o]).interfaceClass&&66==o.interfaceSubclass&&1==o.interfaceProtocol&&(t|=c(o));t||chrome.usb.closeDevice(n)})},h.prototype.refreshDevice=function(e,n){chrome.usb.openDevice(e,function(t){if(!t)return console.log("unable to open device",JSON.stringify(chrome.runtime.lastError)),void(n&&n());this.start(),this.tryDevice(t,e.serialNumber,function(t){t&&(t.usbDevice=e),n(t)})}.bind(this))},h.prototype.refresh=function(){if(this.server){var e=d();if(!(this.server.lastRefresh&&this.server.lastRefresh>e-1e4)){this.server.lastRefresh=e;var n=chrome.runtime.getManifest().permissions.pop().usbDevices;$(n).each(function(e,n){var t=n.vendorId+"&"+n.productId;this.refreshing[t]||(this.refreshing[t]=!0,chrome.usb.findDevices({productId:n.productId,vendorId:n.vendorId},function(e){var i=e.length;if(i)for(var o in console.log("found:",n,e),e)console.log("trying:",e[o]),this.tryDevice(e[o],e[o].serialNumber,function(){--i||delete this.refreshing[t]}.bind(this));else delete this.refreshing[t]}.bind(this)))}.bind(this))}}else console.log("adb server refresh requested while server killed")},h.prototype.internalOnDevicesChanged=function(){for(var e in this.clients)if((e=this.clients[e]).tracking){var n=e.getDevicesString();n.length||(n="0000\n"),e.socket.write(o(n),function(){})}},h.prototype.stop=function(){this.server.destroy()},v.prototype.resolveTransport=function(e,n){if(n){var t=this.server.adbDevices[n];return t||"device not found"}var i=Object.keys(this.server.adbDevices);if(i>1)return"more than one device";if(0==i)return"no devices connected";for(var o in this.server.adbDevices)return this.server.adbDevices[o]},v.prototype.write=function(e,n,i){n||(n="OKAY");var r=t((e=o(e)).byteLength);r=o(n+r);var s=u(new Uint8Array(r),new Uint8Array(e)).buffer;i||(i=function(){this.socket.destroy()}.bind(this)),this.socket.write(s,i)},v.prototype.getDevicesString=function(e){var n=(e=e||{}).longformDevices,t="";for(var i in this.server.adbDevices)t+=(i=this.server.adbDevices[i]).serialno+"\tdevice",n&&("usb"==i.transport.type?t+=" usb:"+i.transport.iface.interfaceNumber:t+=" tpcip:something",t+=" product:"+i.properties["ro.product.name"],t+=" model:"+i.properties["ro.product.model"],t+=" device:"+i.properties["ro.product.device"]),t+="\n";return t},v.prototype.writeDevices=function(e,n){this.write(this.getDevicesString(e),null,n)},v.prototype.handlePayload=function(e){var s=(e=i(e)).split(":"),c=e;switch("host-serial"==s[0]&&(s[0]="host",g=s.splice(1,1)[0],Number.isInteger(parseInt(s[1]))&&(g+=":"+s.splice(1,1)[0])),s.length>=2&&(c=s[0]+":"+s[1]),c){case"host:version":this.write(t(r.ADB_VERSION));break;case"host:devices-l":case"host:devices":var a="host:devices-l"==e;this.server.refresh(),this.writeDevices({longformDevices:a});break;case"host:features":if("String"==(y=this.resolveTransport(e,g)).constructor.name){this.write(y,"FAIL");break}var h=y.properties.features;h||(h=""),this.write(t(h));break;case"host:transport-usb":case"host:transport-any":if("String"==(y=this.resolveTransport(e,g)).constructor.name){this.write(y,"FAIL");break}this.transport=y,this.socket.write(o("OKAY"),function(){});break;case"host:kill":this.server.kill();break;case"host:disconnect":if(s.length>4){this.write("host:disconnect only takes 1 argument","FAIL");break}if(s.length>2)if((v=s[2]).length){var u=5555;s.length>3&&(u=Number.parseInt(s[3]));var l=v+":"+u;(f=this.server.adbDevices[l])&&"tcp"==f.transport.type&&f.destroy(),this.write("disconnected");break}for(var f in this.server.adbDevices)"tcp"==(f=this.server.adbDevices[f]).transport.type&&f.destroy();this.write("disconnected");break;case"host:connect":if(s.length<3){this.write("need more arguments for connect <host>[:<port>]","FAIL");break}var v=s[2];u=5555;s.length>3&&(u=Number.parseInt(s[3])),Socket.connect({host:v,port:u},function(e,t){if(!e)return console.error("connect failed"),this.write("unable to connect to "+v+" "+u+": "+t,"FAIL"),this;var i=new r(new n(e),function(e){this.server.withAdbDevice(e,function(){var e="connected to "+v+":"+u;console.log(e),this.write(e)}.bind(this))}.bind(this));i.onOpenSocket=this.onOpenSocket,i.serialno=v+":"+u,e.onClose=function(){i.fatal("socket closed")}.bind(this),i.sendMessage(r.kCommandCNXN,r.ADB_PROTOCOL_VERSION,r.MAX_PAYLOAD,"host::"),i.receiveMessages()}.bind(this));break;case"host:track-devices":this.tracking=d(),this.writeDevices({},function(){});break;case"host:forward":var m=s.join(":").substring(c.length+1).split(";"),w=m[0].split(":"),p=parseInt(w[1]);if("String"==(y=this.resolveTransport(e,g)).constructor.name){this.write(y,"FAIL");break}y.forwardPort({fromPort:p,to:m[1]}),this.socket.write(o("OKAYOKAY"),function(){}.bind(this));break;default:var y;if(this.transport)return void(y=this.transport).newSocket(e,function(e){e?(this.socket.write(o("OKAY"),function(){}),Socket.stream(e,this.socket)):this.socket.write(o("OKAY"),function(){this.socket.destroy()}.bind(this))}.bind(this));if(e.startsWith("host:transport:")){var g=e.substr("host:transport:".length);if(!(f=this.server.adbDevices[g]))return void this.write("device not found","FAIL");this.transport=f,this.socket.write(o("OKAY"),function(){});break}console.log("unknown request: "+e),this.write("unknown command: "+e,"FAIL");var b=chrome.runtime.getManifest().name;chrome.notifications.create({type:"basic",iconUrl:"/icon.png",title:b,message:b+"'s adb server encountered an unknown adb command.\nYou may want to close "+b+" and start your adb binary manually."})}this.receiveHeader()},v.prototype.receivePayload=function(e){var n=parseInt(i(e),16);this.socket.read(n,this.handlePayload.bind(this))},v.prototype.receiveHeader=function(){this.socket.read(4,this.receivePayload.bind(this))},window.AdbDevice=r,window.AdbServer=h,window.AdbTcpTransport=n}(),function(){var e={};function n(){}e.sendHostCommand=function(e,n){Socket.connect({host:"127.0.0.1",port:5037},function(r){if(r){var s=e;e=t(e.length)+e,r.read(4,function(e){var t=i(e);if("OKAY"!=t)return console.error("error in response to adb host command",s,t),r.destroy(),void n();r.read(4,function(e){var t=i(e);0!=(e=parseInt(t,16))&&"OKAY"!=t?r.read(e,function(e){n(r,e)}):n(r,new ArrayBuffer(0))})}),r.write(o(e),function(){})}else n()})},e.devices=function(n){var t={};function o(e){var n=e,i=(e=e.replace("\t"," ")).indexOf(" ");if(-1!=i){var o,r=e.substring(0,i);for(e=e.substring(i).trim();o!=e;)o=e,e=e.replace("  "," ");var s={},c=e.indexOf(" ");-1==c&&(c=e.length);var a,h=e.substring(0,c);for(e=e.substring(c+1);e.length&&-1!=(i=e.indexOf(":"));){var u,l=e.substring(0,i),f=e.substring(i+1),d=f.indexOf(" "),v=f.indexOf(":");if(-1==d||-1==v)u=f,e="";else for(;-1!=d&&d<v;)u=f.substring(0,d),e=f.substring(d+1),d=f.indexOf(" ",d+1);s[l]=u}a=s.model?s.model.replace("_"," "):r,t[r]={serialno:r,name:a,status:h,properties:n}}}e.sendHostCommand("host:devices-l",function(e,r){if(e){e.destroy(),r=i(r),console.log("ADB devices:",r);var s=(r=r.trim()).split("\n");for(var c in s)o(c=s[c]);console.log("parsed ADB devices:",t),n(t)}else n()})},e.killServer=function(n){e.sendHostCommand("host:kill-server",function(e,t){e?(e.destroy(),t=i(t),n&&n()):n()})},e.sendClientCommand=function(e,n){var r=e.command,s=e.serialno;Socket.connect({host:"127.0.0.1",port:5037},function(e){if(e){e.read(4,function(s){if("OKAY"!=i(s))return e.destroy(),void n(null);var c=r;c=t(c.length)+c,e.read(4,function(t){if("OKAY"!=i(t))return e.destroy(),void n(null);n(e)}),e.write(o(c),function(){})});var c="host:transport:"+s;c=t(c.length)+c,e.write(o(c),function(){})}else n()})},e.shell=function(n,t){var i=n.command;n.serialno;e.getOrCreateSockFactory(n).newSocket("shell:"+i,function(e){e?a(e,function(e){t(e)}):t()})},e.forward=function(n,t){var i="host-serial:"+n.serialno+":forward:"+n.from+";"+n.to;e.sendHostCommand(i,function(e,n){e&&e.destroy(),t(e,n)})},e.reverse=function(n,t){var i="reverse:forward:"+n.from+";"+n.to;e.sendClientCommand({serialno:n.serialno,command:i},function(e,n){e?a(e,t):t()})},n.MKID=function(e,n,t,i){return e.charCodeAt(0)|n.charCodeAt(0)<<8|t.charCodeAt(0)<<16|i.charCodeAt(0)<<24},n.ID_RECV=n.MKID("R","E","C","V"),n.ID_SEND=n.MKID("S","E","N","D"),n.ID_DONE=n.MKID("D","O","N","E"),n.ID_DATA=n.MKID("D","A","T","A"),n.DATA_MAX=65536,e.pull=function(t,i){var r,s=t.file,c=(t.serialno,t.fileEntry),a=t.socket;a||(a={write:function(e,n){r?(r.onwriteend=n,r.write(new Blob([e]))):c.createWriter(function(t){r=t,a.write(e,n)})}});var h=new O;Socket.pump(h,a,function(){i(c)}),e.getOrCreateSockFactory(t).newSocket("sync:",function(e){if(e){var t=new ArrayBuffer(8),r=new DataView(t);r.setUint32(0,n.ID_RECV,!0),r.setUint32(4,s.length,!0),e.write(t,function(){e.write(o(s),function(){c()})})}else i();function c(){e.read(8,function(t){var o=new DataView(t.buffer,t.byteOffset,t.byteLength),r=o.getUint32(0,!0);r!=n.ID_DATA?(e.destroy(),r!=n.ID_DONE?i():h.dataReceived(null)):function(n){e.read(n,function(e){h.dataReceived(e),c()})}(o.getUint32(4,!0))})}})},e.createSocketFactory=function(n){return{newSocket:function(t,i){e.sendClientCommand({serialno:n,command:t},i)}}},e.getOrCreateSockFactory=function(n){return n.socketFactory||e.createSocketFactory(n.serialno)},e.push=function(t,i){var r=t.file,s=(t.serialno,t.socket);e.getOrCreateSockFactory(t).newSocket("sync:",function(e){if(e){var t=new ArrayBuffer(8),c=new DataView(t),a=r+",0644";c.setUint32(0,n.ID_SEND,!0),c.setUint32(4,a.length,!0),e.write(t,function(){e.write(o(a),function(){function t(){s.read(function(i){if(i.byteLength>n.DATA_MAX){var o=i.subarray(n.DATA_MAX);i=i.subarray(0,n.DATA_MAX),s.unshift(o)}!function(i){var o=new ArrayBuffer(8),r=new DataView(o);r.setUint32(0,n.ID_DATA,!0),r.setUint32(4,i.byteLength,!0),e.write(o,function(){var n=i.buffer;(i.byteOffset||i.length!=n.byteLength)&&(n=n.slice(i.byteOffset,i.byteOffset+i.byteLength)),e.write(n,function(){t()})})}(i)})}s.onClose=function(){var t=new ArrayBuffer(8),o=new DataView(t);o.setUint32(0,n.ID_DONE,!0),o.setUint32(4,0,!0),e.write(t,function(){e.read(8,function(){i()})})},t()})})}else i()})},window.Adb=e}(),function(){function e(e,n){this.transport=e,this.sockets={},this.currentSocketId=0,this.maxPayload=n||AdbDevice.MAX_PAYLOAD}e.prototype.start=function(e){var n=o(e,void 0,!0);this.sendMessage(AdbDevice.kCommandCNXN,AdbDevice.ADB_PROTOCOL_VERSION,this.maxPayload,n),this.receiveMessages()},e.prototype.fatal=function(e){console.log("fatal error",e);var n=this.onClose;n&&(delete this.onClose,n())},e.prototype.sendMessage=AdbDevice.prototype.sendMessage,e.prototype.receiveMessages=AdbDevice.prototype.receiveMessages,e.prototype.onReceiveMessage=AdbDevice.prototype.onReceiveMessage,e.prototype.handleMessage=AdbDevice.prototype.handleMessage,e.prototype.handleUnknown=AdbDevice.prototype.handleUnknown,e.prototype.newSocket=AdbDevice.prototype.newSocket,e.prototype.newAdbSocket=AdbDevice.prototype.newAdbSocket,e.prototype.destroy=AdbDevice.prototype.destroy,e.prototype.onOpenSocket=function(e,n){if(this.openSocket){var t=++this.currentSocketId,o=this.newAdbSocket(t);o.remoteId=n,this.sockets[t]=o,this.sendMessage(AdbDevice.kCommandOKAY,t,n),this.openSocket(i(e),o)}},window.AdbDaemon=e}(),function(){window.AdbUtils={runMain:function(e,n,t,i,o){o||(o=Adb.shell),Adb.shell({command:"ls -l /system/bin/app_process*",serialno:e},function(r){var s="/system/bin/app_process";r&&-1!=r.indexOf("app_process32")&&(s+="32"),o({command:'sh -c "CLASSPATH='+n+" "+s+" /system/bin "+t+'"',serialno:e},i)})},installApk:function(e,n,t){$.ajax({url:e,dataType:"binary",responseType:"arraybuffer",success:function(e){var i=new O(new Uint8Array(e)),o="/data/local/tmp/apk"+(new Date).getTime()+".apk";Adb.push({serialno:n,file:o,socket:i},function(){Adb.shell({command:"pm install -r "+o,serialno:n},t)})},error:function(e){console.error("error fetching apk",e),t()}})},getApkPath:function(e,n,t){Adb.shell({command:"pm path "+n,serialno:e},function(e){if(""!=e&&e){var n=e.match(/package:\/.*?[\r\n]/);n&&n.length?(e=(e=n[0]).replace("package:","").trim(),t(e)):t(null)}else t(null)})}}}(),(p=function(e){this.authorization=e}).prototype.shorten=function(e,n){$.ajax({type:"POST",url:"https://www.googleapis.com/urlshortener/v1/url?key="+this.authorization,data:JSON.stringify({longUrl:e}),contentType:"application/json",dataType:"json",success:function(e){n(e.id)}})},window.Googl=p,g=!1,b=!1,k="Account Management",T.prototype.refresh=function(e,n){console.log("interactive",n),this.refreshInternal(e,n).async()},T.prototype.refreshInternal=function*(e,t){var i,o,r,s=function(){n(function(){if(this.t()){var e,n=chrome.app.window.getAll().filter(function(e){return e&&"purchase"==e.id});n&&n.length,null!=(e=n[0])&&(e.close(),m("Vysor subscription is active. Thank you for your support!"))}}.bind(this)),this.globalRefresh?this.globalRefresh():console.error("no global refresh?"),i||(i=!0,e&&e(this.t()))}.bind(this),c=!1;window.chrome&&window.chrome.runtime&&window.chrome.runtime.connect||(c=!0);var a=function(e,n){return!!n.licensed&&(e!=n.email?(console.log("email mismatch"),!1):(console.log("enterprise license retrieved"),!0))}.bind(this),h=function(e,n){if(0!=n.sandbox)return console.log("sandbox mismatch"),!1;if(e!=n.buyer_id)return console.log("id mismatch"),!1;if("koushd@gmail.com"!=n.seller_id)return console.log("seller mismatch"),!1;var t=!1;return n.subscriptions&&$.each(n.subscriptions,function(e,n){console.log("subscription found",n),n.remote_plan_id.startsWith("vysor")?n.subscription_active&&(console.log("clockwork subscription retrieved"),t=n.license_first_retrieved):console.log("skipping non-vysor subscription")}.bind(this)),$.each(n.orders,function(e,n){console.log("purchase found",n),n.product_id.startsWith("vysor")?n.is_purchased&&(console.log("clockwork license retrieved"),t=n.order_date):console.log("skipping non-vysor purchase")}.bind(this)),t}.bind(this),u=function(e){$.each(e,function(e,n){console.log("subscription status",n),"ACTIVE"==n.state&&(console.log("chrome license retrieved"),g=!0)}.bind(this))}.bind(this),l=function*(){if(r&&!t)return console.log("Skipping enterprise license server check."),void console.log("Use Retrieve License from the purchase page to force refresh.");console.log("checking chrome enterprise licenses");var e=yield D(!1,yield);if(!e)return chrome.runtime.lastError,void console.error("No auth token for enterprise licensing");try{var n=yield chrome.identity.getProfileUserInfo(yield);if(!A)return void console.log("unable to retrieve user info for enterprise");n.id;var i=n.email;try{n=yield $.ajax({url:"https://billing.vysor.io/license",headers:{Authorization:"Bearer "+e},dataType:"json",success:yield S,error:yield Error});var o=JSON.parse(n.signed_data);if(yield chrome.storage.local.set({cachedEnterpriseLicense:n},yield),!a(i,o))return void console.log("No enterprise license found on server");y="https://billing.vysor.io",k="Enterprise Account ("+o.licensing_accounts[0]+")",g=!0,b=!0,s()}catch(n){yield chrome.identity.removeCachedAuthToken({token:e},yield),console.error("Error communicating with vysor enterprise",n)}}catch(n){yield chrome.identity.removeCachedAuthToken({token:e},yield),console.error("Unable to get email for enterprise",n)}}.bind(this),f=function*(){if(o&&!t)return console.log("Skipping clockwork license server check."),void console.log("Use Retrieve License from the purchase page to force refresh.");console.log("checking clockwork purchases");var e=yield D(!1,yield);if(!e)return chrome.runtime.lastError,void console.error("No auth token for clockwork billing");try{var n=yield chrome.identity.getProfileUserInfo(yield);if(!A)return void console.log("unable to retrieve user info for clockwork");var i=n.id,r="https://billing.clockworkmod.com/api/v1/purchase/koushd@gmail.com?sandbox=false&nonce="+Date.now();try{n=yield $.ajax({url:r,dataType:"json",headers:{Authorization:"Bearer "+e},error:yield Error,success:yield S});var c=JSON.parse(n.signed_data);if(yield chrome.storage.local.set({cachedClockworkLicense:n},yield),!h(i,c))return void console.log("no clockwork license found on server");y="https://billing.clockworkmod.com",g=!0,b=!0,s()}catch(e){console.error("error requesting purchases",e)}}catch(n){yield chrome.identity.removeCachedAuthToken({token:e},yield),console.error("Unable to get buyer id for clockworkbilling",n)}}.bind(this),d=function*(){if(!c){var e;console.log("checking chrome store purchases");try{e=yield google.payments.inapp.getPurchases({parameters:{env:"prod"},success:yield S,failure:yield Error})}catch(e){if(console.error("Failed to query license from chrome store.",e),!t)return console.log("Skipping Chrome license server fallback check."),void console.log("Use Retrieve License from the purchase page to force refresh.");console.log("Falling back to server proxied query.");try{yield this.i(!1,yield),yield*v()}catch(e){console.error("failed to do fallback server check",e)}return}u(e.response.details),this.t()?(y="https://payments.google.com/payments/home#subscriptionsAndServices",s(),console.log("Caching Vysor license."),yield this.i(!1,yield),this.o()&&s()):console.log("no chrome license found on server")}}.bind(this),v=function*(){if(!c){console.log("checking cached chrome license");var e=yield chrome.storage.local.get("cachedLicense",yield);if(e)if(e.cachedLicense)if(A){var n=yield C("AQAB","vMGBBmLcMO4lOmg-YAHq2DjZKHTaW-xs9KPNXU_zKJ7ZhFhWH3I6skF9ZO8lKeXOSwVEIW4HVMa7m16S6WTrUw",e.cachedLicense.signed_data,e.cachedLicense.signature,yield);if(n)console.error("error verifying cached signature",n);else{var t=JSON.parse(e.cachedLicense.signed_data),i=Date.now();if($.each(t.payments,function(e,n){"ACTIVE"==n.state&&(i=Math.min(i,n.createdTime))}.bind(this)),t.date>Date.now())console.log("cached license date from future?");else{var o,r=(new Date-new Date(i))/1e3/60/60/24,a=(o=r<14?4:Math.min(30,4+(r-14)/7))/2;if(t.date+24*o*60*60*1e3<Date.now())console.log("cached license is expired.");else if(A.id==t.userinfo.id)if(u(t.payments),this.t()){if(y="https://payments.google.com/payments/home#subscriptionsAndServices",console.log("cached license is valid for "+(t.date+24*o*60*60*1e3-Date.now())/36e5+" hours"),b=!0,s(),t.date+24*a*60*60*1e3<Date.now()){console.log("Refreshing cached license");try{yield this.i(!1,yield)}catch(n){console.warn("Failed to re-cache license.",n)}}}else console.log("no chrome license found in cache");else console.log("id mismatch")}}}else console.log("unable to retrieve user info for cache");else console.log("no cached chrome license found");else console.error("storage access failed?",chrome.runtime.lastError)}}.bind(this),w=function*(){console.log("Checking cached Clockwork license.");var e=yield chrome.storage.local.get("cachedClockworkLicense",yield);if(e)if(e.cachedClockworkLicense)if(A){var n=A.id,t=yield C("AQAB","vMGBBmLcMO4lOmg-YAHq2DjZKHTaW-xs9KPNXU_zKJ7ZhFhWH3I6skF9ZO8lKeXOSwVEIW4HVMa7m16S6WTrUw",e.cachedClockworkLicense.signed_data,e.cachedClockworkLicense.signature,yield);if(t)console.error("Error verifying cached clockwork signature",t);else{var i=JSON.parse(e.cachedClockworkLicense.signed_data),r=h(n,i);if(!r)return console.log("No Clockwork license found in cache."),void(o=!0);y="https://billing.clockworkmod.com";var c,a=(new Date-new Date(r))/1e3/60/60/24,u=(c=a<14?4:Math.min(30,4+(a-14)/7))/2;i.timestamp+24*c*60*60*1e3<Date.now()?console.log("Cached Clockwork license is expired. Requires server check."):i.timestamp>Date.now()?console.error("Cached Clockwork license date from future?"):(g=!0,console.log("Cached Clockwork license is valid for "+(i.timestamp+24*c*60*60*1e3-Date.now())/36e5+" hours"),b=!0,s(),i.timestamp+24*u*60*60*1e3<Date.now()&&(o=!1,yield*f()))}}else console.error("Unable to retrieve user info for cached Clockwork license.");else console.log("Cached Clockwork payload not found.");else console.error("storage access failed?",chrome.runtime.lastError)}.bind(this),p=function*(){console.log("Checking cached enterprise license.");var e=yield chrome.storage.local.get("cachedEnterpriseLicense",yield);if(e)if(e.cachedEnterpriseLicense)if(A){var n=yield C("AQAB","hDuGsIhbjLYXteQX3F3KNriQHwUSZurS5voCkdpA1733A65pqtGOrk9g_yLiF94_vSK0VmL-4stq7WAYEbn6nw",e.cachedEnterpriseLicense.signed_data,e.cachedEnterpriseLicense.signature,yield);if(n)console.error("Error verifying cached enterprise signature",n);else{var t=JSON.parse(e.cachedEnterpriseLicense.signed_data);if(!a(A.email,t))return r=!0,void console.log("No Enterprise license found in cache.");t.timestamp+3456e5<Date.now()?console.log("Cached Enterprise license is expired. Requires server check."):t.timestamp>Date.now()?console.error("Cached Enterprise license date from future?"):(y="https://billing.vysor.io",k="Enterprise Account ("+t.licensing_accounts[0]+")",g=!0,console.log("Cached Enterprise license is valid for "+(t.timestamp+3456e5-Date.now())/36e5+" hours"),b=!0,s(),t.timestamp+1728e5<Date.now()&&(r=!1,yield*l()))}}else console.error("Unable to retrieve user info for cached Clockwork license.");else console.log("Cached Enterprise payload not found.");else console.error("storage access failed?",chrome.runtime.lastError)}.bind(this);if(this.t())s();else{console.log("starting license check");var A=yield chrome.identity.getProfileUserInfo(yield);A?console.log("user info",A):console.log("unable to retrieve user info"),yield*p(),this.t()||(yield*w(),this.t()||(yield*v(),this.t()||(yield*l(),this.t()||(yield*f(),this.t()||(yield*d(),this.t()||s())))))}},T.prototype.i=function(e,n){console.log("caching chrome license"),D(e,function(t){if(!t)return chrome.runtime.lastError,e&&m("Unable to get auth token: "+chrome.runtime.lastError),console.error("Unable to get auth token while caching license",chrome.runtime.lastError),void(n&&n(chrome.runtime.lastError));$.ajax({type:"post",url:"https://billing.clockworkmod.com/api/v1/verify/google/koushd@gmail.com",data:{token:t,item:chrome.runtime.id,version:chrome.runtime.getManifest().version},dataType:"json",success:function(e){console.log("chrome license cached"),b=!0,chrome.storage.local.set({cachedLicense:e},n)}.bind(this),error:function(e,i){console.error("unable to cache license",i),chrome.identity.removeCachedAuthToken({token:t},function(){n&&n(i)})}})}.bind(this))},T.prototype.t=function(){return g},T.prototype.o=function(){return b},T.prototype.getManageData=function(){return{managementUrl:y,managementText:k}},T.prototype.startPurchase=function(){chrome.app.window.create("purchase.html",{id:"purchase",innerBounds:{minWidth:800,minHeight:860}},function(e){this.refresh(),e.contentWindow._rlm=function(e){chrome.storage.local.remove(["cachedLicense","cachedClockworkLicense","cachedEnterpriseLicense"],function(){this.refresh(e,!0)}.bind(this))}.bind(this)}.bind(this))},E.prototype.openSocket=function(e,n){if(!this.onOpenSocket||!this.onOpenSocket(e,n))if("properties"!=e)this.adbSocketFactory.newSocket(e,function(t){if(!t)return console.log("unable to execute adb proxy command?",e),void n.destroy();Socket.stream(t,n,function(){})});else{var t=this.properties;n.write(o(t),function(){console.log("sent properties",t),n.destroy()})}};console.log("Vysor version",chrome.runtime.getManifest().version),console.log(navigator.userAgent),console.log("Electron",isElectron()),console.log("Date",new Date);var V,P,R,x=new AdbServer({start:!1}),M={},j={},q={},L=analytics.getService("vysor_app").getTracker("UA-4956323-6");if(isElectron()){var J=L;L={sendEvent:J.sendEvent.bind(J),sendAppView:J.sendAppView.bind(J)};const{screen:e}=require("electron");console.log("getAllDisplays",e.getAllDisplays()),console.log("getPrimaryDisplay",e.getPrimaryDisplay())}var _,K,F,z=new T,H="Chrome GCM Service is unavailable. Try restarting Chrome?",Y=new HttpServer;function X(e){e.contentWindow._lm={_il:z.t(),_ilc:z.o(),_cl:z.i.bind(z),_md:z.getManageData(),refresh:z.refresh.bind(z),startPurchase:z.startPurchase.bind(z)},e.contentWindow._rl&&e.contentWindow._rl()}function W(e,n){if(R){var t=R.contentWindow.shortModal;t&&t(e,n)}}function G(){R&&R.contentWindow.updateVysorShareServer&&R.contentWindow.updateVysorShareServer(P)}function Q(e,n){var t=oe(e);console.log(e,t,"status",n);var i=chrome.app.window.get(t);i&&i.contentWindow.updateWindowStatusText&&i.contentWindow.updateWindowStatusText(n)}function Z(e,n){Q(e,"Connecting..."),AdbUtils.getApkPath(e,"com.koushikdutta.vysor",function(t){t?AdbUtils.runMain(e,t,"com.koushikdutta.vysor.ProtocolVersionMain",function(e){var i=e.match(/vysor-io-.*?[\r\n]/);i&&i.length?((e=i[0])&&(e=e.trim()),console.log("protocol version: "+e),n("vysor-io-68"!=e?null:t)):n(null)}):n()})}function ee(e,n){function t(t){var i=Math.round(Math.random()*(1<<30)).toString(16),o="echo -n "+i+" > /data/local/tmp/vysor.pwd ; chmod 600 /data/local/tmp/vysor.pwd";AdbUtils.runMain(e,t,"com.koushikdutta.vysor.Main password="+i+" keyboard="+V,function(t){Adb.shell({serialno:e,command:'sh -c "'+o+'"'},function(e){Socket.eat(t),n(i)})},function(e,n){e.command="shell:"+e.command,Adb.sendClientCommand(e,n)})}Q(e,"Connecting...");oe(e);Z(e,function(n){if(!n)return console.log("uninstalling old apk if exists"),void Adb.shell({command:"pm uninstall com.koushikdutta.vysor",serialno:e},function(n){console.log("uninstall result",n),console.log("installing apk"),function(e,n){Q(e,"Installing Vysor APK..."),AdbUtils.installApk("/Vysor-release.apk",e,n)}(e,function(n){Z(e,function(i){if(!i)return n||(n=""),m("Error installing APK:\n"+n.trim()),void ne(e);t(i)})})});t(n)})}function ne(e){var n=oe(e),t=chrome.app.window.get(n);t&&t.close()}function te(e,n,t){isElectron()?(console.log("adb client socket factory path"),e.contentWindow.adbSocketFactory=null,e.contentWindow.adbSocketFactoryFactory={type:"adb-client",arguments:{serialno:n}}):M[n]?(console.log("vysor socket fast path"),e.contentWindow.adbSocketFactory=M[n]):x.isRunning()?(console.log("adb server socket path"),e.contentWindow.adbSocketFactory=x.adbDevices[n]):(console.log("adb client socket path"),e.contentWindow.adbSocketFactory=Adb.createSocketFactory(n)),X(e),e.contentWindow.openList=fe,e.contentWindow.password=t,Y&&Y.socket&&(e.contentWindow.httpPort=Y.socket.localPort),e.contentWindow.device=M[n]||Ne[n],e.contentWindow.tracker=L}function ie(){setTimeout(function(){chrome.app.window.getAll().length||chrome.runtime.reload()},5e3)}function oe(e){var n=e;return M[e]&&M[e].id?n=M[e].id:Ne[e]&&Ne[e].id?n=Ne[e].id:Ee[e]&&(n=Ee[e]),n}function re(e,n,t){me();var i=oe(e),o=chrome.app.window.get(i);if(o)return o.show(),n&&ee(e,function(n){te(o,e,n),o.contentWindow.connectionReady()}),void(t&&t(o));chrome.app.window.create("screen.html",{id:i,innerBounds:{width:576,height:1024}},function(n){var i;n.onClosed.addListener(i=function(){n.onClosed.removeListener(i),ie(),n.contentWindow.h264Socket&&(console.log("cleaning up h264 socket"),n.contentWindow.h264Socket.destroy(),n.contentWindow.h264Socket=null),n.contentWindow.inputWebSocket&&(console.log("cleaning up input websocket"),n.contentWindow.inputWebSocket.close(),n.contentWindow.inputWebSocket=null)}),te(n,e,null),n.contentWindow.onload=function(){t&&t(n),Ne[e]?ee(e,function(t){te(n,e,t),n.contentWindow.connectionReady()}):console.log("Vysor requested for",e,"which is not available yet")}})}function se(){P=null,K&&K.stopListen("share"),G()}function ce(e){var n=q[e];n&&n.gcmConn.destroy()}function ae(e,n,t){var i=q[e];if(i&&i.devices[n]){var o;i.gcmConn.gcmConns[n]&&i.gcmConn.gcmConns[n].destroy();var r=i.gcmConn.gcmConns[n]={id:n,farm:!0,newSocket:function(e,t){o||i.gcmConn.newSocket(n+":"+e,t)},destroy:function(){o=!0,i.gcmConn.gcmConns[n]==r&&delete i.gcmConn.gcmConns[n],delete Ne[r.serialno],i.gcmConn.newSocket("close:"+n,function(e){e&&e.destroy()});var e=r.onClose;e&&(delete r.onClose,e()),je()}};de(n,function(e){e(r)},t),je()}}function he(e,n,t){function i(e){t&&t(null,e)}var o=(e=new URL(e)).hash.replace("#","");$.ajax({url:"https://billing.vysor.io/gcm/"+o,dataType:"json",success:function(e){K?K.connect({senderId:"64148182473",registrationId:e.registration,port:"share"}).then(function(r){L.sendEvent("connected-device-farm");var h,u=q[o];u&&u.gcmConn.destroy();var l=q[o]={info:e,gcmConn:r};function f(){r.newSocket("devices:",function(e){a(e,function(e){var n=JSON.parse(e),t=n.devices,i=n.sharedDevices;l.devices?($.each(Object.keys(t),function(e,n){delete l.devices[n]}),$.each(Object.keys(l.devices),function(e,n){var t=r.gcmConns[n];t&&t.destroy()}),l.devices=t):l.devices=t,l.sharedDevices=i,je()})})}r.gcmConns={},r.openSocket=function(e,o){if(e.startsWith("challenge:")){console.log("received challenge",e);var a=e.split(":")[1];$.ajax({type:"post",url:"https://billing.vysor.io/verifyauth",headers:{Authorization:"Bearer "+n},data:{nonce:a},dataType:"json",success:function(e){_=JSON.parse(e.signed_data),console.log("sending challenge response",e),s(o,e,function(){c(o,function(e){if(o.destroy(),"ok"==e)return f(),void(t&&t(l.info));i("Access denied: "+e)})})},error:function(e,n){i("Unable to verify identity."),o.destroy()}})}else if(e.startsWith("close:")){o.destroy();var u=e.split(":")[1],d=r.gcmConns[u];if(!d)return void console.log("can't close unknown subconn");d.destroy()}else e.startsWith("tracker:")?(console.log("got tracker socket"),h=o,function e(){h.read(function(){f(),e()})}()):(console.log("got unknown socket request",e),o.destroy())},r.onClose=function(){q[o]==l&&delete q[o],$.each(Object.keys(r.gcmConns),function(e,n){var t=r.gcmConns[n];t&&t.destroy()}),je()},console.log("Connection to device farm established",r)}):i(H)},error:function(e,n){m("Unable to find server: "+n)}})}function ue(e,n){function t(e){je(),n?n(null,e):m(e)}function i(){je(),n&&n(P)}se(),D(e,function(e){if(e)if(K){var n;K.onRegistrationIdChanged=u,chrome.storage.local.get(["lastDeviceFarmRegistrationId","lastDeviceFarmServerId"],function(e){if(e&&e.lastDeviceFarmRegistrationId==K.registrationId&&e.lastDeviceFarmServerId)return console.log("device farm registration unchanged, not registering with server."),P="https://vysor.clockworkmod.com/server#"+e.lastDeviceFarmServerId,void i();u()});var r,a=[];K.listen("share",function(e){var n,t,i,o={},u=Math.round(Math.random()*(1<<30)).toString(16)+Math.round(Math.random()*(1<<30)).toString(16);e.onClose=function(){var n=a.indexOf(e);-1!=n&&a.splice(n,1),e.trackerSocket&&(e.trackerSocket.destroy(),delete e.trackerSocket),$.each(Object.keys(o),function(e,n){o[n].destroy()})},e.newSocket("challenge:"+u,function(o){if(!o)return console.error("challenge socket failed"),void e.destroy();c(o,function(r){console.log("received challenge response",r);var c=JSON.parse(r);function h(e){e=e||"fail",console.log("Remote user failed to authorize",e),s(o,e,function(){o.destroy()})}C("AQAB","hDuGsIhbjLYXteQX3F3KNriQHwUSZurS5voCkdpA1733A65pqtGOrk9g_yLiF94_vSK0VmL-4stq7WAYEbn6nw",c.signed_data,c.signature,function(r){function l(){function r(){a.push(e),n=!0,s(o,"ok",function(){o.destroy()}),m("Vysor is sharing Android devices with "+t.name,i),Adb.sendHostCommand("host:track-devices",function(n){n?e.newSocket("tracker:",function(t){if(!t)return n.destroy(),void console.error("unable to open remote tracker");e.trackerSocket=t,Socket.stream(t,n)}):console.error("unable to track adb devices",chrome.runtime.lastError)})}var c,u;c=t.email,u=function(e,n){if(e)r();else if(n){var o=chrome.runtime.getManifest().name;chrome.notifications.create({type:"basic",iconUrl:i,title:o,message:t.name+" is requesting access to Vysor shared Android devices.",buttons:[{title:"Allow"},{title:"Deny"}]},function(e){var n,i=function(t){t==e&&(chrome.notifications.onClosed.removeListener(i),chrome.notifications.onButtonClicked.removeListener(o),n||h("Denied by user."))},o=function(i,o){i==e&&(chrome.notifications.clear(i),n=!0,0==o?(N(t.email,function(){G()}),r()):h("Denied by user."))};chrome.notifications.onClosed.addListener(i),chrome.notifications.onButtonClicked.addListener(o)})}else h("Denied by policy.")},chrome.storage.local.get(["whitelist","serverMode"],function(e){if(1!=e.serverMode){if(2!=e.serverMode)return e.whitelist&&"Array"==e.whitelist.constructor.name?void u(-1!=e.whitelist.indexOf(c),!0):void u(!1,!0);D(!1,function(e){if(!e)return console.error("unable to get token for vysor enterprise whitelist check"),void u(!1);$.ajax({type:"get",url:"https://billing.vysor.io/whitelist",headers:{Authorization:"Bearer "+e},data:{email:c},error:function(){console.error("failure checking vysor enterprise whitelist",arguments),u(!1)},success:function(e){e.whitelist||console.error("access denied to",c,e),u(e.whitelist,!1)}})})}else u(!0)})}r?h("Identify signature verification failed."):(t=JSON.parse(c.signed_data)).nonce==u?t.picture?A(t.picture,function(e){i=e,l()}):(i="/icon.png",l()):h("Mismatched nonce in authentication.")})})}),e.openSocket=function(i,s){if(n)if("devices:"==i)r=v(r,s,500,function(e){B(function(n){Adb.devices(function(t){t||(t={}),$.each(Object.keys(t),function(e,i){M[i]&&delete t[i],I(n[i]),n[i]&&n[i].friendlyName&&(t[i].name=n[i].friendlyName)});var i={};$.each(Object.keys(j),function(e,n){i[n]={userInfo:j[n].userInfo}}),$(e).each(function(e,n){h(n,{devices:t,sharedDevices:i},function(){n.destroy()})})})})});else if(i.startsWith("close:")){s.destroy();var c=i.split(":")[1];(u=o[c])&&u.destroy()}else{var a=i.indexOf(":");if(-1==a)return console.error("unexpected command received by device farm server"),void s.destroy();var u;c=i.substring(0,a);if(!Ne[c]){if(-1==(a=i.indexOf(":",a+1)))return void s.destroy();if(c=i.substring(0,a),!Ne[c])return void console.error("request for unknown device",c)}if(!(u=o[c])){var f=Adb.createSocketFactory(c);(u=o[c]=new E(f,Ne[c],{})).destroy=function(){try{e.newSocket("close:"+c,function(e){e&&e.destroy()})}catch(e){}var n=j[c];n&&(n.userInfo==t&&delete n.userInfo,n.gcmConn==this&&delete n.gcmConn,n.key||n.gcmConn||delete j[c]);var i=this.onClose;i&&(delete this.onClose,i()),l()}.bind(u)}var d=j[c];d||(d=j[c]={}),d.gcmConn!=u&&(we(c),d.gcmConn=u,d.userInfo=t,j[c]=d),l();var m=i.substring(a+1);u.openSocket(m,s)}else s.destroy()}})}else t(H);else t("Unable to get Auth Token.");function u(){console.log("registering vysor share server"),$.ajax({type:"post",url:"https://billing.vysor.io/gcm",headers:{Authorization:"Bearer "+e},data:{registration:K.registrationId},dataType:"json",success:function(e){console.log("vysor share server",e),chrome.storage.local.set({lastDeviceFarmRegistrationId:K.registrationId,lastDeviceFarmServerId:e.id}),P="https://vysor.clockworkmod.com/server#"+e.id,i()}.bind(this),error:function(e,n){se(),t("Unable to register server: "+n)}})}function l(){n=v(n,null,500,function(){$.each(a,function(e,n){n.trackerSocket&&n.trackerSocket.write(o("0000\n"),function(){})}),je()})}})}function le(e){V=e}function fe(){R?R.focus():chrome.app.window.create("list.html",{id:"list",innerBounds:{width:768,height:868,minWidth:768,minHeight:868}},function(e){(R=e).contentWindow.openList=fe,X(R),R.contentWindow.disconnectSharedDevice=Re,R.contentWindow.toggleShare=xe,R.contentWindow.unshareDevice=pe,R.contentWindow.quietSerial=Pe,R.contentWindow.openWindow=re,R.contentWindow.closeWindow=ne,R.contentWindow.createDeviceFarmConnection=ae,R.contentWindow.destroyDeviceFarmConnection=ce,R.contentWindow.adbServer=x,R.contentWindow.tracker=L,R.contentWindow.startWireless=Me,R.contentWindow.startDeviceFarm=ue,R.contentWindow.stopDeviceFarm=se,R.contentWindow.updateKeyboard=le,R.contentWindow.onload=function(){X(R),G(),je()},R.onClosed.addListener(function(){R=null,ie()})})}function de(e,n,t){x.start();var o=new Server;o.listen({port:0,address:"127.0.0.1"},function(e){o.destroy();var i=new AdbDaemon(new AdbTcpTransport(e));n(function(e){L.sendEvent("connected-shared-device");var n="127.0.0.1:"+o.localPort;e.serialno=n,e.id||(e.id=n),M[n]=e,console.log("connected gcm socket"),e.openSocket=function(){console.log("got a new socket? this should not happen..."),e.destroy()},i.onClose=e.onClose=function(){delete M[n],i.destroy(),e.destroy()},e.onClose=function(){delete M[n],i.destroy(),e.destroy(),m("Disconnected from shared Android device.")},i.openSocket=function(n,t){e.newSocket(n,function(e){Socket.stream(t,e,function(){})})},e.newSocket("properties",function(o){a(o,function(o){var r=AdbDevice.parseConnectionPayload(o);e.name=e.name||r["ro.product.model"].replace("_"," "),i.start(o),console.log("got properties",o),t(n)})})})}.bind(this),function(n){if(n)console.log("adb daemon failed to listen: "+n);else{var t="127.0.0.1:"+o.localPort;M[t]={id:e||t,destroy:function(){}},console.log("mapping",t,e),je(),Adb.sendHostCommand("host:connect:"+t,function(e,n){e&&(e.destroy(),n=i(n),console.log("adb connect result",n))})}}.bind(this))}function ve(e,n){if(m("Vysor is connecting to a remote Android device"),R&&R.show(),console.log("attempting to connect to shared device",e),K){var t=new URL(e),i=d("senderId",t),o=d("registrationId",t),r=d("channel",t);i||(i="64148182473"),de(null,function(e){K.connect({senderId:i,registrationId:o,port:r}).then(e)},n)}else W(null,H)}function me(){chrome.runtime.requestUpdateCheck(function(e,n){console.log("update check",arguments),"update_available"==e&&(Ce=v(Ce,null,1e4,function(){var e=chrome.runtime.getManifest().name;chrome.notifications.create("reload",{type:"basic",iconUrl:"/icon.png",title:e,message:"There is an update available for Vysor.",buttons:[{title:"Reload"}]})}))})}function we(e){var n=j[e];if(n&&n.gcmConn){var t=n.gcmConn;delete n.gcmConn,t.destroy()}}function pe(e){we(e),delete j[e],je()}function ye(e,n){var t=Ne[e];if(K){var i=Math.round(Math.random()*(1<<30)).toString(16);j[e]||(j[e]={}),j[e].key=i,je();var o="https://vysor.clockworkmod.com/redirect/?registrationId="+encodeURIComponent(K.registrationId)+"&channel="+i;console.log(o),K.listen(i,function(n){L.sendEvent("shared-device");var o=j[e];if(!o||o.key!=i)return n.destroy(),void console.log("device is no longer being shared.");o.gcmConn&&o.gcmConn.destroy(),o.gcmConn=n,o.userInfo={name:"Someone"},je(),console.log("accepted gcm socket"),new E(Adb.createSocketFactory(e),t,n).onOpenSocket=function(n,t){if("webstart"==n)return ee(e,function(e){s(t,e,function(){console.log("sent password",e),t.destroy()})}),!0}});var r="https://tu3ph.app.goo.gl/?ad=0&apn=com.koushikdutta.inkwire&link="+encodeURIComponent(o);n(r)}else n&&n(null,H)}function ge(e){return function(){var n=arguments;(F||(console.log("creating persistent gcm connection"),F=new Promise(function(e,n){GcmRtcManager.start({3505780036:"AIzaSyDt0GimPRhk8_d_4XjOYzQUn50UkvXhMtE",64148182473:"AIzaSyDd7k1v017osyYbIC92fyf-36s3pv0z73U"},{iceServers:[{urls:["turn:n0.clockworkmod.com","turn:n1.clockworkmod.com"],username:"foo",credential:"bar"}]},function(n){if(K=n,console.log("persistent gcm connection created",null!=n),!K)return F=null,void e();K.defaultSenderId="64148182473",e(K)})}))).then(function(){e.apply(null,n)})}}z.globalRefresh=function(){console.log("license global refresh");var e=chrome.app.window.getAll();for(var n in e)X(n=e[n])},chrome.identity.onSignInChanged.addListener(function(){console.log("onSignInChanged, refreshing license"),z.refresh(null,!0)}),chrome.storage.local.get("keyboard",function(e){V=e.keyboard}),chrome.storage.local.get("vysorHttp",function(e){if(e){var n=e.vysorHttp||{};n.password=n.password||Math.round(Math.random()*(1<<30)).toString(16);var t={"/device/(.*?)/screenshot-?(.*?).jpg":function(e,n,t){var i=t[1],r=chrome.app.window.get(i);if(!r)return console.error("device window",i,"not found"),n.code(404),void n.write("",function(){n.end()});i=r.contentWindow.device.serialno;var s=r.contentWindow.password;Adb.createSocketFactory(i).newSocket("tcp:53516",function(e){if(!e)return console.error("no socket",i,"for screenshot"),n.code(404),void n.write("",function(){n.end()});n.headers.Connection="close",n.headers["Content-Type"]="application/binary",n.headers["Cache-Control"]="no-cache";var t=new HttpRequestParser(null,e,function(){var e=t.body.buffer.slice(t.body.byteOffset,t.body.byteOffset+t.body.byteLength);n.write(e,function(){n.end()})});e.write(o("GET /screenshot.jpg?password="+s+" HTTP/1.1\r\nConnection: close\r\n\r\n"),function(e){})})},"/device/(.*?)/sdcard-vysor/(.*)":function(e,n,t){var i=t[1],o=chrome.app.window.get(i);if(!o)return console.error("device window",i,"not found"),n.code(404),void n.write("",function(){n.end()});i=o.contentWindow.device.serialno;var r=t[2];n.headers.Connection="close",n.headers["Cache-Control"]="no-cache",n.headers["Content-Type"]="application/binary",Adb.pull({file:"/sdcard/vysor/"+r,serialno:i,socket:n},function(){n.end()})},"/device/(.*?)/audio.adts":function(e,n,t){var i=t[1],o=chrome.app.window.get(i);if(!z.t())return console.error("ignoring request, not licensed"),n.code(402),void n.write("This feature is only available in Vysor Pro",function(){n.end()});if(!o)return console.error("device window",i,"not found"),n.code(404),void n.write("",function(){n.end()});if(!o.contentWindow.siphonAudio)return console.error("siphonAudio",i,"not found"),n.code(404),void n.write("",function(){n.end()});var r=new O;if(n.headers.Connection="close",n.headers["Content-Type"]="audio/aac",Socket.pump(r,n,function(){console.log("aac source closed")}),isElectron()){var s=r;r={dataReceived:function(e){s.dataReceived(e)},destroy:s.destroy.bind(r)}}o.contentWindow.siphonAudio(r)},"/device/(.*?)/video.flv":function(e,n,t){var i=t[1],o=chrome.app.window.get(i);if(!z.t())return console.error("ignoring request, not licensed"),n.code(402),void n.write("This feature is only available in Vysor Pro",function(){n.end()});if(!o)return console.error("device window",i,"not found"),n.code(404),void n.write("",function(){n.end()});if(!o.contentWindow.siphonFlv)return console.error("siphonFlv",i,"not found"),n.code(404),void n.write("",function(){n.end()});var r=new O;if(n.headers.Connection="close",n.headers["Content-Type"]="video/x-flv",Socket.pump(r,n,function(){console.log("flv source closed")}),isElectron()){var s=r;r={dataReceived:function(e){s.dataReceived(e)},destroy:s.destroy.bind(r)}}o.contentWindow.siphonFlv(r)}};!function e(){Y.listen({port:n.port||0,address:"127.0.0.1"},function(e,n){var i,o;for(var r in console.log("http request",e.path),t)if(i=e.path.match(r),o=t[r],i)break;if(!i)return n.code(404),void n.write("",function(){});o(e,n,i)},function(t){if(t)return console.error("http server failed to listen",t),void(n.port&&(console.log("trying port 0"),n.port=0,e()));n.port=Y.socket.localPort,console.log("vysor http port: "+n.port),chrome.storage.local.set({vysorHttp:n})})}()}else console.error("unable to start vysor httpServer, no dict")}),z.refresh(),chrome.app.runtime.onLaunched.addListener(function(e){fe(),e&&"vysor_purchase"==e.id&&z.refresh(null,!0),e&&"vysor_presentation"==e.id&&ve(e.url,function(e){re(e)}),e&&"vysor_device_farm"==e.id&&(console.log("device farm",e.url),R&&R.show(),fe(),m("Vysor is connecting to shared Android devices"),D(!0,function(n){n?he(e.url,n,function(e,n){W("Vysor Share",n?"Unable to connect to shared devices. "+n:"Connected to "+e.name+"'s remote devices.")}):m("Unable to get auth token")})),me()}),he=ge(he),ue=ge(ue),ye=ge(ye),ve=ge(ve),chrome.storage.local.get("share-all-devices",function(e){e["share-all-devices"]&&ue(!1,function(){G()})});var be,ke,Ae,Se,De,Ue,Oe,Ce,Te={},Ee={},Ne={},Ie={},Be={};function Ve(e){var n=Be[e];clearTimeout(n),Be[e]=setTimeout(function(){delete Be[e]},1e4),delete Ie[e]}function Pe(e){var n=Ie[e];clearTimeout(n),Ie[e]=setTimeout(function(){delete Ie[e]},1e4),delete Be[e]}function Re(e){ne(e);var n=M[e];n&&n.destroy()}function xe(e,n){j[e]?pe(e):ye(e,n),je()}function Me(e){function n(n){var o=n+":5555";Te[e]=o,Ee[o]=e;var r=Ne[o];function s(e,n){Adb.sendHostCommand("host:disconnect:"+o,function(t,r){t&&t.destroy(),delete Ne[o],Adb.sendHostCommand("host:connect:"+o,function(t,r){return t?(t.destroy(),-1!=(r=i(r)).indexOf("unable to connect")?(m("Unable to connect via wireless. Is your Android on the same network as your PC?"),void(n&&n(r))):(n&&n(),chrome.storage.local.set({lastConnectAddress:o}),console.log("adb connect result",r),void(e&&c()))):(m("Unable to connect via wireless. Is your Android on the same network as your PC?"),void(n&&n("host connect failed")))})})}function c(){je(),setTimeout(function(){m("Vysor is connected wirelessly. You may disconnect your device."),L.sendEvent("go-wireless"),Pe(o),re(o,!0,function(e){Ve(o),e.contentWindow.tryReconnect=function(){Ve(o),s(!1)}})},3e3)}r&&(r.id=e),Ee[e]&&(device.id=Ee[e]),r&&"device"==r.status?c():(Pe(e),t.newSocket("tcpip:5555",function(e){e?a(e,function(e){console.log("tcpip:5555 result",e),s(!0,function(e){e&&(console.error("host:connect failed, trying again in a few seconds",e),setTimeout(function(){s(!0,function(e){e&&console.err("host:connect failed again, giving up.",e)})},3e3))})}):m("Failure while switching to wireless mode.")}))}var t=Adb.createSocketFactory(e);t.newSocket("shell:ip -f inet addr show wlan0",function(e){e?a(e,function(e){console.log("ifconfig result",e);var i=e.match("inet addr:(.*?) ");(i||(i=e.match("wlan0: ip (.*?) ")),i)?n(i[1]):t.newSocket("shell:ip -f inet addr show wlan0",function(e){e?a(e,function(e){console.log("ifconfig result",e);var t=e.match("inet (.*?)/");t?n(t[1]):m("Unable to switch to wireless mode. Is your Android connected to Wifi?")}):console.log("error running tcpip:5555")})}):console.log("error running tcpip:5555")})}function je(){ke||(ke=n(function(){ke=null,R&&R.contentWindow.refreshList&&R.contentWindow.refreshList(Ne,M,_,q,j,Ee,Te,K&&K.isListening("share"),be,x.isRunning(),Se)}))}function qe(){if(!be){if(isElectron()){var e=require("os").platform(),n=chrome.runtime.getAppDirectory(),t=require("path").join(n,"native",e,"adb");if("win32"==e)t+=".exe";else try{require("fs").chmodSync(t,"755")}catch(e){console.warn("unable to chmod adb",e)}return console.log("attempting to start built in adb binary",t),void require("child_process").execFile(t,["start-server"])}Se||window.chrome&&window.chrome.runtime&&window.chrome.runtime.connectNative&&((Se=chrome.runtime.connectNative("com.clockworkmod.adb")).onDisconnect.addListener(function(){Se=null}),Se.postMessage({command:"start-server"}))}}function Le(){Oe=v(Oe,null,300,function(){chrome.storage.local.get("connect-automatically",function(e){var n;n=!1===e["connect-automatically"]?2:!0===e["connect-automatically"]?0:e["connect-automatically"]||1,Adb.devices(function(e){e?($.each(e,function(t,i){var o=e[t];Ee[t]&&(o.id=Ee[t]);var r=Ne[t];if(!r||o.status!=r.status){pe(t);var s=-1!=o.properties.indexOf("emulator")||-1!=o.properties.indexOf("vbox"),c=oe(t);if(!s&&Ae&&!Ie[c])if(chrome.app.window.get(c)||x.isRunning()||Be[c])h()&&re(t,!0);else if(2!=n&&h()&&"device"==o.status){var a=chrome.runtime.getManifest().name;if(1!=n)return chrome.notifications.create("never-start-automatically",{type:"basic",iconUrl:"/icon.png",title:a,message:"Vysor has connected to an Android device and is starting.",buttons:[{title:"Never Start Automatically"}]}),void re(t,!0);chrome.notifications.create("never-start-automatically-"+Math.random(),{type:"basic",iconUrl:"/icon.png",title:a,message:"Vysor has detected an Android device.",buttons:[{title:"View Android with Vysor"},{title:"Never Start Automatically"}]},function(e){var n=function(t){t==e&&(chrome.notifications.onClosed.removeListener(n),chrome.notifications.onButtonClicked.removeListener(i))},i=function(n,i){n==e&&(chrome.notifications.clear(n),0==i?re(t,!0):chrome.storage.local.set({"connect-automatically":!1}))};chrome.notifications.onClosed.addListener(n),chrome.notifications.onButtonClicked.addListener(i)})}}function h(){return"unauthorized"!=o.status||(m("Vysor has detected an Android device. Please Allow USB Debugging on your Android device to continue."),!1)}}),Ne=e):Ne={},je(),Ae=!0})})})}function Je(){Ue||(Adb.sendHostCommand("host:version",function(e,n){e&&(e.destroy(),n=i(n),console.log("ADB Server Version: ",n))}),Adb.sendHostCommand("host:track-devices",function(e){Ue?e.destroy():e&&(console.log("Connected to ADB Server"),x.isRunning()?console.log("Using Vysor ADB"):console.log("Using Android SDK ADB"),be=!0,e.onClose=function(){Ue=null,be=!1,Le()},Ue=e,function e(n){n.read(function(t){Le(),e(n)})}(e),Le())}))}!function e(){Je(),De||qe(),De=v(De,null,1e4,qe),setTimeout(e,1e3)}(),Le(),chrome.runtime.onUpdateAvailable.addListener(function(){ie()}),chrome.notifications.onButtonClicked.addListener(function(e,n){"reload"==e?chrome.runtime.reload():"never-start-automatically"==e&&(chrome.storage.local.set({"connect-automatically":!1}),chrome.notifications.clear(e))}),chrome.notifications.onClicked.addListener(function(e,n){})}("undefined"==typeof window?window={}:window);
