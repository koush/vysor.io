!function(e,t){function n(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t}function o(e){return unescape(encodeURIComponent(e))}function i(e){return decodeURIComponent(escape(e))}function r(e){return"ArrayBuffer"==e.constructor.name&&(e=new Uint8Array(e)),i(String.fromCharCode.apply(null,e))}function s(e,t,n){e=o(e);var i=e.length;n&&i++,t||(t=new ArrayBuffer(i));var r=new Uint8Array(t);n&&(r[e.length]=0);for(var s=0,c=e.length;s<c;s++)r[s]=e.charCodeAt(s);return t}function c(e,t,n){"Object"==t.constructor.name&&(t=JSON.stringify(t)),u(e,t+"\n",n)}function a(e,t){function n(){e.read(function(i){for(var s=0;s<i.byteLength;s++)if(i[s]==A){var c=i.subarray(0,s);o.push(c);var a="";for(var d in o)d=o[d],a+=r(d);var u=i.subarray(s+1);return e.unshift(u),void t(a)}o.push(i),n()})}var o=[];n()}function d(e,t){function n(t){o+=r(t),e.read(n)}var o="";e.onClose=function(){t(o)},e.read(n)}function u(e,t,n){"Object"==t.constructor.name&&(t=JSON.stringify(t)),e.write(s(t),n)}function l(e,t){t||(t=window.location);for(var n=t.search.substring(1),o=n.split("&"),i=0;i<o.length;i++){var r=o[i].split("=");if(decodeURIComponent(r[0])==e)return decodeURIComponent(r[1])}}function h(e,t,n,o){return e||(e={items:[]}),e.items.push(t),e.timeout||(e.timeout=setTimeout(function(){delete e.timeout,o(e.items),e.items=[]},n)),e}function f(e){var t=document.createElement("textarea");t.style.position="fixed",t.style.top=0,t.style.left=0,t.style.width="2em",t.style.height="2em",t.style.padding=0,t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",t.value=e,document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch(e){console.log("Oops, unable to copy")}document.body.removeChild(t)}function p(e,t){if(console.log("notification:",e),window.chrome&&window.chrome.notifications){var n=chrome.runtime.getManifest(),o=n.name;t=t||n.icons[128],chrome.notifications.create({type:"basic",iconUrl:t,title:o,message:e})}}function y(){}function m(e,t){this.promise=fetch(e).then(function(e){this.connected=!0,this.response=e,this.reader=this.response.body.getReader(),this.reader.closed.then(function(){this.onClose&&this.dataReceived(null)}.bind(this)),this.onResume(),t(this)}.bind(this),function(e){t(null,e)})}function g(e){this.internalRead=this.read,this.read=this.readWrapper,this.file=e,this.fileRead=0}function v(){var e={showSoftKeys:!0,pinTitleBar:!0,alwaysOnTop:!1,bitrate:0,resolution:0,decoder:0,displaySettings:x[0],dimDisplay:!1};return e}function w(e){return e?(e.friendlyName&&!e.friendlyName.length&&delete e.friendlyName,e):null}function b(e){window.chrome&&window.chrome.storage?chrome.storage.local.get("device-settings",function(t){e(t["device-settings"]||{})}):e({})}function k(e,t){e||(e="web");var n=v();"inkwire"==e&&(n.pinTitleBar=!1,n.showSoftKeys=!1),b(function(o){t(w(o[e]||n))})}function S(e,t,n){return w(t),window.chrome&&window.chrome.storage&&e&&e.indexOf("127.0.0.1")==-1?void b(function(o){o[e]=t,chrome.storage.local.set({"device-settings":o},n)}):void(n&&n())}function C(){for(var e in x){var t=x[e],n=new Option;$(n).html(t.name),$("#display-settings").append(n)}}function R(e){$("#new-display-name").prop("value",e.friendlyName||null),$("#softkeys-check").prop("checked",!!e.showSoftKeys).change(),$("#pin-title-check").prop("checked",!!e.pinTitleBar).change(),$("#always-on-top-check").prop("checked",!!e.alwaysOnTop).change(),$("#bitrate").prop("selectedIndex",e.bitrate||0),$("#decoder").prop("selectedIndex",e.decoder||0),$("#resolution").prop("selectedIndex",e.resolution||0);var t=e.displaySettings&&e.displaySettings.name,n=0;for(var o in x){var i=x[o];if(i.name==t){n=o;break}}$("#display-settings").prop("selectedIndex",n),$("#dim-display").prop("checked",!!e.dimDisplay)}function I(e){var t=$("#notificationModal"),n=t.find("#modal-ok"),o=t.find("#modal-cancel");n.unbind("click"),o.unbind("click"),t.unbind("hidden.bs.modal"),e.cancelButton=e.cancelButton||"Cancel",e.okButton=e.okButton||"OK",e.title=e.title||chrome.runtime.getManifest().name,e.body=e.body||"",e.hideCancel?o.hide():o.show(),n.text(e.okButton),o.text(e.cancelButton),t.find("#modal-title").text(e.title),t.find("#modal-body").html(e.body);var i;n.click(function(){i=!0,e.ok&&e.ok()||$("#notificationModal").modal("hide")}),e.cancel&&(t.on("hidden.bs.modal",function(){i||e.cancel()}),o.click(e.cancel)),$("#notificationModal").modal(),e.duration&&setTimeout(function(){$("#notificationModal").modal("hide")},e.duration)}function D(e,t){I({title:e,body:t,duration:8e3,hideCancel:!0})}var A="\n".charCodeAt(0);(new Date).getTime();String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(e,t){return t=t||0,this.lastIndexOf(e,t)===t}}),Object.fromArray=function(e){var t={};for(var n in e){var o=e[n];t[o]=o}return t},$.ajaxTransport("+binary",function(e,t,n){if(window.FormData&&(e.dataType&&"binary"==e.dataType||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob)))return{send:function(t,n){var o=new XMLHttpRequest,i=e.url,r=e.type,s=e.async||!0,c=e.responseType||"blob",a=e.data||null,d=e.username||null,u=e.password||null;o.addEventListener("load",function(){var t={};t[e.dataType]=o.response,n(o.status,o.statusText,t,o.getAllResponseHeaders())}),o.open(r,i,s,d,u);for(var l in t)o.setRequestHeader(l,t[l]);o.responseType=c,o.send(a)},abort:function(){n.abort()}}});(function(){var e={};return function(t,n){if(e[t])return void n(e[t]);var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="blob",o.onload=function(o){n(e[t]=window.URL.createObjectURL(this.response))},o.send()}})();!function(){function*e(){}var t=e();t.constructor.prototype.async=function(){function e(){i=o.throw(new Error(arguments)),n()}function t(){var e=arguments[0];i=o.next(e),n()}function n(n){var r,s;if(!i.done){if(!i.value)return void(i=o.next(t));if(i.value.constructor==Promise)return void i.value.then(t).catch(e);if(i.value==Error)r=!0,i=o.next(e);else{if(i.value!=y)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");s=!0,i=o.next(t)}if(!i.value)throw new Error("Double yield callbacks must explicitly define both Error and Success");if(i.value==Error&&r)throw new Error("Error callback already defined");if(i.value==y&&s)throw new Error("Success callback already defined");if(i.value!=Error&&i.value!=y)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");i=r?o.next(t):o.next(e)}}var o=this,i=o.next();i.done||n()}}(),window.isElectron=function(){return navigator.userAgent.indexOf("Electron")!=-1},isElectron()||(window.sharedGlobals=window),function(){function e(e){try{for(var t in e)e[t]&&e[t].constructor!=String&&(e[t]=JSON.stringify(e[t]));i+=e.join(" ")+"\n"}catch(e){}}function t(e){return new Promise(function(t,n){return e.getConsoleLog?void e.getConsoleLog(function(e){t({content:e&&e.length?e:"log is empty"})}):void t("getConsoleLog not found")})}var n=console.log,o=console.error,i="";console.error=function(){o.apply(console,arguments),e(Array.prototype.slice.call(arguments))},console.log=function(){n.apply(console,arguments),e(Array.prototype.slice.call(arguments))},sharedGlobals.getConsoleLog=function(e){e(i)},window.gistConsoleLog=function(e,n){chrome.runtime.getBackgroundPage(function(o){t(o).then(function(n){e["background.txt"]=n;var o=chrome.app.window.getAll(),i=o.map(function(n){return t(n.contentWindow).then(function(t){e["window-"+n.id+".txt"]=t})});return Promise.all(i)}).then(function(){var t={description:chrome.runtime.getManifest().name+" console log",public:!1,files:e};fetch("https://api.github.com/gists",{method:"POST",body:JSON.stringify(t)}).then(function(e){e.json().then(function(e){n(e.html_url)})})})})}}(),function(){function e(e){this.buffer=new ArrayBuffer(e),this.dataView=new DataView(this.buffer),this.uint8array=new Uint8Array(this.buffer),this.littleEndian=!1,this.position=0,this.limit=e,this.capacity=e}function t(t,n){var o=8*n,i=t+o,r="get"+i,s="set"+i,c="put"+i;e.prototype[r]=function(){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");var e=this.dataView[r](this.position,this.littleEndian);return this.position+=n,e},e.prototype[c]=function(e){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");if(null==e||void 0==e||NaN==e||e.constructor!=Number)throw new Error("no value provided");return this.dataView[s](this.position,e,this.littleEndian),this.position+=n,this}}e.prototype.flip=function(){this.limit=this.position,this.position=0},e.prototype.asUint8Array=function(){return this.uint8array.subarray(this.position,this.limit)};var n={Int:[1,2,4],Uint:[1,2,4],Float:[4,8]};for(var o in n){var i=n[o];for(var r in i){var r=i[r];t(o,r)}}e.prototype.put=function(e){if(e.constructor==Number)return this.putInt8(e);if(e.constructor==String&&(e=s(e)),e.constructor==ArrayBuffer&&(e=new Uint8Array(e)),this.position+e.byteLength>this.limit)throw new Error("Not enough room in byte buffer");return this.uint8array.set(e,this.position),this.position+=e.byteLength,this},e.prototype.putByte=e.prototype.putInt8,e.prototype.putShort=e.prototype.putInt16,e.prototype.putInt=e.prototype.putInt32,e.prototype.putFloat=e.prototype.putFloat32,e.prototype.putDouble=e.prototype.putFloat64,window.ByteBuffer=e}(),window.chrome&&window.chrome.sockets&&(chrome.sockets.tcp.onReceive.addListener(function(e){var t=Socket.readers[e.socketId];null!=t&&t.dataReceived(new Uint8Array(e.data))}),chrome.sockets.tcp.onReceiveError.addListener(function(e){var t=Socket.readers[e.socketId];null!=t&&(t.destroy(),t.dataReceived(null))}),chrome.sockets.tcpServer.onAccept.addListener(function(e){chrome.sockets.tcp.setPaused(e.clientSocketId,!1);var t=Server.listeners[e.socketId];null!=t&&t(new Socket({socketId:e.clientSocketId}))})),function(){function e(t,n){if(t.socketId)this.socketId=t.socketId,e.readers[this.socketId]=this;else if(window.chrome&&window.chrome.sockets)chrome.sockets.tcp.create(function(o){this.socketId=o.socketId,chrome.sockets.tcp.connect(this.socketId,t.host,t.port,function(t){t?(chrome.runtime.lastError,this.destroy(),n(null)):(e.readers[o.socketId]=this,n(this))}.bind(this))}.bind(this));else{var o;t.ns?(this.ns=t.ns,o=!0):(this.ns=new require("net").Socket(),this.ns.connect({port:t.port,host:t.host},function(){o=!0,n(this)}.bind(this))),this.ns.on("close",function(){this.destroy(),o||n(null)}.bind(this)),this.ns.on("data",function(e){this.dataReceived(e)}.bind(this))}}function t(){}e.readers={},e.connect=function(t,n){return new e(t,n)},e.pump=function(e,t,n){if(!e||!t)return console.error("Socket.pump called with null socket",e,t),void n();var o=function(){e.read(i)}.bind(e),i=function(e){var n=e.buffer;(e.byteOffset||e.length!=n.byteLength)&&(n=n.slice(e.byteOffset,e.byteOffset+e.length)),t.write(n,o)}.bind(t);e.read(i),e.onClose=n},e.stream=function(t,n,o){e.pump(t,n,function(){if(n&&n.destroy(),o){var e=o;o=null,e()}}),e.pump(n,t,function(){if(t&&t.destroy(),o){var e=o;o=null,e()}})},e.eat=function(e){function t(){e.read(t)}t()},e.prototype.read=function(){if(this.pendingCallback)throw new Error("double callback");if(this.closed&&!this.pending){var e=this.onClose;return void(e&&(delete this.onClose,e()))}var t=0;"Number"==arguments[t].constructor.name?this.pendingLength=arguments[t++]:this.pendingLength=0;var e=arguments[t];if(!this.pending||this.paused)return void(this.pendingCallback=e);if(this.pendingLength){if(this.pendingLength>this.buffered())return void(this.pendingCallback=e)}else this.pendingLength=this.buffered();for(var n,o=0;o<this.pendingLength;){var i=this.pending.shift();this.bufferedLength-=i.length,this.pending.length||delete this.pending;var r=i,s=Math.min(r.byteLength,this.pendingLength-o);if(s!=r.byteLength){var c=r.subarray(0,s),a=r.subarray(s);this.unshift(a),r=c}n||r.byteLength==this.pendingLength||(n=new Uint8Array(this.pendingLength)),n?n.set(r,o):n=r,o+=r.byteLength}e(n)},e.prototype.write=function(e,t){if(this.pendingWrite&&console.error("write is already in progress!"),null==t&&(console.error("write callback is null?"),t=function(){}),this.pendingWrite=t,window.chrome&&window.chrome.sockets)chrome.sockets.tcp.send(this.socketId,e,function(n){return chrome.runtime.lastError,!n||n.resultCode?void delete this.pendingWrite:void(n.bytesSent<e.byteLength?this.write(e.slice(n.bytesSent),t):(delete this.pendingWrite,t()))}.bind(this));else{if(!this.ns)return;if(!e.byteLength)return void require("process").nextTick(function(){delete this.pendingWrite,t()}.bind(this));const n=window.Buffer||require("buffer").Buffer;this.ns.write(n.from(e),function(){delete this.pendingWrite,t()}.bind(this))}},e.prototype.destroy=function(e,t){window.chrome&&window.chrome.sockets?chrome.sockets.tcp.close(this.socketId,function(){chrome.runtime.lastError}):(this.dataReceived(null),this.ns&&(this.ns.destroy(),delete this.ns))},e.prototype.unshift=function(e){0!=e.byteLength&&(this.pending?this.pending.unshift(e):this.pending=[e],this.bufferedLength||(this.bufferedLength=0),this.bufferedLength+=e.length)},e.prototype.dataReceived=function(e){if(e&&(e.asUint8Array&&(e=e.asUint8Array()),e.constructor==ArrayBuffer&&(e=new Uint8Array(e))),e&&e.length){var t=new Uint8Array(e);this.pending?this.pending.push(t):this.pending=[t]}if(null==e?this.closed=!0:(this.bufferedLength||(this.bufferedLength=0),this.bufferedLength+=e.length),this.paused||!this.pending||!this.pending.length){var n=this.onClose;return void(this.closed&&n&&(delete this.onClose,n()))}var o=this.pendingLength,n=this.pendingCallback;n&&(delete this.pendingCallback,this.read(o,n))},e.prototype.buffered=function(){return this.bufferedLength},e.prototype.pause=function(){this.paused||(this.paused=!0,this.onPause())},e.prototype.resume=function(){this.paused&&(this.paused=!1,this.onResume())},e.prototype.onResume=function(){chrome.sockets.tcp.setPaused(this.socketId,!1,function(){})},e.prototype.onPause=function(){chrome.sockets.tcp.setPaused(this.socketId,!0,function(){})},t.listeners={},t.prototype.__proto__=e.prototype,t.prototype.destroy=function(){window.chrome&&window.chrome.sockets?chrome.sockets.tcpServer.close(this.socketId,function(){chrome.runtime.lastError}):this.ns&&(this.ns.close(),delete this.ns)},t.prototype.listen=function(n,o,i){var r,s;"Number"==n.constructor.name?(r=n,s="0.0.0.0"):(s=n.address,r=n.port),window.chrome&&window.chrome.sockets?chrome.sockets.tcpServer.create(function(e){this.socketId=e.socketId,t.listeners[this.socketId]=o,chrome.sockets.tcpServer.listen(e.socketId,s,r,function(e){return chrome.runtime.lastError,e?(this.destroy(),void(i&&i(e))):void chrome.sockets.tcpServer.getInfo(this.socketId,function(t){this.localAddress=t.localAddress,this.localPort=t.localPort,i&&i(e)}.bind(this))}.bind(this))}.bind(this)):(this.ns=require("net").createServer(function(t){o(new e({ns:t}))}.bind(this)),this.ns.on("close",function(){this.destroy()}.bind(this)),this.ns.on("error",function(e){i&&i(e)}.bind(this)),this.ns.on("listening",function(){var e=this.ns.address();this.localAddress=e.address,this.localPort=e.port,i&&i()}.bind(this)),this.ns.listen({port:r,host:s}))},window.Socket=e,window.Server=t}(),m.connect=function(e,t){new m(e,t)},m.prototype.write=function(e,t){throw new Error("write not supported on fetch socket")},m.prototype.destroy=function(){this.promise&&this.promise.cancel&&this.promise.cancel()},m.prototype.unshift=Socket.prototype.unshift,m.prototype.dataReceived=Socket.prototype.dataReceived,m.prototype.read=Socket.prototype.read,m.prototype.pause=Socket.prototype.pause,m.prototype.resume=Socket.prototype.resume,m.prototype.buffered=Socket.prototype.buffered,m.prototype.onPause=function(){},m.prototype.onResume=function(){this.reader.read().then(function(e){e.value&&(this.dataReceived(e.value),this.paused||this.onResume())}.bind(this))},function(){function e(e,t){this.conn=e,this.dc=t,this.gotEof=!1,t.onmessage=function(e){var t=new Uint8Array(e.data),n=1==t[t.byteLength-1];this.dataReceived(t.subarray(0,t.byteLength-1)),n&&(this.gotEof=!0,this.destroy())}.bind(this),t.onclose=t.onerror=this.destroy.bind(this),this.needsBufferShim=!0}function t(e,t,n){this.manager=e,this.pc=t,this.key=n,this.pc.oniceconnectionstatechange=function(){"new"!=this.pc.iceConnectionState&&"checking"!=this.pc.iceConnectionState&&delete e.gcmRtcConnections[n],"disconnected"!=this.pc.iceConnectionState&&"closed"!=this.pc.iceConnectionState||this.destroy()}.bind(this)}function n(e,t,n){this.senders=e,this.registrationId=t,this.rtcc=n,this.gcmRtcConnections={},this.gcmRtcListeners={}}e.prototype.buffered=Socket.prototype.buffered,e.prototype.unshift=Socket.prototype.unshift,e.prototype.dataReceived=Socket.prototype.dataReceived,e.prototype.read=Socket.prototype.read,e.prototype.pause=Socket.prototype.pause,e.prototype.resume=Socket.prototype.resume,e.prototype.buffered=Socket.prototype.buffered,e.prototype.writeable=function(){var e=this.writeCallback;e&&(delete this.writeCallback,e())},e.prototype.write=function(e,t){if(!this.dc||"open"!=this.dc.readyState)return void this.destroy();this.writeCallback=t;var n=new Uint8Array(e.byteLength+1);if(n.set(new Uint8Array(e)),this.dc.send(n.buffer),!this.reentrantWrite)try{for(this.reentrantWrite=!0;this.writeCallback&&(0==this.dc.bufferedAmount||this.needsBufferShim);)this.writeable()}finally{this.reentrantWrite=!1}},e.prototype.destroy=function(){if(this.dataReceived(null),null!=this.dc){var e=this.dc;if(this.dc=null,e.onclose=null,e.onerror=null,"open"==e.readyState)try{e.send(new Uint8Array([1])),this.gotEof?this.conn.recycleChannel(e):this.conn.waitForEof(e)}catch(e){}}},t.prototype.waitForCommand=function(t){t.onmessage=function(n){if(1!=n.data.byteLength){this.removeChannel(t);var o=r(n.data),i=new e(this,t);this.openSocket(o,i)}}.bind(this)},t.prototype.compactChannels=function(){this.inboundChannels&&!this.inboundChannels.length&&(this.inboundChannels=null),this.outboundChannels&&!this.outboundChannels.length&&(this.outboundChannels=null)},t.prototype.getAppropriateChannels=function(e,t){var n;return e.inbound?(!this.inboundChannels&&t&&(this.inboundChannels=[]),n=this.inboundChannels):(!this.outboundChannels&&t&&(this.outboundChannels=[]),n=this.outboundChannels),n},t.prototype.removeChannel=function(e){if(channels=this.getAppropriateChannels(e),channels){var t=channels.indexOf(e);t!=-1&&(channels.splice(t,1),this.compactChannels())}},t.prototype.waitForEof=function(e){e.onmessage=function(t){var n=new Uint8Array(t.data),o=1==n[n.byteLength-1];o&&this.recycleChannel(e)}.bind(this)},t.prototype.recycleChannel=function(e){var t=this.getAppropriateChannels(e,!0);t.push(e),e.onclose=e.onerror=function(){this.removeChannel(e)}.bind(this),this.waitForCommand(e)},t.prototype.addCandidates=function(e){for(var t in e.candidates)this.pc.addIceCandidate(new RTCIceCandidate(e.candidates[t]))},t.prototype.setupPinger=function(e){function t(){e.send(s("ping")),n=setTimeout(t,1e3)}var n;e.onmessage=function(e){},e.onclose=e.onerror=function(){clearTimeout(n),this.destroy()}.bind(this),t()},t.prototype.listenSockets=function(){this.pc.ondatachannel=function(e){e.channel.inbound=!0,this.waitForCommand(e.channel)}.bind(this)},t.prototype.prepareChannel=function(e){var t=this.pc.createDataChannel(e||"gcm",{reliable:!0,ordered:!0});return t.binaryType="arraybuffer",t},t.prototype.newSocket=function(t,n){if("closed"==this.pc.signalingState)return void n();if(this.outboundChannels){var o=this.outboundChannels.shift();this.compactChannels(),o.send(s(t));var i=new e(this,o);return void n(i,this)}var o=this.prepareChannel("gcm");o.onopen=function(){o.send(s(t));var i=new e(this,o);n(i,this)}.bind(this)},t.prototype.destroy=function(){delete this.manager.gcmRtcConnections[this.key],"closed"!=this.pc.signalingState&&this.pc.close();var e=this.onClose;e&&(delete this.onClose,e())},n.prototype.onMessage=function(e){var t=JSON.parse(e.message),o=e.type,i=e.senderId,r=e.src,s=e.srcPort,c=e.dstPort;if("offer"==o){var a=this.gcmRtcListeners[c];return void(a?a.listener.incoming(i,r,s,c,t,a.listenCallback):console.log("not listening on "+c))}if("answer"==o){var d=n.getKey(r,s,c),u=this.gcmRtcConnections[d];return u?void u.manager.incoming(i,r,s,c,t):void console.log("pending connection not found")}n.onUnknownMessage?n.onUnknownMessage(e):console.log("unknown message "+o)},n.hasLoadedChannels=!1,n.start=function(e,t,o){if(console.log("starting GtcRtcManger"),window.chrome&&window.chrome.gcm){var i=Object.keys(e);chrome.gcm.register(i,function(i){if(chrome.runtime.lastError,!i)return void o();var r=new n(e,i,t);chrome.gcm.onMessage.addListener(function(e){r.onMessage(e.data)}),o(r)})}else{var r=new n(e,null,t);$.getScript("https://push.clockworkmod.com/socket.io/socket.io.js",function(){var e=io("https://push.clockworkmod.com");e.on("registration",function(e){e="web:"+e,r.registrationId?(r.registrationId=e,r.onRegistrationIdChanged&&r.onRegistrationIdChanged(e)):(r.registrationId=e,o(r))}),e.on("data",function(e){r.onMessage(e)})})}},n.prototype.ensureChannel=function(){function e(){return delete n.channelPromise,n.gcmRtcConnections={},n.channel&&(delete n.channel,!Object.keys(n.gcmRtcListeners).length)?void console.log("not reconnecting, no listeners"):void t()}function t(){console.error("scheduling gcm reconnect"),n.reconnectTimeout=h(n.reconnectTimeout,null,3e5,function(){console.error("reconnecting gcm"),n.ensureChannel()})}if(this.channel)return Promise.resolve();var n=this;return this.channelPromise?this.channelPromise:this.channelPromise=new Promise(function(o,i){$.ajax({type:"GET",url:"https://vysor-1026.appspot.com/listen",error:function(){delete n.channelPromise,console.error("error ensuring gcm channe",error),t()},success:function(t){var i=new goog.appengine.Channel(t.token),r={onopen:function(){n.channel=i;var e="web:"+t.channel;n.registrationId=e,n.onRegistrationIdChanged&&n.onRegistrationIdChanged(e),o()},onmessage:function(e){n.onMessage(JSON.parse(e.data))},onerror:function(){console.error("gcm onerror",arguments),e()},onclose:function(){console.error("gcm onclose",arguments),e()}};i.open(r)}})})},n.prototype.sendGcm=function(e,t,n,o,i,r){e||(e=this.defaultSenderId),t.startsWith("web:")?$.ajax({type:"POST",url:"https://vysor-1026.appspot.com/send",data:JSON.stringify({channel:t.substring(4),data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:i,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",success:function(){}}):$.ajax({type:"POST",url:"https://gcm-http.googleapis.com/gcm/send",headers:{Authorization:"key="+this.senders[e]},data:JSON.stringify({to:t,data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:i,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",error:function(){console.log("gcm error",arguments)},success:function(){console.log("gcm",arguments)}})},n.getKey=function(e,t,n){return n+":"+t+":"+e},n.prototype.setupPeerConnection=function(e,o,i,r,s,c){var a,d=window.RTCPeerConnection||window.webkitRTCPeerConnection,u=new d(this.rtcc),l=function(t){var n=[];for(var a in t)a=t[a],n.push(a),JSON.stringify(n).length>3200&&(this.sendGcm(o,i,r,s,e,{desc:c(),candidates:n}),n=[]);n.length>0&&this.sendGcm(o,i,r,s,e,{desc:c(),candidates:n})}.bind(this);u.onicecandidate=function(e){null!=e.candidate&&(console.log(e.candidate),a=h(a,e.candidate,500,l))}.bind(this);var f=n.getKey(i,r,s),p=new t(this,u,f);return u.onsignalingstatechange=function(e){"stable"==u.signalingState?this.gcmRtcConnections[f]==p:"closed"==u.signalingState&&p.destroy()}.bind(this),this.gcmRtcConnections[f]=p,p},n.gcmPortCount=0,n.prototype.connect=function(e,t){function o(e){u.createOffer(e).then(function(e){i=e,u.setLocalDescription(e)})}var i,r=e.senderId,s=e.registrationId,c=e.port,a=n.gcmPortCount++,d=this.setupPeerConnection("offer",r,s,c,a,function(){return i}),u=d.pc;if(e.audio)navigator.webkitGetUserMedia({audio:!0,video:!1},function(e){u.addStream(e),u.onaddstream=function(e){console.log("got the remote stream"),t(d,e)},o({offerToReceiveAudio:!0,offerToReceiveVideo:!1,voiceActivityDetection:!1})},function(){console.error("audio fail",arguments),o({offerToReceiveAudio:!0,offerToReceiveVideo:!1,voiceActivityDetection:!1})});else{var l=d.prepareChannel("pinger");l.onopen=function(){console.log("got rtc pinger"),d.setupPinger(l),t(d)},d.listenSockets(),o({})}},n.prototype.isListening=function(e){return null!=this.gcmRtcListeners[e]},n.prototype.stopListen=function(e){delete this.gcmRtcListeners[e]},n.prototype.listen=function(e,t){return this.gcmRtcListeners[e]?void console.log("already listening on gcm port "+e):void(this.gcmRtcListeners[e]={listener:this,listenCallback:t})},n.prototype.incoming=function(e,t,o,i,r,s){var c=n.getKey(t,o,i),a=this.gcmRtcConnections[c];if(a){if(!a.remoteDesc){a.remoteDesc=new RTCSessionDescription(r.desc);var d=a.pc;d.setRemoteDescription(a.remoteDesc)}}else{var u;a=this.setupPeerConnection("answer",e,t,o,i,function(){return u}),a.remoteDesc=new RTCSessionDescription(r.desc);var d=a.pc;d.ondatachannel=function(e){console.log("got rtc pinger"),this.setupPinger(e.channel),s(a),this.listenSockets()}.bind(a),d.setRemoteDescription(a.remoteDesc,function(){d.createAnswer().then(function(e){u=e,d.setLocalDescription(e)},function(){console.error("answer error",arguments)})})}a.addCandidates(r)},window.GcmRtcSocket=e,window.GcmRtcManager=n}(),g.prototype.write=function(e,t){throw new Error("write not supported on file socket")},g.prototype.destroy=function(){},g.prototype.buffered=Socket.prototype.buffered,g.prototype.unshift=Socket.prototype.unshift,g.prototype.dataReceived=Socket.prototype.dataReceived,g.prototype.read=Socket.prototype.read,g.prototype.pause=Socket.prototype.pause,g.prototype.resume=Socket.prototype.resume,g.prototype.buffered=Socket.prototype.buffered,g.prototype.onPause=function(){},g.prototype.onResume=function(){},g.prototype.readWrapper=function(){if(this.internalRead.apply(this,arguments),this.pendingCallback){var e=this.pendingLength;if(e||(e=65536),e=Math.min(this.file.size-this.fileRead,e),0==e)return void this.dataReceived(null);var t=this.file.slice(this.fileRead,this.fileRead+e);this.fileRead+=e;var n=new FileReader;n.addEventListener("loadend",function(e){this.dataReceived(new Uint8Array(n.result))}.bind(this)),n.readAsArrayBuffer(t)}},function(){function e(){}var t={};t.sendHostCommand=function(e,t){Socket.connect({host:"127.0.0.1",port:5037},function(o){if(!o)return void t();var i=e;e=n(e.length)+e,o.read(4,function(e){var n=r(e);return"OKAY"!=n?(console.error("error in response to adb host command",i,n),o.destroy(),void t()):void o.read(4,function(e){var n=r(e);return e=parseInt(n,16),0==e||"OKAY"==n?void t(o,new ArrayBuffer(0)):void o.read(e,function(e){t(o,e)})})}),o.write(s(e),function(){})})},t.devices=function(e){function n(e){var t=e;e=e.replace("\t"," ");var n=e.indexOf(" ");if(n!=-1){var i=e.substring(0,n);e=e.substring(n).trim();for(var r;r!=e;)r=e,e=e.replace("  "," ");var s={},c=e.indexOf(" ");c==-1&&(c=e.length);var a=e.substring(0,c);for(e=e.substring(c+1);e.length&&(n=e.indexOf(":"),n!=-1);){var d,u=e.substring(0,n),l=e.substring(n+1),h=l.indexOf(" "),f=l.indexOf(":");if(h==-1||f==-1)d=l,e="";else for(;h!=-1&&h<f;)d=l.substring(0,h),e=l.substring(h+1),h=l.indexOf(" ",h+1);s[u]=d}var p;p=s.model?s.model.replace("_"," "):i,o[i]={serialno:i,name:p,status:a,properties:t}}}var o={};t.sendHostCommand("host:devices-l",function(t,i){if(!t)return void e();t.destroy(),i=r(i),console.log("ADB devices:",i),i=i.trim();var s=i.split("\n");for(var c in s)c=s[c],n(c);e(o)})},t.killServer=function(e){t.sendHostCommand("host:kill-server",function(t,n){return t?(t.destroy(),n=r(n),void(e&&e())):void e()})},t.sendClientCommand=function(e,t){var o=e.command,i=e.serialno;Socket.connect({host:"127.0.0.1",port:5037},function(e){if(!e)return void t();e.read(4,function(i){var c=r(i);if("OKAY"!=c)return e.destroy(),void t(null);var a=o;a=n(a.length)+a,e.read(4,function(n){var o=r(n);return"OKAY"!=o?(e.destroy(),void t(null)):void t(e)}),e.write(s(a),function(){})});var c="host:transport:"+i;c=n(c.length)+c,e.write(s(c),function(){})})},t.shell=function(e,n){var o=e.command;e.serialno;t.getOrCreateSockFactory(e).newSocket("shell:"+o,function(e){return e?void d(e,function(e){n(e)}):void n()})},t.forward=function(e,n){var o="host-serial:"+e.serialno+":forward:"+e.from+";"+e.to;t.sendHostCommand(o,function(e,t){e&&e.destroy(),n(e,t)})},e.MKID=function(e,t,n,o){return e.charCodeAt(0)|t.charCodeAt(0)<<8|n.charCodeAt(0)<<16|o.charCodeAt(0)<<24},e.ID_RECV=e.MKID("R","E","C","V"),e.ID_SEND=e.MKID("S","E","N","D"),e.ID_DONE=e.MKID("D","O","N","E"),e.ID_DATA=e.MKID("D","A","T","A"),e.DATA_MAX=65536,t.pull=function(n,o){var i=n.file,r=(n.serialno,n.fileEntry),c=n.socket;c||!function(){var e;c={write:function(t,n){return e?(e.onwriteend=n,void e.write(new Blob([t]))):void r.createWriter(function(o){e=o,c.write(t,n)})}}}();var a=new DummySocket;Socket.pump(a,c,function(){o(r)}),t.getOrCreateSockFactory(n).newSocket("sync:",function(t){function n(e){t.read(e,function(e){a.dataReceived(e),r()})}function r(){t.read(8,function(i){var r=new DataView(i.buffer,i.byteOffset,i.byteLength),s=r.getUint32(0,!0);if(s==e.ID_DATA){var c=r.getUint32(4,!0);return void n(c)}return t.destroy(),s==e.ID_DONE?void a.dataReceived(null):void o()})}if(!t)return void o();var c=new ArrayBuffer(8),d=new DataView(c);d.setUint32(0,e.ID_RECV,!0),d.setUint32(4,i.length,!0),t.write(c,function(){t.write(s(i),function(){r()})})})},t.createSocketFactory=function(e){return{newSocket:function(n,o){t.sendClientCommand({serialno:e,command:n},o)}}},t.getOrCreateSockFactory=function(e){return e.socketFactory||t.createSocketFactory(e.serialno)},t.push=function(n,o){var i=n.file,r=(n.serialno,n.socket);t.getOrCreateSockFactory(n).newSocket("sync:",function(t){if(!t)return void o();var n=new ArrayBuffer(8),c=new DataView(n),a=i+",0644";c.setUint32(0,e.ID_SEND,!0),c.setUint32(4,a.length,!0),t.write(n,function(){t.write(s(a),function(){function n(){r.read(function(t){if(t.byteLength>e.DATA_MAX){var n=t.subarray(e.DATA_MAX);t=t.subarray(0,e.DATA_MAX),r.unshift(n)}i(t)})}function i(o){var i=new ArrayBuffer(8),r=new DataView(i);r.setUint32(0,e.ID_DATA,!0),r.setUint32(4,o.byteLength,!0),t.write(i,function(){var e=o.buffer;(o.byteOffset||o.length!=e.byteLength)&&(e=e.slice(o.byteOffset,o.byteOffset+o.byteLength)),t.write(e,function(){n()})})}r.onClose=function(){var n=new ArrayBuffer(8),i=new DataView(n);i.setUint32(0,e.ID_DONE,!0),i.setUint32(4,0,!0),t.write(n,function(){t.read(8,function(){o()})})},n()})})})},window.Adb=t}();var x=[{name:"Default Settings",size:"reset",density:"reset"},{name:"Resizable (96dpi)",size:"reset",density:"96",freeSize:!0},{name:"Resizable (144dpi)",size:"reset",density:"144",freeSize:!0},{name:"1080p (96dpi)",size:"1920x1080",density:"96"},{name:"4K (144dpi)",size:"3840x2160",density:"144"},{name:"Galaxy Nexus",size:"720x1280",density:"320"},{name:"Nexus 4",size:"768x1280",density:"320"},{name:"Nexus 5",size:"1080x1920",density:"480"},{name:"Nexus 6",size:"1440x2560",density:"560"},{name:"Nexus 6p",size:"1440x2560",density:"560"},{name:"Nexus 7 (2012)",size:"800x1280",density:"213"},{name:"Nexus 7 (2013)",size:"1200x1920",density:"320"},{name:"Nexus 9",size:"1536x2048",density:"320"}];!function(){function e(e,t,n,o){this.socket=e,this.videoOnly=!0;var i=new ByteBuffer(1024);i.put("FLV"),i.put(1),this.videoOnly?i.put(1):i.put(5),i.putInt(9),i.putInt(0),i.flip(),this.socket.dataReceived(i),this.setParameter(t,n,o)}function t(e,t){return e.put(a),e.putDouble(t),e}function n(e,t){var n=s(t);return e.putShort(n.byteLength),e.put(n),e}function o(e,t){return e.putShort(t>>8&65535),e.put(255&t),e}var i=9,r=9,c=18,a=0,d=2,u=8,l=7,h=4,f=1<<h|7,p=2<<h|7;e.prototype.setParameter=function(e,r,s){var a=new ByteBuffer(1024);
a.put(c),this.videoOnly?o(a,182):o(a,290),o(a,0),a.putInt(0);var h=a.position;a.put(d),n(a,"onMetaData"),a.put(u),this.videoOnly?a.putInt(7):a.putInt(12),n(a,"duration"),t(a,0),n(a,"width"),t(a,e),n(a,"height"),t(a,r),n(a,"framerate"),t(a,s),n(a,"videocodecid"),t(a,l),n(a,"videodatarate"),t(a,0),this.videoOnly||(n(a,"audiodatarate"),t(a,62.5),n(a,"audiosamplerate"),t(a,5112),n(a,"audiosamplesize"),t(a,8),n(a,"stereo"),a.put(0),n(a,"audiocodecid"),t(a,0)),n(a,"encoder"),a.put(d),n(a,"Lavf52.87.1"),n(a,"filesize"),t(a,0),n(a,""),a.put(i);var f=a.position,p=f-h;a.putInt(p+11),a.flip(),this.socket.dataReceived(a)},e.prototype.addVideoHeader=function(e){for(var t=4;t<e.length&&(0!=e[t+0]||0!=e[t+1]||0!=e[t+2]||1!=e[t+3]);t++);var n=e.subarray(0,t),i=e.subarray(t),s=new ByteBuffer(1024),c=n.length-4+i.length-4+16;s.put(r),o(s,c),o(s,0),s.put(0),o(s,0),s.put(7|f),s.put(0),o(s,0),s.put(1),s.put(n[5]),s.put(n[6]),s.put(n[7]),s.put(255),s.put(225),s.putShort(n.length-4),s.put(n.subarray(4)),s.put(1),s.putShort(i.length-4),s.put(i.subarray(4)),s.putInt(11+c),s.flip(),this.socket.dataReceived(s)},e.prototype.addVideoFrame=function(e,t,n){var i=new ByteBuffer(1024);i.put(r),o(i,5+e.length),this.firstPresentationTimestampMs||(this.firstPresentationTimestampMs=t);var s=t-this.firstPresentationTimestampMs;o(i,s),i.put(s>>24&255),o(i,0),i.put(n?f:p),i.put(1),o(i,0),i.flip();var c=new ByteBuffer(e.length);c.put(e),c.flip(),c.putInt(e.length-4),c.position=0;var a=new ByteBuffer(1024);a.putInt(16+e.length),a.flip(),this.socket.dataReceived(i),this.socket.dataReceived(c),this.socket.dataReceived(a)},window.FlashPackager=e}();var E,T;!function(){function e(e){T&&(e.clientX&&(e.downDelta=Date.now()-W,_||(_=$("#mirror")),e.clientX=e.clientX/_.width()*M,e.clientX>M||e.clientX<0)||e.clientY&&(_||(_=$("#mirror")),e.clientY=e.clientY/_.height()*P,e.clientY>P||e.clientY<0)||T.send(JSON.stringify(e)))}function t(t,o){if(t){if("String"==t.constructor.name){if(t.startsWith("KEYCODE_"))return e({type:"keyevent",keyevent:t}),!0;switch(t){case"VYSOR_SHOW_TITLE_BAR":n();break;default:return}return!0}return"Number"==t.constructor.name?(e({type:"keycode",keycode:t}),!0):t.keyevent?(e({type:"keyevent",keyevent:t.keyevent,shift:!!(t.shiftKey&&o&&o.shiftKey)}),!0):t.keycode?(e({type:"keycode",keycode:t.keycode,shift:!!(t.shiftKey&&o&&o.shiftKey)}),!0):void 0}}function n(){return"inkwire"==L?void $(".head").hide():X?(clearTimeout(F),void $(".head").fadeTo(0,1)):($(".head").fadeTo(0,.8),clearTimeout(F),void(F=setTimeout(function(){$(".head").fadeOut()},2e3)))}function o(e,t){if(s())N=M,z=P;else if(window.chrome&&window.chrome.app&&window.chrome.app.window&&r()&&(N=screen.availWidth,z=screen.availHeight),t==M&&e==P){var n=N;N=z,z=n}else{var o;o=M>P?Math.max(innerWidth,innerHeight):Math.min(innerWidth,innerHeight);var i=o*(P/M);N=o,z=i}d()}function i(){return!window.chrome||!window.chrome.app||!window.chrome.app.window}function r(){return document.webkitFullscreenElement||document.msFullscreenElement||document.mozFullscreenElement||document.fullscreenElement}function s(){return O&&O.displaySettings&&O.displaySettings.freeSize}function d(){var e=innerWidth,t=innerHeight,n=screen.availWidth,o=screen.availHeight;(r()||s()||i())&&(n=e,o=t),N>n&&(N=n,z=P/M*N);var c=0;if(z+H+X+c>o&&(z=o-H-X-c,N=M/P*z),N&&z){var a=Math.round(N),d=Math.round(z+H+X);r()||s()||(isElectron()?(Math.abs(innerWidth-a)>=2||Math.abs(innerHeight-d)>=2)&&chrome.app.window.current().w.setContentSize(a,d):window.chrome&&window.chrome.app&&window.chrome.app.window&&(Math.abs(innerWidth-a)>=2&&(chrome.app.window.current().innerBounds.width=a),Math.abs(innerHeight-d)>=2&&(chrome.app.window.current().innerBounds.height=d)));var u=(e-N)/2,l=$("#mirror, #listener");l.css("left",u),l.css("top",(t-z-H+X)/2),$(".foot").width(N),$(".foot").css("left",u),$(".overlay").width(N),$(".overlay").css("left",u),l=$("#mirror, embed, #listener"),l.width(Math.round(N)),l.height(Math.round(z));var h=$("canvas")[0];h.width=Math.round(N),h.height=Math.round(z),$("#dead, #drag, #reconnect").width(N),$("#dead, #drag, #reconnect").height(z+H+X)}}function u(e){window.chrome&&window.chrome.storage&&chrome.storage.local.get(["vysorUsage","vysorDailyUsage","lastDailyReport"],function(t){var n=t.vysorUsage,o=t.lastDailyReport,i=t.vysorDailyUsage,r=Date.now();if(n||(n=0),i||(i=0),o){if(r>o+864e5){var s=i/36e5;s=Math.round(2*s)/2,s<=24&&s>=0&&(tracker.sendEvent("daily-usage",s.toString()),tracker.sendEvent("daily-usage-licensed",_lm._il)),i=0,chrome.storage.local.set({lastDailyReport:r})}}else chrome.storage.local.set({lastDailyReport:r});n+=e,i+=e,chrome.storage.local.set({vysorUsage:n,vysorDailyUsage:i})})}function y(){$("#listener").empty();var e,t,n;isElectron()?(e="host",t=null,n="application/x-ppapi-vysor"):(e="pnacl",t="video_decode/pnacl/Release",n=null),common.createNaClModule("video_decode",n,e,t,B,U,{},function(e){"decoder-falling-behind"==e.data?this.onDecoderFallingBehind&&this.onDecoderFallingBehind():"decoder-ready"==e.data&&(this.onReady?this.onReady():console.error("no listener for decoder-ready"))}.bind(this),function(){console.log("NACL module initialized");var e=Q[O.decoder||0];console.log("decoder:",e),common.naclModule.postMessage(e)}.bind(this)),d()}function m(e){e?document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen&&document.documentElement.mozRequestFullScreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozExitFullscreen?document.mozExitFullscreen():document.mskitExitFullscreen&&document.mskitExitFullscreen()}function w(){$(".foot-row").empty();var e=G.navigationBar.buttons,n=Math.round(100/e.length)+"%";$(e).each(function(e,o){var i=$("<span></span>");i.attr("class",o.class),i.attr("title",o.title),i.width(n),i.click(function(){t(o.event)}),$(".foot-row").append(i)})}function b(){if(window._lm&&(te||!_lm._il)){for(var t=[],n=1;n<=9;n++)t.unshift(n);var o=t.length+1;$(t).each(function(e){setTimeout(function(){$(".title, title").text("Ad in "+e+" seconds.")},1e3*(o-e))}),e({type:"toast",toast:"Vysor ad in "+o+" seconds.\nUpgrade for an ad free experience."}),setTimeout(function(){$(".title, title").text(O.friendlyName||device.name),T||(clearInterval(ne),ne=null),tracker.sendEvent("ad-impression"),e({type:"ad"})},1e3*o)}}function A(){window._lm&&(!te&&_lm._il||ne||(clearInterval(ne),ne=setInterval(b,18e5),b()))}var O,L,F,M,P,B,U,N,z,_,W,V,Y,j,K,X=36,H=48,G=vysorDefaultSettings;sharedGlobals.siphonFlv=function(t){Y&&(Y.destroy(),Y=null,j=null),Y=isElectron()?{dataReceived:function(e){e.asUint8Array&&(e=e.asUint8Array()),e.constructor==ArrayBuffer&&(e=new Uint8Array(e)),t.dataReceived(e)},destroy:function(){t.destroy()}}:t,Y&&(j=new FlashPackager(Y,B,U,30),K=!0,e({type:"resolution",resolution:resolution}))};var q=[0,.25,.5,.75,1],J=[5e5,75e4,1e6,15e5,2e6,3e6,4e6],Q=["software","hardware","hardware_with_fallback"],Z=function(e,t){return t};window.tracker||(window.tracker={sendEvent:function(){},sendAppView:function(){}}),$(window).focus(function(){n(),e({type:"wakeup"})}),$(window).bind("paste",function(t){var n=t.originalEvent.clipboardData.getData("text");n&&n.length&&e({type:"keychar",keychar:n})}),window.addEventListener("mousewheel",function(t){e({type:"scroll",clientX:t.offsetX,clientY:t.offsetY,deltaX:t.wheelDeltaX/100,deltaY:t.wheelDeltaY/100})},!1),$(window).keypress(function(t){var n=String.fromCharCode(t.keyCode);n.length&&e({type:"keychar",keychar:n})}),$(window).keydown(function(e){t(G.keydown[e.keyCode]||G.keydown[e.key],e)&&e.stopPropagation()});var ee;$(window).resize(function(t){P&&M&&(clearTimeout(ee),ee=setTimeout(function(){if(s())e({type:"displaySettings",size:innerWidth+"x"+(innerHeight-X-H),density:O.displaySettings.density});else{var t=innerWidth,n=t*(P/M);N=t,z=n,d()}},500))}),y.prototype.decode=function(e,t,n){return common.naclModule&&common.naclModule.postMessage?void common.naclModule.postMessage({buffer:e.buffer,byteOffset:e.byteOffset,byteLength:e.byteLength,presentationTimeMs:t,syncFrame:n}):void console.error("decode called before initialization")},sharedGlobals.docReady=function(){function o(){S(device.id||device.serialno,O)}function i(){$("#settings-modal").modal("hide");var e=$(s).prop("value");O.friendlyName=e,$(".title, title").text(O.friendlyName||device.name),o();var t=chrome.app.window.get("list");t&&t.contentWindow.updateDeviceName&&t.contentWindow.updateDeviceName(device.id||device.serialno,O.friendlyName||device.name)}Z=window._lm?function(e,t,n){return function(){return V&&!_lm._il?(I({title:"Vysor Pro",body:"The "+e+" feature is only available to Vysor Pro users.",okButton:"Upgrade",ok:function(){_lm.startPurchase()}}),void(n&&n.apply(this,arguments))):void t.apply(this,arguments)}}:function(e,t){return t};var r;$(document).on("dragover",function(e){$("#drag").fadeIn(),clearTimeout(r),e.preventDefault(),e.stopPropagation()}),$(document).on("dragleave",function(){r=setTimeout(function(){$("#drag").fadeOut()},1e3)}),$(document).on("drop",Z("Drag and Drop",function(e){if($("#drag").fadeOut(),e.preventDefault(),1!=e.originalEvent.dataTransfer.files.length)return void p("You may only drag and drop one file at a time.");var t=e.originalEvent.dataTransfer.files[0];console.log(t),Adb.push({socketFactory:adbSocketFactory,socket:new g(t),file:"/sdcard/vysor/"+t.name,serialno:device.serialno},function(){var e="am start -a android.intent.action.VIEW -d file:/sdcard/vysor/"+t.name;if(t.type&&t.type.length)e+=" -t "+t.type;else if(t.name.endsWith(".apk"))return void Adb.shell({socketFactory:adbSocketFactory,command:"pm install -r /sdcard/vysor/"+t.name,serialno:device.serialno},function(e){p("APK installation result: "+e.trim())});Adb.shell({socketFactory:adbSocketFactory,command:e,serialno:device.serialno},function(){p("File has been transfered and is being opened on the Android.")})})},function(e){$("#drag").fadeOut(),e.preventDefault()})),common.attachDefaultListeners(),$("canvas, #listener").mouseup(function(t){0==t.button&&e({type:t.type,clientX:t.offsetX,clientY:t.offsetY})}),$("canvas, #listener").bind("touchstart touchend touchmove",function(e){var t;t="touchstart"==e.type?"mousedown":"touchend"==e.type?"mouseup":"mousemove";var n=e.currentTarget;e.stopPropagation(),e.preventDefault(),e=e.originalEvent;var o=e.touches[0];o||(o=e.changedTouches[0]);var i=document.createEvent("MouseEvent");i.initMouseEvent(t,!0,!0,window,e.detail,o.screenX,o.screenY,o.clientX,o.clientY,!1,!1,!1,!1,0,null),i.isTouch=!0,n.dispatchEvent(i)}),console.log("docReady"),$("canvas, #listener").mousedown(function(n){return 0==n.button?(W=Date.now(),void e({type:n.type,clientX:n.offsetX,clientY:n.offsetY})):void t(G.mousedown[n.button],n)}),$("canvas, #listener").mousemove(function(t){(0!=(1&t.buttons)||t.originalEvent.isTouch)&&e({type:t.type,clientX:t.offsetX,clientY:t.offsetY})}),$(".head").bind("mouseup mousedown mousemove",function(e){e.stopPropagation(),n()}),$("#rotate-button").click(function(){e({type:"rotate"})}),$("#screenshot-button").click(function(){chrome.browser.openTab({url:"http://127.0.0.1:"+httpPort+"/device/"+(device.id||device.serialno)+"/screenshot.jpg"})}),$("#record-button").click(Z("Record Screen",function(){e($("#record-button>span").hasClass("fa-video-camera")?{type:"start-recording"}:{type:"stop-recording"}),$("#record-button>span").toggleClass("fa-video-camera fa-stop-circle-o")})),window.chrome&&window.chrome.app&&window.chrome.app.window||($("#screenshot-button").hide(),$("#record-button").hide()),$("#power").click(function(){e({type:"keycode",keycode:26})}),$("#volume-down").click(function(){e({type:"keycode",keycode:25})}),$("#volume-up").click(function(){e({type:"keycode",keycode:24})}),w(),$("#reconnect-button").click(function(){tryReconnect(),$("#reconnect").hide()}),$("#settings-button").click(function(){showSettings(),openList()}),$("#web-video-stream").click(Z("Web Video Stream",function(){var e=$("#web-video-stream").text();$("#settings-modal").modal("hide"),f(e),setTimeout(function(){D("Copied Web Video Stream Link",e)},500)}));var s=$("#new-display-name");$(s).bind("keypress",function(e){e.stopPropagation();var t=e.which;if(13==t)return i(),!1}),$("#settings-ok").click(i),$("#settings-defaults").click(function(){O=v();try{V=!1,R(O)}finally{V=!0}e({type:"displaySettings",size:"reset",density:"reset",resolution:q[O.resolution]})}),$("#softkeys-check").change(function(){O.showSoftKeys=this.checked,this.checked?($(".foot").show(),H=48):($(".foot").hide(),H=0),d()}),$("#pin-title-check").change(function(){O.pinTitleBar=this.checked,X=this.checked?36:0,d(),n()}),$("#fullscreen-check").change(Z("Fullscreen Mode",function(){m(this.checked)},function(){this.checked=!1})),$("#always-on-top-check").change(Z("Always On Top",function(){O.alwaysOnTop=this.checked,window.chrome&&window.chrome.app&&window.chrome.app.window&&chrome.app.window.current().setAlwaysOnTop(this.checked)},function(){this.checked=!1})),$("#bitrate").change(Z("Video Quality",function(){O.bitrate=this.selectedIndex;var t=J[this.selectedIndex];e({type:"bitrate",bitrate:t})},function(){this.selectedIndex=0})),$("#resolution").change(Z("Video Resolution",function(){O.resolution=this.selectedIndex;var t=q[this.selectedIndex];e({type:"resolution",resolution:t})},function(){this.selectedIndex=0})),$("#decoder").change(Z("Video Decoder",function(){O.decoder=this.selectedIndex,e({type:"resolution",resolution:q[O.resolution]})},function(){this.selectedIndex=0})),$("#display-settings").change(Z("Display Settings",function(){var t=function(){var t=x[this.selectedIndex],n=t.freeSize?innerWidth+"x"+(innerHeight-X-H):t.size;O.displaySettings=t,o(),e({type:"displaySettings",size:n,density:t.density}),this.selectedIndex&&I({title:"Display Settings",body:"Please close the Vysor window before disconnecting your Android to reset your Display Settings.",hideCancel:!0})}.bind(this);return 0==this.selectedIndex?void t():void I({title:"Display Settings",body:"The Display Settings feature is not recommended for non-Nexus devices and may require you to hard reset your device.",okButton:"Continue",ok:function(){$("#notificationModal").one("hidden.bs.modal",t)}.bind(this),cancel:function(){this.selectedIndex=0}.bind(this)})},function(){this.selectedIndex=0})),$("#dim-display").change(Z("Dim Dislay",function(){O.dimDisplay=this.checked,o(),e({type:"dimDisplay",dimDisplay:this.checked})},function(){this.checked=!1})),C(),d(),n(),window.tracker&&tracker.sendAppView("screen")};var te,ne;sharedGlobals.connectionReady=function(){function t(e){if("displaySize"==e.type){var t=M,n=P;M=e.screenWidth,P=e.screenHeight,o(t,n)}else if("encodeSize"==e.type){if(B=e.encodeWidth,U=e.encodeHeight,!E)return void m();g=h(g,null,1e3,function(){E.onClose=null,E.destroy(),E=null,m()})}else if("clip"==e.type)f(e.clip);else if("password"==e.type);else if("recording"==e.type){var i=e.recording.replace("/sdcard/vysor/","");chrome.browser.openTab({url:"http://127.0.0.1:"+httpPort+"/device/"+(device.id||device.serialno)+"/sdcard-vysor/"+i})}else console.log("unknown",e)}function i(){console.log("input websocket failed, retrying. attempt "+v+" out of "+b),setTimeout(r,2e3)}function r(){return v++,v==b?void l():void S(function(n){return n?(T=n,E&&(E.onClose=null,E.destroy(),E=null),T.onopen=function(){console.log("input websocket opened"),T.onerror=null;var t=O.displaySettings||{},n=t.freeSize?innerWidth+"x"+(innerHeight-H-X):"reset"==t.size?null:t.size,o="reset"==t.density?null:t.density;e({type:"password",password:password,resolution:q[O.resolution],size:n,density:o,dimDisplay:O.dimDisplay})},T.onerror=i,void(T.onmessage=function(e){console.log("event from phone",e.data);var n=JSON.parse(e.data);t(n)})):void i()})}function s(){window.tryReconnect?$("#reconnect").fadeIn():$("#dead").fadeIn(),$("#listener").empty()}function l(t){function n(){console.log("starting read loop");var n=setTimeout(function(){p("Your Android screen is unavailable right now. This can sometimes be resolved by rebooting your Android.")},5e3);A(),t.read(4,function(t){clearTimeout(n),l(t),window.chrome&&window.chrome.storage&&e({type:"bitrate",bitrate:J[O.bitrate]})})}function o(){r=h(r,null,1e3,function(){console.log("requesting sync frame"),e({type:"sync-frame"})})}if(console.log("received socket",t),E&&(E.onClose=null,E.destroy(),E=null),E=t,$(".overlay").fadeOut(),!t)return void s();t.name="h264",t.onClose=function(){try{s()}catch(e){console.log("eating error that occurs with jquery if window is being closed...")}console.log("closing input "),T&&T.close(),T=null,E==t&&(E=null)};var i,r,c=new y,a=!0,d=function(e){var n=e.subarray(8),o=new DataView(e.buffer,e.byteOffset,8),r=o.getUint32(0,!0),s=0!=o.getUint32(4,!0);j&&t==E&&(a?j.addVideoHeader(n):K||j.addVideoFrame(n,r,s)),a&&(K=!1,a=!1),c.decode(n,r,s);var d=Date.now();if(i){var l=d-i;l>6e4&&(i=d,u(l))}else i=d,tracker.sendEvent("view-device");f()},l=function(e){if(4!=e.byteLength)throw new Error("WTF");var n=new DataView(e.buffer,e.byteOffset,4),o=n.getInt32(0,!0);t.read(o,d)},f=function(){t.read(4,l)};c.onDecoderFallingBehind=o,c.onReady=n}function m(){adbSocketFactory.newSocket("tcp:53517",function(e){return e?void c(e,password,function(){l(e)}):void l()})}console.log("connectionReady"),$("#loading").fadeIn(),$("#dead, #reconnect").fadeOut(),n(),device||console.error("device not defined on window object?"),window.chrome&&window.chrome.storage&&window.chrome.storage.local&&chrome.storage.local.get("vysorSettings",function(e){G={},Object.assign(G,vysorDefaultSettings,e.vysorSettings);var t=G.devices&&G.devices[device.id||device.serialno]||{};G.navigationBar=t.navigationBar||G.navigationBar,Object.assign(G.keydown,t.keydown),Object.assign(G.mousedown,t.mousedown),w()});var g,v=0,b=5;window.adbSocketFactory||("adb-client"==adbSocketFactoryFactory.type?adbSocketFactory=Adb.createSocketFactory(adbSocketFactoryFactory.arguments.serialno):console.error("unknown adb socket factory factory",adbSocketFactoryFactory.type));var S=function(e){adbSocketFactory.newSocket("tcp:53518",function(t){function n(e){r||(r=!0,t.onopen&&t.onopen()),t.onmessage&&t.onmessage({data:e}),a(t,n)}if(!t)return void e();var o,i=function(){if(o){var e;o.length?e=o.shift():o=null,e&&c(t,e,i)}};t.close=t.destroy.bind(t),t.send=function(e){return o?void o.push(e):(o=[],void c(t,e,i))}.bind(t),e(t);var r=!1;t.onClose=function(){r||t.onerror&&t.onerror()},a(t,n)})};console.log("init"),k(device.id||device.serialno,function(e){O=e,r(),window._lm&&window._lm._il||(O.bitrate=0,O.resolution=0,O.alwaysOnTop=!1),R(O),V=!0,d(),$(".title, title").text(O.friendlyName||device.name)})},window.chrome&&window.chrome.app&&window.chrome.app.window?($(document).ready(docReady),function(){function e(){if(!r())return showSettings(),D(null,"Fullscreen Mode must be enabled in Settings."),void setTimeout(function(){chrome.app.window.current().restore()},1e3)}chrome.app.window.current().onFullscreened.addListener(e),chrome.app.window.current().onMaximized.addListener(e)}()):(device={id:"web",serialno:"web"},L=l("mode"),"inkwire"==L&&(device={id:"inkwire",serialno:"inkwire"}),$(document).ready(function(){docReady(),"inkwire"==L&&($("title").text("Inkwire"),X=0,$(".foot").hide(),H=0,d());var e=l("registrationId");if(e){var t=l("senderId");t||(t="64148182473");var n=l("audio");"inkwire"==L&&(t="3505780036",n=!0);var o;GcmRtcManager.start({3505780036:"AIzaSyDt0GimPRhk8_d_4XjOYzQUn50UkvXhMtE",64148182473:"AIzaSyDd7k1v017osyYbIC92fyf-36s3pv0z73U"},{iceServers:[{url:"turn:n0.clockworkmod.com",username:"foo",credential:"bar"},{url:"turn:n1.clockworkmod.com",username:"foo",credential:"bar"}]},function(i){console.log("attempting to connect to vysor from web"),o=i,o.sharedDevices={};var r=l("channel");o.connect({senderId:t,registrationId:e,port:r},function(o){console.log("web connection established"),n&&(console.log("attempting audio"),i.connect({senderId:t,registrationId:e,port:r,audio:!0},function(e,t){console.log("got audio");var n=new Audio;t.stream.getAudioTracks()[0];n.src=(URL||webkitURL||mozURL).createObjectURL(t.stream),n.play()})),console.log("gcmConn",o),adbSocketFactory=o,console.log("starting remote vysor daemon"),o.newSocket("webstart",function(e){console.log("waiting for password"),a(e,function(t){e.destroy(),console.log("got password",t),window.password=t,connectionReady()})})})})}})),sharedGlobals.updateWindowStatusText=function(e){$("#loading-text").html(e)},sharedGlobals.showSettings=function(){var e=$("#new-display-name");e.prop("value",O.friendlyName),e.prop("placeholder",device.name),$("#web-video-stream").text("http://127.0.0.1:"+window.httpPort+"/device/"+(device.id||device.serialno)+"/video.flv"),$("#settings-modal").modal()}}(),t[""]=e}({},function(){return this}());
