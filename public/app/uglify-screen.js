function nextTick(e){setTimeout(e,0)}function make4Len16(e){var t=e.toString(16);while(t.length<4){t="0"+t}return t}function encode_utf8(e){return unescape(encodeURIComponent(e))}function decode_utf8(e){return decodeURIComponent(escape(e))}function ab2str(e){if(e.constructor.name=="ArrayBuffer"){e=new Uint8Array(e)}return decode_utf8(String.fromCharCode.apply(null,e))}function str2ab(e,t,n){e=encode_utf8(e);var o=e.length;if(n)o++;if(!t){t=new ArrayBuffer(o)}var i=new Uint8Array(t);if(n)i[e.length]=0;for(var r=0,a=e.length;r<a;r++){i[r]=e.charCodeAt(r)}return t}var slashN="\n".charCodeAt(0);function writeLine(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);writeString(e,t+"\n",n)}function readLine(e,t){var n=[];function o(){e.read(function(i){for(var r=0;r<i.byteLength;r++){if(i[r]==slashN){var a=i.subarray(0,r);n.push(a);var s="";for(var c in n){c=n[c];s+=ab2str(c)}var u=i.subarray(r+1);e.unshift(u);t(s);return}}n.push(i);o()})}o()}function readString(e,t){var n="";e.onClose=function(){t(n)};function o(t){n+=ab2str(t);e.read(o)}e.read(o)}function writeString(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);e.write(str2ab(t),n)}function appendBuffer(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);n.set(e,0);n.set(t,e.byteLength);return n}var timeThing=(new Date).getTime();function timeTrace(e){var t=(new Date).getTime();console.log(e+": "+(t-timeThing));timeThing=t}function bufferToHex(e){var t=new Uint8Array(e);var n="";for(var o in t){o=t[o];if(o<16)n+="0"+o.toString(16);else n+=o.toString(16)}return n}function hexToBuffer(e){var t=new ArrayBuffer(e.length/2);var n=new Uint8Array(t);for(var o=0;o<e.length/2;o++){var i=e.substr(o*2,2);n[o]=parseInt(i,16)}return t}function base64ToArrayBuffer(e){var t=window.atob(e);var n=t.length;var o=new Uint8Array(n);for(var i=0;i<n;i++){var r=t.charCodeAt(i);o[i]=r}return o.buffer}function arrayBufferToBase64(e){var t="";var n=new Uint8Array(e);var o=n.byteLength;for(var i=0;i<o;i++){t+=String.fromCharCode(n[i])}return window.btoa(t)}var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64pad="=";function hex2b64(e){var t;var n;var o="";for(t=0;t+3<=e.length;t+=3){n=parseInt(e.substring(t,t+3),16);o+=b64map.charAt(n>>6)+b64map.charAt(n&63)}if(t+1==e.length){n=parseInt(e.substring(t,t+1),16);o+=b64map.charAt(n<<2)}else if(t+2==e.length){n=parseInt(e.substring(t,t+2),16);o+=b64map.charAt(n>>2)+b64map.charAt((n&3)<<4)}while((o.length&3)>0){o+=b64pad}return o}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,"startsWith",{enumerable:false,configurable:false,writable:false,value:function(e,t){t=t||0;return this.lastIndexOf(e,t)===t}})}function getQueryVariable(e,t){if(!t)t=window.location;var n=t.search.substring(1);var o=n.split("&");for(var i=0;i<o.length;i++){var r=o[i].split("=");if(decodeURIComponent(r[0])==e){return decodeURIComponent(r[1])}}}Object.fromArray=function(e){var t={};for(var n in e){var o=e[n];t[o]=o}return t};$.ajaxTransport("+binary",function(e,t,n){if(window.FormData&&(e.dataType&&e.dataType=="binary"||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob))){return{send:function(t,n){var o=new XMLHttpRequest,i=e.url,r=e.type,a=e.async||true,s=e.responseType||"blob",c=e.data||null,u=e.username||null,l=e.password||null;o.addEventListener("load",function(){var t={};t[e.dataType]=o.response;n(o.status,o.statusText,t,o.getAllResponseHeaders())});o.open(r,i,a,u,l);for(var d in t){o.setRequestHeader(d,t[d])}o.responseType=s;o.send(c)},abort:function(){n.abort()}}}});function throttleTimeout(e,t,n,o){if(!e)e={items:[]};e.items.push(t);if(!e.timeout){e.timeout=setTimeout(function(){delete e.timeout;o(e.items);e.items=[]},n)}return e}function copyTextToClipboard(e){var t=document.createElement("textarea");t.style.position="fixed";t.style.top=0;t.style.left=0;t.style.width="2em";t.style.height="2em";t.style.padding=0;t.style.border="none";t.style.outline="none";t.style.boxShadow="none";t.style.background="transparent";t.value=e;document.body.appendChild(t);t.select();try{var n=document.execCommand("copy")}catch(o){console.log("Oops, unable to copy")}document.body.removeChild(t)}function showNotification(e,t){console.log("notification:",e);if(!window.chrome||!window.chrome.notifications)return;var n=chrome.runtime.getManifest();var o=n.name;t=t||n.icons[128];chrome.notifications.create({type:"basic",iconUrl:t,title:o,message:e})}var blobFromUrl=function(){var e={};return function(t,n){if(e[t]){n(e[t]);return}var o=new XMLHttpRequest;o.open("GET",t,true);o.responseType="blob";o.onload=function(o){n(e[t]=window.URL.createObjectURL(this.response))};o.send()}}();function Success(){}(function(){function*e(){}var t=e();t.constructor.prototype.async=function(){var e=this;var t=e.next();if(t.done)return;function n(){t=e.throw(new Error(arguments));i()}function o(){var n=arguments[0];t=e.next(n);i()}function i(i){var r;var a;if(t.done)return;if(!t.value){t=e.next(o);return}if(t.value.constructor==Promise){t.value.then(o).catch(n);return}if(t.value==Error){r=true;t=e.next(n)}else if(t.value==Success){a=true;t=e.next(o)}else{throw new Error("Unexpected yield value for callback. Only Error and Success allowed.")}if(!t.value)throw new Error("Double yield callbacks must explicitly define both Error and Success");if(t.value==Error&&r)throw new Error("Error callback already defined");else if(t.value==Success&&a)throw new Error("Success callback already defined");else if(t.value!=Error&&t.value!=Success)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");if(r)t=e.next(o);else t=e.next(n)}i()}})();function spewSocket(e){e.read(function(t){console.log(ab2str(t));spewSocket(e)})}function getAuthToken(e,t){chrome.identity.getAuthToken({interactive:e,scopes:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/chromewebstore.readonly"]},function(e){if(!e)console.error("unable to get authToken",chrome.runtime.lastError);t(e)})}(function(){var e=console.log;var t=console.error;var n="";function o(e){try{for(var t in e){if(e[t]&&e[t].constructor!=String)e[t]=JSON.stringify(e[t])}n+=e.join(" ")+"\n"}catch(o){}}console.error=function(){t.apply(console,arguments);o(Array.prototype.slice.call(arguments))};console.log=function(){e.apply(console,arguments);o(Array.prototype.slice.call(arguments))};window.getConsoleLog=function(){return n};function i(e){return e.getConsoleLog&&e.getConsoleLog()||"getConsoleLog not found"}window.gistConsoleLog=function(e){chrome.runtime.getBackgroundPage(function(t){var n={};n["background.txt"]={content:i(t)};var o=chrome.app.window.getAll();for(var r in o){r=o[r];n["window-"+r.id+".txt"]={content:i(r.contentWindow)}}var a={description:chrome.runtime.getManifest().name+" console log","public":false,files:n};fetch("https://api.github.com/gists",{method:"POST",body:JSON.stringify(a)}).then(function(t){t.json().then(function(t){e(t.html_url)})})})}})();(function(){function e(e){this.buffer=new ArrayBuffer(e);this.dataView=new DataView(this.buffer);this.uint8array=new Uint8Array(this.buffer);this.littleEndian=false;this.position=0;this.limit=e;this.capacity=e}e.prototype.flip=function(){this.limit=this.position;this.position=0};e.prototype.asUint8Array=function(){return this.uint8array.subarray(this.position,this.limit)};function t(t,n){var o=n*8;var i=t+o;var r="get"+i;var a="set"+i;var s="put"+i;e.prototype[r]=function(){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");var e=this.dataView[r](this.position,this.littleEndian);this.position+=n;return e};e.prototype[s]=function(e){if(this.position+n>this.limit)throw new Error("Not enough room in byte buffer");if(e==null||e==undefined||e==NaN||e.constructor!=Number)throw new Error("no value provided");this.dataView[a](this.position,e,this.littleEndian);this.position+=n;return this}}var n={Int:[1,2,4],Uint:[1,2,4],Float:[4,8]};for(var o in n){var i=n[o];for(var r in i){var r=i[r];t(o,r)}}e.prototype.put=function(e){if(e.constructor==Number)return this.putInt8(e);if(e.constructor==String)e=str2ab(e);if(e.constructor==ArrayBuffer)e=new Uint8Array(e);if(this.position+e.byteLength>this.limit)throw new Error("Not enough room in byte buffer");this.uint8array.set(e,this.position);this.position+=e.byteLength;return this};e.prototype.putByte=e.prototype.putInt8;e.prototype.putShort=e.prototype.putInt16;e.prototype.putInt=e.prototype.putInt32;e.prototype.putFloat=e.prototype.putFloat32;e.prototype.putDouble=e.prototype.putFloat64;window.ByteBuffer=e})();if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.onReceive.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.dataReceived(new Uint8Array(e.data))});chrome.sockets.tcp.onReceiveError.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.destroy();t.dataReceived(null)});chrome.sockets.tcpServer.onAccept.addListener(function(e){chrome.sockets.tcp.setPaused(e.clientSocketId,false);var t=Server.listeners[e.socketId];if(t==null)return;t(new Socket({socketId:e.clientSocketId}))})}(function(){function e(t,n){if(t.socketId){this.socketId=t.socketId;e.readers[this.socketId]=this}else{chrome.sockets.tcp.create(function(o){this.socketId=o.socketId;chrome.sockets.tcp.connect(this.socketId,t.host,t.port,function(t){if(!t){e.readers[o.socketId]=this;n(this)}else{chrome.runtime.lastError;this.destroy();n(null)}}.bind(this))}.bind(this))}}e.readers={};e.connect=function(t,n){return new e(t,n)};e.pump=function(e,t,n){if(!e||!t){console.error("Socket.pump called with null socket",e,t);n();return}var o=function(){e.read(i)}.bind(e);var i=function(e){var n=e.buffer;if(e.byteOffset||e.length!=n.byteLength){n=n.slice(e.byteOffset,e.byteOffset+e.length)}t.write(n,o)}.bind(t);e.read(i);e.onClose=n};e.stream=function(t,n,o){e.pump(t,n,function(){if(n)n.destroy();if(o){var e=o;o=null;e()}});e.pump(n,t,function(){if(t)t.destroy();if(o){var e=o;o=null;e()}})};e.eat=function(e){function t(){e.read(t)}t()};e.prototype.read=function(){if(this.pendingCallback){throw new Error("double callback")}if(this.closed&&!this.pending){var e=this.onClose;if(e){delete this.onClose;e()}return}var t=0;if(arguments[t].constructor.name=="Number"){this.pendingLength=arguments[t++]}else{this.pendingLength=0}var e=arguments[t];if(!this.pending||this.paused){this.pendingCallback=e;return}if(!this.pendingLength){this.pendingLength=this.buffered()}else if(this.pendingLength>this.buffered()){this.pendingCallback=e;return}var n;var o=0;while(o<this.pendingLength){var i=this.pending.shift();this.bufferedLength-=i.length;if(!this.pending.length)delete this.pending;var r=i;var a=Math.min(r.byteLength,this.pendingLength-o);if(a!=r.byteLength){var s=r.subarray(0,a);var c=r.subarray(a);this.unshift(c);r=s}if(!n&&r.byteLength!=this.pendingLength)n=new Uint8Array(this.pendingLength);if(n){n.set(r,o)}else{n=r}o+=r.byteLength}e(n)};e.prototype.write=function(e,t){if(this.pendingWrite)console.error("write is already in progress!");if(t==null){console.error("write callback is null?");t=function(){}}this.pendingWrite=t;chrome.sockets.tcp.send(this.socketId,e,function(n){chrome.runtime.lastError;if(!n||n.resultCode){delete this.pendingWrite;return}if(n.bytesSent<e.byteLength){this.write(e.slice(n.bytesSent),t)}else{delete this.pendingWrite;t()}}.bind(this))};e.prototype.destroy=function(e,t){chrome.sockets.tcp.close(this.socketId,function(){chrome.runtime.lastError})};e.prototype.unshift=function(e){if(e.byteLength==0)return;if(!this.pending)this.pending=[e];else this.pending.unshift(e);if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length};e.prototype.dataReceived=function(e){if(e){if(e.asUint8Array)e=e.asUint8Array();if(e.constructor==ArrayBuffer)e=new Uint8Array(e)}if(e&&e.length){var t=new Uint8Array(e);if(!this.pending)this.pending=[t];else this.pending.push(t)}if(e==null){this.closed=true}else{if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length}if(this.paused||!this.pending||!this.pending.length){var n=this.onClose;if(this.closed&&n){delete this.onClose;n()}return}var o=this.pendingLength;var n=this.pendingCallback;if(n){delete this.pendingCallback;this.read(o,n)}};e.prototype.buffered=function(){return this.bufferedLength};e.prototype.pause=function(){if(this.paused){return}this.paused=true;this.onPause()};e.prototype.resume=function(){if(!this.paused){return}this.paused=false;this.onResume()};e.prototype.onResume=function(){chrome.sockets.tcp.setPaused(this.socketId,false,function(){})};e.prototype.onPause=function(){chrome.sockets.tcp.setPaused(this.socketId,true,function(){})};function t(){}t.listeners={};t.prototype.__proto__=e.prototype;t.prototype.destroy=function(){chrome.sockets.tcpServer.close(this.socketId,function(){chrome.runtime.lastError})};t.prototype.listen=function(e,n,o){var i;var r;if(e.constructor.name=="Number"){i=e;r="0.0.0.0"}else{r=e.address;i=e.port}chrome.sockets.tcpServer.create(function(e){this.socketId=e.socketId;t.listeners[this.socketId]=n;chrome.sockets.tcpServer.listen(e.socketId,r,i,function(e){chrome.runtime.lastError;if(e){this.destroy();if(o){o(e)}return}chrome.sockets.tcpServer.getInfo(this.socketId,function(t){this.localAddress=t.localAddress;this.localPort=t.localPort;if(o){o(e)}}.bind(this))}.bind(this))}.bind(this))};window.Socket=e;window.Server=t})();function FetchSocket(e,t){this.promise=fetch(e).then(function(e){this.connected=true;this.response=e;this.reader=this.response.body.getReader();this.reader.closed.then(function(){if(this.onClose)this.dataReceived(null)}.bind(this));this.onResume();t(this)}.bind(this),function(e){t(null,e)})}FetchSocket.connect=function(e,t){new FetchSocket(e,t)};FetchSocket.prototype.write=function(e,t){throw new Error("write not supported on fetch socket")};FetchSocket.prototype.destroy=function(){if(this.promise&&this.promise.cancel)this.promise.cancel()};FetchSocket.prototype.unshift=Socket.prototype.unshift;FetchSocket.prototype.dataReceived=Socket.prototype.dataReceived;FetchSocket.prototype.read=Socket.prototype.read;FetchSocket.prototype.pause=Socket.prototype.pause;FetchSocket.prototype.resume=Socket.prototype.resume;FetchSocket.prototype.buffered=Socket.prototype.buffered;FetchSocket.prototype.onPause=function(){};FetchSocket.prototype.onResume=function(){this.reader.read().then(function(e){if(!e.value)return;this.dataReceived(e.value);if(this.paused){return}this.onResume()}.bind(this))};(function(){function e(e,t){this.conn=e;this.dc=t;this.gotEof=false;t.onmessage=function(e){var t=new Uint8Array(e.data);var n=t[t.byteLength-1]==1;this.dataReceived(t.subarray(0,t.byteLength-1));if(n){this.gotEof=true;this.destroy()}}.bind(this);t.onclose=t.onerror=this.destroy.bind(this);this.needsBufferShim=true||parseInt(/Chrome\/(\d\d)/.exec(navigator.userAgent)[1])<46}e.prototype.buffered=Socket.prototype.buffered;e.prototype.unshift=Socket.prototype.unshift;e.prototype.dataReceived=Socket.prototype.dataReceived;e.prototype.read=Socket.prototype.read;e.prototype.pause=Socket.prototype.pause;e.prototype.resume=Socket.prototype.resume;e.prototype.buffered=Socket.prototype.buffered;e.prototype.writeable=function(){var e=this.writeCallback;if(e){delete this.writeCallback;e()}};e.prototype.write=function(e,t){if(!this.dc||this.dc.readyState!="open"){this.destroy();return}this.writeCallback=t;var n=new Uint8Array(e.byteLength+1);n.set(new Uint8Array(e));this.dc.send(n.buffer);if(this.reentrantWrite)return;try{this.reentrantWrite=true;while(this.writeCallback&&(this.dc.bufferedAmount==0||this.needsBufferShim)){this.writeable()}}finally{this.reentrantWrite=false}};e.prototype.destroy=function(){this.dataReceived(null);if(this.dc==null)return;var e=this.dc;this.dc=null;e.onclose=null;e.onerror=null;if(e.readyState=="open"){try{e.send(new Uint8Array([1]));if(this.gotEof)this.conn.recycleChannel(e);else this.conn.waitForEof(e)}catch(t){}}};function t(e,t){this.pc=e;this.key=t;this.pc.oniceconnectionstatechange=function(){if(this.pc.iceConnectionState=="disconnected"||this.pc.iceConnectionState=="closed"){this.destroy();delete n.gcmRtcConnections[t]}}.bind(this)}t.prototype.waitForCommand=function(t){t.onmessage=function(n){if(n.data.byteLength==1)return;this.removeChannel(t);var o=ab2str(n.data);var i=new e(this,t);this.openSocket(o,i)}.bind(this)};t.prototype.compactChannels=function(){if(this.inboundChannels&&!this.inboundChannels.length)this.inboundChannels=null;if(this.outboundChannels&&!this.outboundChannels.length)this.outboundChannels=null};t.prototype.getAppropriateChannels=function(e,t){var n;if(e.inbound){if(!this.inboundChannels&&t)this.inboundChannels=[];n=this.inboundChannels}else{if(!this.outboundChannels&&t)this.outboundChannels=[];n=this.outboundChannels}return n};t.prototype.removeChannel=function(e){t;channels=this.getAppropriateChannels(e);if(!channels)return;var t=channels.indexOf(e);if(t==-1)return;channels.splice(t,1);this.compactChannels()};t.prototype.waitForEof=function(e){e.onmessage=function(t){var n=new Uint8Array(t.data);var o=n[n.byteLength-1]==1;if(o)this.recycleChannel(e)}.bind(this)};t.prototype.recycleChannel=function(e){var t=this.getAppropriateChannels(e,true);t.push(e);e.onclose=e.onerror=function(){this.removeChannel(e)}.bind(this);this.waitForCommand(e)};t.prototype.addCandidates=function(e){for(var t in e.candidates){this.pc.addIceCandidate(new RTCIceCandidate(e.candidates[t]))}};t.prototype.setupPinger=function(e){var t;function n(){e.send(str2ab("ping"));t=setTimeout(n,1e3)}e.onmessage=function(e){};e.onclose=e.onerror=function(){clearTimeout(t);this.destroy()}.bind(this);n()};t.prototype.listenSockets=function(){this.pc.ondatachannel=function(e){e.channel.inbound=true;this.waitForCommand(e.channel)}.bind(this)};t.prototype.prepareChannel=function(e){var t=this.pc.createDataChannel(e||"gcm",{reliable:true,ordered:true});t.binaryType="arraybuffer";return t};t.prototype.newSocket=function(t,n){if(this.pc.signalingState=="closed"){n();return}if(this.outboundChannels){var o=this.outboundChannels.shift();this.compactChannels();o.send(str2ab(t));var i=new e(this,o);n(i,this);return}var o=this.prepareChannel("gcm");o.onopen=function(){o.send(str2ab(t));var i=new e(this,o);n(i,this)}.bind(this)};t.prototype.destroy=function(){if(this.pc.signalingState!="closed"){this.pc.close()}var e=this.onClose;if(e){delete this.onClose;e()}};function n(e,t,n){this.senders=e;this.registrationId=t;this.rtcc=n}n.gcmRtcConnections={};n.onMessage=function(e){var t=JSON.parse(e.message);var o=e.type;var i=e.senderId;var r=e.src;var a=e.srcPort;var s=e.dstPort;if(o=="offer"){var c=n.gcmRtcListeners[s];if(!c)console.log("not listening on "+s);else c.listener.incoming(i,r,a,s,t,c.listenCallback);return}else if(o=="answer"){var u=n.getKey(r,a,s);var l=n.gcmRtcConnections[u];if(!l){console.log("pending connection not found");return}l.manager.incoming(i,r,a,s,t);return}else if(n.onUnknownMessage){n.onUnknownMessage(e)}else{console.log("unknown message "+o)}};n.hasLoadedChannels=false;n.start=function(e,t,o){if(window.chrome&&window.chrome.gcm){var i=Object.keys(e);chrome.gcm.register(i,function(i){chrome.runtime.lastError;if(!i){o();return}var r=new n(e,i,t);o(r)})}else{function r(){$.ajax({type:"GET",url:"https://vysor-1026.appspot.com/listen",success:function(i){var r=new goog.appengine.Channel(i.token);var a={onopen:function(){var r=new n(e,"web:"+i.channel,t);o(r)},onmessage:function(e){n.onMessage(JSON.parse(e.data))},onerror:function(){console.log("error",arguments)},onclose:function(){console.log("onclose",arguments)}};var s=r.open(a)}})}if(n.hasLoadedChannels){r()}else{$.getScript("https://vysor-1026.appspot.com/_ah/channel/jsapi",r)}}if(window.chrome&&window.chrome.gcm){chrome.gcm.onMessage.addListener(function(e){n.onMessage(e.data)})}};n.prototype.sendGcm=function(e,t,n,o,i,r){if(!e)e=this.defaultSenderId;if(t.startsWith("web:")){$.ajax({type:"POST",url:"https://vysor-1026.appspot.com/send",data:JSON.stringify({channel:t.substring(4),data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:i,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",success:function(){}})}else{$.ajax({type:"POST",url:"https://gcm-http.googleapis.com/gcm/send",headers:{Authorization:"key="+this.senders[e]},data:JSON.stringify({to:t,data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:i,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",error:function(){console.log("gcm error",arguments)},success:function(){console.log("gcm",arguments)}})}};n.getKey=function(e,t,n){return n+":"+t+":"+e};n.prototype.setupPeerConnection=function(e,o,i,r,a,s){var c=window.RTCPeerConnection||window.webkitRTCPeerConnection;var u=new c(this.rtcc);var l;var d=function(t){var n=[];for(var c in t){c=t[c];n.push(c);if(JSON.stringify(n).length>3200){this.sendGcm(o,i,r,a,e,{desc:s(),candidates:n});n=[]}}if(n.length>0){this.sendGcm(o,i,r,a,e,{desc:s(),candidates:n})}}.bind(this);u.onicecandidate=function(e){if(e.candidate==null)return;console.log(e.candidate);l=throttleTimeout(l,e.candidate,500,d)}.bind(this);var f=n.getKey(i,r,a);var h=new t(u,f);h.manager=this;u.onsignalingstatechange=function(e){if(u.signalingState=="stable"){if(n.gcmRtcConnections[f]==h){}}else if(u.signalingState=="closed"){h.destroy()}};n.gcmRtcConnections[f]=h;return h};n.gcmPortCount=0;n.prototype.connect=function(e,t){var o=e.senderId;var i=e.registrationId;var r=e.port;var a=n.gcmPortCount++;var s;var c=this.setupPeerConnection("offer",o,i,r,a,function(){return s});var u=c.pc;function l(e){u.createOffer(e).then(function(e){s=e;u.setLocalDescription(e)})}if(!e.audio){var d=c.prepareChannel("pinger");d.onopen=function(){console.log("got rtc pinger");c.setupPinger(d);t(c)};c.listenSockets();l({})}else{navigator.webkitGetUserMedia({audio:true,video:false},function(e){u.addStream(e);u.onaddstream=function(e){console.log("got the remote stream");t(c,e)};l({offerToReceiveAudio:true,offerToReceiveVideo:false,voiceActivityDetection:false})},function(){console.error("audio fail",arguments);l({offerToReceiveAudio:true,offerToReceiveVideo:false,voiceActivityDetection:false})})}};n.gcmRtcListeners={};n.prototype.isListening=function(e){return n.gcmRtcListeners[e]!=null};n.prototype.stopListen=function(e){delete n.gcmRtcListeners[e]};n.prototype.listen=function(e,t){if(n.gcmRtcListeners[e]){console.log("already listening on gcm port "+e);return}n.gcmRtcListeners[e]={listener:this,listenCallback:t}};n.prototype.incoming=function(e,t,o,i,r,a){var s=n.getKey(t,o,i);var c=n.gcmRtcConnections[s];if(!c){var u;c=this.setupPeerConnection("answer",e,t,o,i,function(){return u});c.remoteDesc=new RTCSessionDescription(r.desc);var l=c.pc;l.ondatachannel=function(e){console.log("got rtc pinger");this.setupPinger(e.channel);a(c);this.listenSockets()}.bind(c);l.setRemoteDescription(c.remoteDesc,function(){l.createAnswer().then(function(e){u=e;l.setLocalDescription(e)},function(){console.error("answer error",arguments)})})}else if(!c.remoteDesc){c.remoteDesc=new RTCSessionDescription(r.desc);var l=c.pc;l.setRemoteDescription(c.remoteDesc)}else{}c.addCandidates(r)};window.GcmRtcSocket=e;window.GcmRtcManager=n})();function FileSocket(e){this.internalRead=this.read;this.read=this.readWrapper;this.file=e;this.fileRead=0}FileSocket.prototype.write=function(e,t){throw new Error("write not supported on file socket")};FileSocket.prototype.destroy=function(){};FileSocket.prototype.buffered=Socket.prototype.buffered;FileSocket.prototype.unshift=Socket.prototype.unshift;FileSocket.prototype.dataReceived=Socket.prototype.dataReceived;FileSocket.prototype.read=Socket.prototype.read;FileSocket.prototype.pause=Socket.prototype.pause;FileSocket.prototype.resume=Socket.prototype.resume;FileSocket.prototype.buffered=Socket.prototype.buffered;FileSocket.prototype.onPause=function(){};FileSocket.prototype.onResume=function(){};FileSocket.prototype.readWrapper=function(){this.internalRead.apply(this,arguments);if(!this.pendingCallback)return;var e=this.pendingLength;if(!e)e=65536;e=Math.min(this.file.size-this.fileRead,e);if(e==0){this.dataReceived(null);return}var t=this.file.slice(this.fileRead,this.fileRead+e);this.fileRead+=e;var n=new FileReader;n.addEventListener("loadend",function(e){this.dataReceived(new Uint8Array(n.result))}.bind(this));n.readAsArrayBuffer(t)};(function(){var e={};e.sendHostCommand=function(e,t){Socket.connect({host:"127.0.0.1",port:5037},function(n){if(!n){t();return}var o=e;e=make4Len16(e.length)+e;n.read(4,function(e){var i=ab2str(e);if(i!="OKAY"){console.error("error in response to adb host command",o,i);n.destroy();t();return}n.read(4,function(e){var o=ab2str(e);e=parseInt(o,16);if(e==0||o=="OKAY"){t(n,new ArrayBuffer(0));return}n.read(e,function(e){t(n,e)})})});n.write(str2ab(e),function(){})})};e.devices=function(t){var n={};function o(e){var t=e;e=e.replace("\t"," ");var o=e.indexOf(" ");if(o==-1)return;var i=e.substring(0,o);e=e.substring(o).trim();var r;while(r!=e){r=e;e=e.replace("  "," ")}var a={};var s=e.indexOf(" ");if(s==-1)s=e.length;var c=e.substring(0,s);e=e.substring(s+1);while(e.length){o=e.indexOf(":");if(o==-1)break;var u=e.substring(0,o);var l=e.substring(o+1);var d=l.indexOf(" ");var f=l.indexOf(":");var h;if(d==-1||f==-1){h=l;e=""}else{while(d!=-1&&d<f){h=l.substring(0,d);e=l.substring(d+1);d=l.indexOf(" ",d+1)}}a[u]=h}var p;if(!a["model"])p=i;else p=a["model"].replace("_"," ");n[i]={serialno:i,name:p,status:c,properties:t}}e.sendHostCommand("host:devices-l",function(e,i){if(!e){t();return}e.destroy();i=ab2str(i);console.log("ADB devices:",i);i=i.trim();var r=i.split("\n");for(var a in r){a=r[a];o(a)}t(n)})};e.killServer=function(t){e.sendHostCommand("host:kill-server",function(e,n){if(!e){t();return}e.destroy();n=ab2str(n);if(t)t()})};e.sendClientCommand=function(e,t){var n=e.command;var o=e.serialno;Socket.connect({host:"127.0.0.1",port:5037},function(e){if(!e){t();return}e.read(4,function(o){var i=ab2str(o);if(i!="OKAY"){e.destroy();t(null);return}var r=n;r=make4Len16(r.length)+r;e.read(4,function(n){var o=ab2str(n);if(o!="OKAY"){e.destroy();t(null);return}t(e)});e.write(str2ab(r),function(){})});var i="host:transport:"+o;i=make4Len16(i.length)+i;e.write(str2ab(i),function(){})})};e.shell=function(t,n){var o=t.command;var i=t.serialno;e.getOrCreateSockFactory(t).newSocket("shell:"+o,function(e){if(!e){n();return}readString(e,function(e){n(e)})})};e.forward=function(t,n){var o="host-serial:"+t.serialno+":forward:"+t.from+";"+t.to;e.sendHostCommand(o,function(e,t){if(e)e.destroy();n(e,t)})};function t(){}t.MKID=function(e,t,n,o){return e.charCodeAt(0)|t.charCodeAt(0)<<8|n.charCodeAt(0)<<16|o.charCodeAt(0)<<24};t.ID_RECV=t.MKID("R","E","C","V");t.ID_SEND=t.MKID("S","E","N","D");t.ID_DONE=t.MKID("D","O","N","E");t.ID_DATA=t.MKID("D","A","T","A");t.DATA_MAX=64*1024;e.pull=function(n,o){var i=n.file;var r=n.serialno;var a=n.fileEntry;e.getOrCreateSockFactory(n).newSocket("sync:",function(e){if(!e){o();return}a.createWriter(function(n){var r=new ArrayBuffer(8);var s=new DataView(r);s.setUint32(0,t.ID_RECV,true);s.setUint32(4,i.length,true);e.write(r,function(){e.write(str2ab(i),function(){function i(t){e.read(t,function(e){n.write(new Blob([e]))})}n.onwriteend=function(e){r()};function r(){e.read(8,function(n){var r=new DataView(n.buffer,n.byteOffset,n.byteLength);var s=r.getUint32(0,true);if(s==t.ID_DATA){var c=r.getUint32(4,true);i(c);return}e.destroy();if(s==t.ID_DONE){o(a);return}o()})}r()})})})})};e.createSocketFactory=function(t){return{newSocket:function(n,o){e.sendClientCommand({serialno:t,command:n},o)}}};e.getOrCreateSockFactory=function(t){return t.socketFactory||e.createSocketFactory(t.serialno)};e.push=function(n,o){var i=n.file;var r=n.serialno;var a=n.socket;e.getOrCreateSockFactory(n).newSocket("sync:",function(e){if(!e){o();return}var n=new ArrayBuffer(8);var r=new DataView(n);var s=i+",0644";r.setUint32(0,t.ID_SEND,true);r.setUint32(4,s.length,true);e.write(n,function(){e.write(str2ab(s),function(){var n;var i=true;a.onClose=function(){var n=new ArrayBuffer(8);var i=new DataView(n);i.setUint32(0,t.ID_DONE,true);i.setUint32(4,0,true);e.write(n,function(){e.read(8,function(){o()})})};function r(){a.read(function(e){if(e.byteLength>t.DATA_MAX){var n=e.subarray(t.DATA_MAX);e=e.subarray(0,t.DATA_MAX);a.unshift(n)}s(e)})}function s(n){var o=new ArrayBuffer(8);var i=new DataView(o);i.setUint32(0,t.ID_DATA,true);i.setUint32(4,n.byteLength,true);e.write(o,function(){var t=n.buffer;if(n.byteOffset||n.length!=t.byteLength){t=t.slice(n.byteOffset,n.byteOffset+n.byteLength)}e.write(t,function(){r()})})}r()})})})};window.Adb=e})();function getDefaultDeviceSettings(){var e={showSoftKeys:true,pinTitleBar:true,alwaysOnTop:false,bitrate:0,resolution:0,decoder:0};return e}function sanitizeDeviceSettings(e){if(!e)return null;if(e.friendlyName&&!e.friendlyName.length)delete e.friendlyName;return e}function loadAllDeviceSettings(e){if(window.chrome&&window.chrome.storage){chrome.storage.local.get("device-settings",function(t){e(t["device-settings"]||{})})}else{e({})}}function loadDeviceSettings(e,t){if(!e)e="web";var n=getDefaultDeviceSettings();if(e=="inkwire"){n.pinTitleBar=false;n.showSoftKeys=false}loadAllDeviceSettings(function(o){t(sanitizeDeviceSettings(o[e]||n))})}function saveDeviceSettings(e,t,n){sanitizeDeviceSettings(t);if(!window.chrome||!window.chrome.storage){if(n)n();return}if(!e||e.indexOf("127.0.0.1")!=-1){if(n)n();return}loadAllDeviceSettings(function(o){o[e]=t;chrome.storage.local.set({"device-settings":o},n)})}function applyDeviceSettings(e){$("#new-display-name").prop("value",e.friendlyName);$("#softkeys-check").prop("checked",e.showSoftKeys?true:false).change();$("#pin-title-check").prop("checked",e.pinTitleBar?true:false).change();$("#always-on-top-check").prop("checked",e.alwaysOnTop?true:false).change();$("#bitrate").prop("selectedIndex",e.bitrate||0);$("#decoder").prop("selectedIndex",e.decoder||0);$("#resolution").prop("selectedIndex",e.resolution||0)}function showModal(e){var t=$("#notificationModal");var n=t.find("#modal-ok");var o=t.find("#modal-cancel");n.unbind("click");o.unbind("click");e.cancelButton=e.cancelButton||"Cancel";e.okButton=e.okButton||"OK";e.title=e.title||chrome.runtime.getManifest().name;e.body=e.body||"";if(e.hideCancel)o.hide();else o.show();n.text(e.okButton);o.text(e.cancelButton);t.find("#modal-title").text(e.title);t.find("#modal-body").html(e.body);n.click(function(){if(!e.ok||!e.ok())$("#notificationModal").modal("hide")});if(e.cancel)e.click(e.cancel);$("#notificationModal").modal();if(e.duration){setTimeout(function(){$("#notificationModal").modal("hide")},e.duration)}}function shortModal(e,t){showModal({title:e,body:t,duration:8e3,hideCancel:true})}(function(){var e=9;var t=8;var n=9;var o=18;var i=0;var r=1;var a=2;var s=3;var c=5;var u=6;var l=7;var d=8;var f=9;var h=10;var p=11;var y=12;var v=13;var m=0;var g=7;var w=4;var b=1<<w|7;var k=2<<w|7;function S(e,t,n,o){this.socket=e;this.videoOnly=true;var i=new ByteBuffer(1024);i.put("FLV");i.put(1);if(this.videoOnly)i.put(1);else i.put(1+4);i.putInt(9);i.putInt(0);i.flip();this.socket.dataReceived(i);this.setParameter(t,n,o)}function C(e,t){e.put(i);e.putDouble(t);return e}function A(e,t){var n=str2ab(t);e.putShort(n.byteLength);e.put(n);return e}function D(e,t){e.putShort(t>>8&65535);e.put(t&255);return e}S.prototype.setParameter=function(t,n,i){var r=new ByteBuffer(1024);r.put(o);if(this.videoOnly)D(r,182);else D(r,290);D(r,0);r.putInt(0);var s=r.position;r.put(a);A(r,"onMetaData");r.put(d);if(this.videoOnly)r.putInt(5+2);else r.putInt(5+5+2);A(r,"duration");C(r,0);A(r,"width");C(r,t);A(r,"height");C(r,n);A(r,"framerate");C(r,i);A(r,"videocodecid");C(r,g);A(r,"videodatarate");C(r,0);if(!this.videoOnly){A(r,"audiodatarate");C(r,64e3/1024);A(r,"audiosamplerate");C(r,5112);A(r,"audiosamplesize");
C(r,8);A(r,"stereo");r.put(0);A(r,"audiocodecid");C(r,0)}A(r,"encoder");r.put(a);A(r,"Lavf52.87.1");A(r,"filesize");C(r,0);A(r,"");r.put(e);var c=r.position;var u=c-s;r.putInt(u+11);r.flip();this.socket.dataReceived(r)};S.prototype.addVideoHeader=function(e){for(var t=4;t<e.length;t++){if(e[t+0]==0&&e[t+1]==0&&e[t+2]==0&&e[t+3]==1){break}}var o=e.subarray(0,t);var i=e.subarray(t);var r=new ByteBuffer(1024);var a=o.length-4+i.length-4+16;r.put(n);D(r,a);D(r,0);r.put(0);D(r,0);r.put(7|b);r.put(0);D(r,0);r.put(1);r.put(o[4+1]);r.put(o[4+2]);r.put(o[4+3]);r.put(255);r.put(225);r.putShort(o.length-4);r.put(o.subarray(4));r.put(1);r.putShort(i.length-4);r.put(i.subarray(4));r.putInt(11+a);r.flip();this.socket.dataReceived(r)};S.prototype.addVideoFrame=function(e,t,o){var i=new ByteBuffer(1024);i.put(n);D(i,5+e.length);if(!this.firstPresentationTimestampMs)this.firstPresentationTimestampMs=t;var r=t-this.firstPresentationTimestampMs;D(i,r);i.put(r>>24&255);D(i,0);i.put(o?b:k);i.put(1);D(i,0);i.flip();var a=new ByteBuffer(e.length);a.put(e);a.flip();a.putInt(e.length-4);a.position=0;var s=new ByteBuffer(1024);s.putInt(11+5+e.length);s.flip();this.socket.dataReceived(i);this.socket.dataReceived(a);this.socket.dataReceived(s)};window.FlashPackager=S})();var h264Socket;var inputWebSocket;(function(){var e;var t;var n;var o;var i;var r;var a;var s;var c;var u=36;var l=48;var d;var f;var h;var p;var y;var v;window.siphonFlv=function(e){if(p){p.destroy();p=null;y=null}p=e;if(p){y=new FlashPackager(p,r,a,30);v=true;k({type:"resolution",resolution:resolution})}};var m=[0,.25,.5,.75,1];var g=[5e5,75e4,1e6,15e5,2e6,3e6,4e6];var w=["software","hardware","hardware_with_fallback"];var b=function(e,t){return t};if(!window.tracker){window.tracker={sendEvent:function(){}}}function k(e){if(!inputWebSocket)return;if(e.clientX){e.downDelta=Date.now()-f;if(!d)d=$("#mirror");e.clientX=e.clientX/d.width()*o;if(e.clientX>o||e.clientX<0)return}if(e.clientY){if(!d)d=$("#mirror");e.clientY=e.clientY/d.height()*i;if(e.clientY>i||e.clientY<0)return}inputWebSocket.send(JSON.stringify(e))}function S(){if(t=="inkwire"){$(".head").hide();return}if(u){clearTimeout(n);$(".head").fadeTo(0,1);return}$(".head").fadeTo(0,.8);clearTimeout(n);n=setTimeout(function(){$(".head").fadeOut()},2e3)}$(window).focus(function(){S();k({type:"wakeup"})});$(window).bind("paste",function(e){var t=e.originalEvent.clipboardData.getData("text");if(t&&t.length){k({type:"keychar",keychar:t})}});window.addEventListener("mousewheel",function(e){k({type:"scroll",clientX:e.offsetX,clientY:e.offsetY,deltaX:e.wheelDeltaX/100,deltaY:e.wheelDeltaY/100})},false);$(window).keypress(function(e){var t=String.fromCharCode(e.keyCode);if(!t.length)return;k({type:"keychar",keychar:t})});$(window).keydown(function(e){if(e.keyCode==36){k({type:"home"})}else if(e.keyCode==27){k({type:"back"})}else if(e.keyCode==112){k({type:"menu"})}else if(e.keyCode==113){S();return}else if(e.keyCode==8){k({type:"backspace"})}else if(e.keyCode==38){k({type:"up"})}else if(e.keyCode==40){k({type:"down"})}else if(e.keyCode==37){k({type:"left"})}else if(e.keyCode==39){k({type:"right"})}else if(e.keyCode==46){k({type:"delete"})}else if(e.keyCode==13){k({type:"keycode",keycode:66})}else{return}e.stopPropagation()});var C;$(window).resize(function(e){if(!i||!o)return;clearTimeout(C);C=setTimeout(function(){var e=innerWidth;var t=e*(i/o);s=e;c=t;I()},500)});function A(e,t){if(window.chrome&&window.chrome.app&&window.chrome.app.window&&D()){s=screen.availWidth;c=screen.availHeight}else if(t==o&&e==i){var n=s;s=c;c=n}else{var r;if(o>i)r=Math.max(innerWidth,innerHeight);else r=Math.min(innerWidth,innerHeight);var a=r*(i/o);s=r;c=a}I()}function D(){return document.webkitFullscreenElement||document.msFullscreenElement||document.mozFullscreenElement||document.fullscreenElement}function I(){if(s>screen.availWidth){s=screen.availWidth;c=i/o*s}var e=outerHeight-innerHeight;if(c+l+u+e>screen.availHeight){c=screen.availHeight-l-u-e;s=o/i*c}if(!s||!c)return;if(window.chrome&&window.chrome.app&&window.chrome.app.window&&!D()){var t=Math.round(s);var n=Math.round(c+l+u);if(Math.abs(innerWidth-t)>=2)chrome.app.window.current().innerBounds.width=t;if(Math.abs(innerHeight-n)>=2)chrome.app.window.current().innerBounds.height=n}var r=innerWidth;var a=innerHeight;var d=(r-s)/2;var f=$("#mirror, #listener, #tutorial");f.css("left",d);f.css("top",a-c-l)/2;$(".foot").width(s);$(".foot").css("left",d);$(".overlay").width(s);$(".overlay").css("left",d);f=$("#mirror, embed, #listener, #tutorial");f.width(Math.round(s));f.height(Math.round(c));var h=$("canvas")[0];h.width=Math.round(s);h.height=Math.round(c);$("#dead, #drag, #reconnect").width(s);$("#dead, #drag, #reconnect").height(c+l+u)}function T(e){if(!window.chrome||!window.chrome.storage)return;chrome.storage.local.get(["vysorUsage","vysorDailyUsage","lastDailyReport"],function(t){var n=t.vysorUsage;var o=t.lastDailyReport;var i=t.vysorDailyUsage;var r=Date.now();if(!n)n=0;if(!i)i=0;if(!o){chrome.storage.local.set({lastDailyReport:r})}else{if(r>o+24*60*60*1e3){var a=i/(60*60*1e3);a=Math.round(a*2)/2;if(a<=24&&a>=0){tracker.sendEvent("daily-usage",a.toString());tracker.sendEvent("daily-usage-licensed",lm.isLicensed())}i=0;chrome.storage.local.set({lastDailyReport:r})}}n+=e;i+=e;chrome.storage.local.set({vysorUsage:n,vysorDailyUsage:i})})}function R(){var t;$("#listener").empty();common.createNaClModule("video_decode","pnacl","video_decode/pnacl/Release",r,a,{},function(e){if(e.data=="decoder-falling-behind"){if(this.onDecoderFallingBehind)this.onDecoderFallingBehind()}}.bind(this),function(){console.log("NACL module initialized");var t=w[e.decoder||0];console.log("decoder:",t);common.naclModule.postMessage(t);if(this.onReady)this.onReady()}.bind(this));I()}R.prototype.decode=function(e,t,n){if(!common.naclModule||!common.naclModule.postMessage){console.error("decode called before initialization");return}common.naclModule.postMessage({buffer:e.buffer,byteOffset:e.byteOffset,byteLength:e.byteLength,presentationTimeMs:t,syncFrame:n})};var L;function F(e,t){$(e).click(function(n){n.stopPropagation();$("#tutorial>h2").text($(e).prop("title"));clearTimeout(L);L=setTimeout(function(){$("#tutorial>h2").fadeOut({complete:function(){$("#tutorial>h2").html("Welcome to the tutorial.<br/><br/>Try pushing some buttons.");$("#tutorial>h2").fadeIn()}})},3e3);if(t)t()})}function E(e){if(!e){if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.mozExitFullscreen)document.mozExitFullscreen();else if(document.mskitExitFullscreen)document.mskitExitFullscreen()}else{if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen();else if(document.documentElement.webkitRequestFullscreen)document.documentElement.webkitRequestFullscreen();else if(document.documentElement.msRequestFullscreen)document.documentElement.msRequestFullscreen();else if(document.documentElement.mozRequestFullScreen)document.documentElement.mozRequestFullScreen()}}function O(){$(".title").text("Vysor Tutorial");F("#rotate-button",function(){var e=o;o=i;i=e;A(i,o)});F("#pin-title-button");F("#settings-button",function(){openList()});F("#screenshot-button");F("#power");F("#volume-down");F("#volume-up");F("#bottom-back");F("#bottom-home");F("#bottom-tasks");F("#softkey-button",function(){if(l){$(".foot").hide();l=0}else{$(".foot").show();l=48}I()});F("#fullscreen-button",E);u=36;S();$(".overlay").fadeOut();$("#tutorial").fadeIn();s=innerWidth;c=innerHeight;o=360;i=640;I()}window.docReady=function(){if(!window.lm){b=function(e,t){return t}}else{b=function(e,t,n){return function(){if(h&&!lm.isLicensed()){showModal({title:"Vysor Pro",body:"The "+e+" feature is only avaiable to Vysor Pro users.",okButton:"Upgrade",ok:function(){lm.startPurchase()}});if(n)n.apply(this,arguments);return}t.apply(this,arguments)}}}if(window.chrome&&window.chrome.app&&window.chrome.app.window&&window.chrome.app.window.current&&chrome.app.window.current().id=="tutorial"){O();return}$("#tutorial").hide();var t;$(document).on("dragover",function(e){$("#drag").fadeIn();clearTimeout(t);e.preventDefault();e.stopPropagation()});$(document).on("dragleave",function(){t=setTimeout(function(){$("#drag").fadeOut()},1e3)});$(document).on("drop",b("Drag and Drop",function(e){$("#drag").fadeOut();e.preventDefault();if(e.originalEvent.dataTransfer.files.length!=1){showNotification("You may only drag and drop one file at a time.");return}var t=e.originalEvent.dataTransfer.files[0];console.log(t);Adb.push({socketFactory:window.adbSocketFactory,socket:new FileSocket(t),file:"/sdcard/vysor/"+t.name,serialno:device.serialno},function(){var e="am start -a android.intent.action.VIEW -d file:/sdcard/vysor/"+t.name;if(t.type&&t.type.length){e+=" -t "+t.type}else if(t.name.endsWith(".apk")){Adb.shell({socketFactory:window.adbSocketFactory,command:"pm install -r /sdcard/vysor/"+t.name,serialno:device.serialno},function(e){showNotification("APK installation result: "+e.trim())});return}Adb.shell({socketFactory:window.adbSocketFactory,command:e,serialno:device.serialno},function(){showNotification("File has been transfered and is being opened on the Android.")})})},function(e){$("#drag").fadeOut();e.preventDefault()}));common.attachDefaultListeners();$("canvas, #listener").mouseup(function(e){if(e.button!=0)return;k({type:e.type,clientX:e.offsetX,clientY:e.offsetY})});$("canvas, #listener").bind("touchstart touchend touchmove",function(e){var t;if(e.type=="touchstart")t="mousedown";else if(e.type=="touchend")t="mouseup";else t="mousemove";var n=e.currentTarget;e.stopPropagation();e.preventDefault();e=e.originalEvent;var o=e.touches[0];if(!o)o=e.changedTouches[0];var i=document.createEvent("MouseEvent");i.initMouseEvent(t,true,true,window,e.detail,o.screenX,o.screenY,o.clientX,o.clientY,false,false,false,false,0,null);i.isTouch=true;n.dispatchEvent(i)});$("canvas, #listener").mousedown(function(e){f=Date.now();if(e.button==1){k({type:"home"});return}if(e.button==2){k({type:"back"});return}if(e.button!=0)return;k({type:e.type,clientX:e.offsetX,clientY:e.offsetY})});$("canvas, #listener").mousemove(function(e){if((e.buttons&1)==0&&!e.originalEvent.isTouch)return;k({type:e.type,clientX:e.offsetX,clientY:e.offsetY})});$(".head").bind("mouseup mousedown mousemove",function(e){e.stopPropagation();S()});$("#rotate-button").click(function(){k({type:"rotate"})});$("#screenshot-button").click(function(){chrome.browser.openTab({url:"http://127.0.0.1:"+port+"/screenshot.jpg?password="+password})});if(!window.chrome||!window.chrome.app||!window.chrome.app.window)$("#screenshot-button").hide();$("#power").click(function(){k({type:"keycode",keycode:26})});$("#volume-down").click(function(){k({type:"keycode",keycode:25})});$("#volume-up").click(function(){k({type:"keycode",keycode:24})});$("#bottom-back").click(function(){k({type:"keycode",keycode:4})});$("#bottom-home").click(function(){k({type:"keycode",keycode:3})});$("#bottom-tasks").click(function(){k({type:"keycode",keycode:187})});$("#reconnect-button").click(function(){window.tryReconnect();$("#reconnect").hide()});$("#settings-button").click(function(){showSettings();openList()});$("#web-video-stream").click(b("Web Video Stream",function(){var e=$("#web-video-stream").text();$("#settings-modal").modal("hide");copyTextToClipboard(e);setTimeout(function(){shortModal("Copied Web Video Stream Link",e)},500)}));function n(){saveDeviceSettings(device.id||device.serialno,e)}var o=$("#new-display-name");function i(){$("#settings-modal").modal("hide");var t=$(o).prop("value");e.friendlyName=t;$(".title").text(e.friendlyName||device.name);n();var i=chrome.app.window.get("list");if(i&&i.contentWindow.updateDeviceName)i.contentWindow.updateDeviceName(device.id||device.serialno,e.friendlyName||device.name)}$(o).bind("keypress",function(e){e.stopPropagation();var t=e.which;if(t==13){i();return false}});$("#settings-ok").click(i);$("#settings-defaults").click(function(){e=getDefaultDeviceSettings();applyDeviceSettings(e);k({type:"resolution",resolution:m[e.resolution]})});$("#softkeys-check").change(function(){e.showSoftKeys=this.checked;if(this.checked){$(".foot").show();l=48}else{$(".foot").hide();l=0}I()});$("#pin-title-check").change(function(){e.pinTitleBar=this.checked;if(this.checked)u=36;else u=0;I();S()});$("#fullscreen-check").change(b("Fullscreen Mode",function(){E(this.checked)},function(){this.checked=false}));$("#always-on-top-check").change(b("Always On Top",function(){e.alwaysOnTop=this.checked;if(window.chrome&&window.chrome.app&&window.chrome.app.window)chrome.app.window.current().setAlwaysOnTop(this.checked)},function(){this.checked=false}));$("#bitrate").change(b("Image Quality",function(){e.bitrate=this.selectedIndex;var t=g[this.selectedIndex];k({type:"bitrate",bitrate:t})},function(){this.selectedIndex=0}));$("#resolution").change(b("Image Quality",function(){e.resolution=this.selectedIndex;var t=m[this.selectedIndex];k({type:"resolution",resolution:t})},function(){this.selectedIndex=0}));$("#decoder").change(b("Image Quality",function(){e.decoder=this.selectedIndex;k({type:"resolution",resolution:m[e.resolution]})},function(){this.selectedIndex=0}));I();S()};window.connectionReady=function(){$("#loading").fadeIn();$("#dead, #reconnect").fadeOut();S();if(!window.device)console.error("device not defined on window object?");loadDeviceSettings(device.id||device.serialno,function(t){e=t;if(!window.lm||!lm.isLicensed()){e.bitrate=0;e.resolution=0;e.alwaysOnTop=false}applyDeviceSettings(e);h=true;I();$(".title").text(e.friendlyName||device.name)});var t;function n(e){if(e.type=="displaySize"){var n=o;var s=i;o=e.screenWidth;i=e.screenHeight;A(n,s)}else if(e.type=="encodeSize"){r=e.encodeWidth;a=e.encodeHeight;if(!h264Socket){p();return}t=throttleTimeout(t,null,1e3,function(){h264Socket.onClose=null;h264Socket.destroy();h264Socket=null;p()})}else if(e.type=="clip"){copyTextToClipboard(e.clip)}else if(e.type=="password"){}else{console.log("unknown",e)}}var s=0;var c=5;function u(){console.log("input websocket failed, retrying. attempt "+s+" out of "+c);setTimeout(l,2e3)}function l(){s++;if(s==c){f();return}d(function(t){if(!t){u();return}inputWebSocket=t;inputWebSocket.onopen=function(){console.log("input websocket opened");inputWebSocket.onerror=null;k({type:"password",password:password});k({type:"wakeup"});k({type:"resolution",resolution:m[e.resolution]})};inputWebSocket.onerror=u;inputWebSocket.onmessage=function(e){console.log(e.data);var t=JSON.parse(e.data);n(t)}})}var d=function(e){adbSocketFactory.newSocket("tcp:53518",function(t){if(!t){e();return}var n;var o=function(){if(!n)return;var e;if(n.length)e=n.shift();else n=null;if(e)writeLine(t,e,o)};t.close=t.destroy.bind(t);t.send=function(e){if(n){n.push(e);return}n=[];writeLine(t,e,o)}.bind(t);e(t);var i=false;t.onClose=function(){if(!i){if(t.onerror)t.onerror()}};function r(e){if(!i){i=true;if(t.onopen)t.onopen()}if(t.onmessage)t.onmessage({data:e});readLine(t,r)}readLine(t,r)})};console.log("init");function f(t){console.log("received socket",t);if(h264Socket){h264Socket.destroy()}h264Socket=t;$(".overlay").fadeOut();if(!t){$("#dead").fadeIn();$("#listener").empty();return}t.name="h264";t.onClose=function(){try{if(window.tryReconnect){$("#reconnect").fadeIn()}else{$("#dead").fadeIn()}$("#listener").empty()}catch(e){console.log("eating error that occurs with jquery if window is being closed...")}console.log("closing input ");if(inputWebSocket)inputWebSocket.close();inputWebSocket=null;if(h264Socket==t)h264Socket=null};var n=new R;var o=true;var i=function(e){var i=e.subarray(8);var r=new DataView(e.buffer,e.byteOffset,8);var s=r.getUint32(0,true);var c=r.getUint32(4,true)!=0;if(y){if(t==h264Socket){if(o)y.addVideoHeader(i);else if(!v)y.addVideoFrame(i,s,c)}}if(o){v=false;o=false}n.decode(i,s,c);a()};var r=function(e){if(e.byteLength!=4){throw new Error("WTF")}var n=new DataView(e.buffer,e.byteOffset,4);var o=n.getInt32(0,true);t.read(o,i)};var a=function(){t.read(4,r)};n.onReadyForData=function(){readyForData=true;submitNextNalUnit()};var s=setTimeout(function(){showNotification("Your Android screen is unavailable right now. This can sometimes be resolved by rebooting your Android.")},5e3);function c(){t.read(4,function(t){clearTimeout(s);r(t);if(!window.chrome||!window.chrome.storage)return;k({type:"bitrate",bitrate:g[e.bitrate]})})}var u;function l(){u=throttleTimeout(u,null,1e3,function(){console.log("requesting sync frame");k({type:"sync-frame"})})}n.onDecoderFallingBehind=l;n.onReady=c}function p(){adbSocketFactory.newSocket("tcp:53517",function(e){if(!e){f();return}writeLine(e,password,function(){f(e)})})}l()};if(!window.chrome||!window.chrome.app||!window.chrome.app.window){window.device={id:"web",serialno:"web"};t=getQueryVariable("mode");if(t=="inkwire"){window.device={id:"inkwire",serialno:"inkwire"}}$(document).ready(function(){window.docReady();if(t=="inkwire"){$("title").text("Inkwire");u=0;$(".foot").hide();l=0;I()}var e=getQueryVariable("registrationId");if(!e)return;var n=getQueryVariable("senderId");if(!n)n="64148182473";var o=getQueryVariable("audio");if(t=="inkwire"){n="3505780036";o=true}var i;GcmRtcManager.start({3505780036:"AIzaSyDt0GimPRhk8_d_4XjOYzQUn50UkvXhMtE",64148182473:"AIzaSyDd7k1v017osyYbIC92fyf-36s3pv0z73U"},{iceServers:[{url:"turn:n0.clockworkmod.com",username:"foo",credential:"bar"},{url:"turn:n1.clockworkmod.com",username:"foo",credential:"bar"}]},function(t){console.log("attempting to connect to vysor from web");i=t;i.sharedDevices={};var r=getQueryVariable("channel");i.connect({senderId:n,registrationId:e,port:r},function(i){console.log("web connection established");if(o){console.log("attempting audio");t.connect({senderId:n,registrationId:e,port:r,audio:true},function(e,t){console.log("got audio");var n=new Audio;var o=t.stream.getAudioTracks()[0];n.src=(URL||webkitURL||mozURL).createObjectURL(t.stream);n.play()})}console.log(i);window.adbSocketFactory=i;console.log("starting remote vysor daemon");i.newSocket("webstart",function(e){console.log("waiting for password");readLine(e,function(t){e.destroy();console.log("got password",t);window.password=t;window.connectionReady()})})})})})}else{chrome.app.window.current().onFullscreened.addListener(function(){if(!D()){showSettings();shortModal(null,"Fullscreen Mode must be enabled in Settings.");setTimeout(function(){chrome.app.window.current().restore()},1e3);return}})}window.showSettings=function(){var t=$("#new-display-name");t.prop("value",e.friendlyName);t.prop("placeholder",device.name);$("#web-video-stream").text("http://127.0.0.1:"+httpPort+"/device/"+(device.id||device.serialno)+"/video.flv");$("#settings-modal").modal()}})();
